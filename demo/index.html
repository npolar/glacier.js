<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<link rel="stylesheet" href="css/demo.css" />
	</head>
	
	<body>
		<canvas id="canvas"></canvas>
		<div id="console"></div>
		<div id="stats"></div>
		
		<div id="lanceInfo" class="info">Lance</div>
		<div id="npolarInfo" class="info">Troms√∏</div>
		
		<script src="../dist/glacier.js"></script>
		<script src="js/konsoll.min.js"></script>
		
		<script>
			var konsoll = new Konsoll({
				container: 'console',
				toggleKey: 121,	// F10
				history: 10,
				scrollback: 500
			});
			
			konsoll.log('<strong>glacier.js</strong> v' + glacier.VERSION);
			konsoll.log('http://npolar.no/');
			konsoll.log('');
			konsoll.callback('reload', function() { window.location.reload(); });
			
			var stats = (function(elem) {
				return new function() {
					this.element = document.getElementById(elem);
					this.properties = {};
					
					if(this.element instanceof HTMLElement) {
						this.update = function() {
							while(this.element.childElementCount) {
								this.element.removeChild(this.element.lastChild);
							}
							
							if(typeof this.properties == 'object') {
								var prop, table = document.createElement('table'), row, cell;
								
								for(prop in this.properties) {
									if(this.properties.hasOwnProperty(prop)) {
										row = document.createElement('tr');
										
										cell = document.createElement('td');
										cell.innerHTML = prop;
										row.appendChild(cell);
										
										cell = document.createElement('td');
										cell.innerHTML = this.properties[prop];
										row.appendChild(cell);
										
										table.appendChild(row);
									}
								}
								
								this.element.appendChild(table);
							}
						};
					}
				};
			})('stats');
			
			var lanceInfo = (function(elem) {
				return new function() {
					this.element = document.getElementById(elem);
					
					if(this.element instanceof HTMLElement) {
						this.move = function(x, y) {
							this.element.style.left = (x - (this.element.offsetWidth / 2)) + 'px';
							this.element.style.top = (y - (this.element.offsetHeight + 10)) + 'px';
						}
					}
				};
			})('lanceInfo');
			
			var npolarInfo = (function(elem) {
				return new function() {
					this.element = document.getElementById(elem);
					
					if(this.element instanceof HTMLElement) {
						this.move = function(x, y) {
							this.element.style.left = (x - (this.element.offsetWidth / 2)) + 'px';
							this.element.style.top = (y - (this.element.offsetHeight + 10)) + 'px';
						}
					}
				};
			})('npolarInfo');
			
			var context = new glacier.Context('canvas');
			var gl, rotation = 0.0, speed = 1.0;
			var cam = new glacier.Camera(60.0, context.width / context.height, 0.1, 100000.0);
			var timestamp = Date.now(), fps = 0;
			var space = new glacier.Sphere(12, 12, 50000.0);
			
			var earth = {
				mesh: 		new glacier.Sphere(90, 90, 1.0),
				obliquity:	23.4,
				position:	new glacier.Vector3(0, 0, 0),
				rotation:	0.0,
				scale:		1.0,
				
				draw: function() {
					this.mesh.matrix = new glacier.Matrix44();
					this.mesh.matrix.translate(this.position);
					this.mesh.matrix.scale(this.scale, this.scale, this.scale);
					this.mesh.matrix.rotate(glacier.degToRad(-this.obliquity), 0, 0, 1);
					this.mesh.matrix.rotate(glacier.degToRad(this.rotation), 0, 1, 0);
					this.mesh.draw();
				},
				update: function(dtime) {
					this.rotation += 15.0 * dtime;
				}
			};
			
			var camControl = {
				angle: new glacier.Vector2(0, 0),
				dragStart: null,
				follow: earth.position,
				zoomSpeed: 0.2,
				zoom: 10.0,
			};
			
			context.canvas.addEventListener('mousedown', function(event) {
				if(event.button === 0) {
					camControl.dragStart = {
						position: new glacier.Vector2(event.clientX, event.clientY),
						angle: new glacier.Vector2(camControl.angle)
					};
				}
			});
			
			context.canvas.addEventListener('mouseup', function(event) {
				if(event.button === 0) {
					camControl.dragStart = null;
				}
			});
			
			context.canvas.addEventListener('mousemove', function(event) {
				if(camControl.dragStart) {
					var offset = new glacier.Vector2(
						 (event.clientX - camControl.dragStart.position.x) / context.width * 360.0,
						-(event.clientY - camControl.dragStart.position.y) / context.height * 180.0
					);
					
					camControl.angle = new glacier.Vector2(camControl.dragStart.angle).subtract(offset);
					camControl.angle.y = glacier.clamp(camControl.angle.y, -89, 89.0);
				}
			});
			
			document.addEventListener('keypress', function(event) {
				if(event.charCode == 43) {			// +
					speed = glacier.clamp(speed + 1, -100, 100);
				} else if(event.charCode == 45) {	// -
					speed = glacier.clamp(speed - 1, -100, 100);
				}
			});
			
			context.canvas.addEventListener('wheel', function(event) {
				camControl.zoom = glacier.clamp(camControl.zoom + (event.deltaY > 0.0 ? camControl.zoomSpeed : (event.deltaY < 0.0 ? -camControl.zoomSpeed : 0.0)), 1.2, 100.0);
			});
			
			window.addEventListener('resize', function(event) {
				cam.aspectRatio = (context.width / context.height);
			});
			
			function latLngToVec3(lat, lng, radius) {
				var theta = glacier.degToRad(lng),
					phi = glacier.degToRad(lat);
				
				return new glacier.Vector3(
					-radius * Math.cos(phi) * Math.cos(theta),
					 radius * Math.sin(phi),
					 radius * Math.cos(phi) * Math.sin(theta)
				);
			}
			
			var points = new glacier.PointCollection();
			points.addPoint(latLngToVec3(82.2, 16.5, 1.0), glacier.color.AQUA);		// Lance
			points.addPoint(latLngToVec3(69.68, 18.94, 1.0), glacier.color.RED);	// Npolar
			
			function render() {
				var vec2, dtime = (Date.now() - timestamp) / 1000.0;
				fps = ((1.0 / dtime) + fps) / 2.0;
				timestamp = Date.now();
				
				stats.properties = {
					FPS:	fps.toPrecision(3),
					Dist:	camControl.zoom.toPrecision(3),
					Speed:	Math.round(speed) + 'x'
				};
				
				stats.update();
				cam.follow(camControl.follow, camControl.angle, camControl.zoom);
				earth.update(dtime * speed);
				
				points.matrix = new glacier.Matrix44();
				points.matrix.translate(earth.position);
				points.matrix.rotate(glacier.degToRad(-earth.obliquity), 0, 0, 1);
				points.matrix.rotate(glacier.degToRad(earth.rotation), 0, 1, 0);
				
				context.clear();
				space.draw();
				earth.draw();
				points.draw();
				
				vec2 = context.worldToScreen(points.vertices[0], points.matrix);
				lanceInfo.move(vec2.x, vec2.y);
				
				vec2 = context.worldToScreen(points.vertices[1], points.matrix);
				npolarInfo.move(vec2.x, vec2.y);
				
				requestAnimationFrame(render);
			}
			
			(function init() {
				if(!(gl = (gl || context.gl))) {
					return;
				}
				
				gl.enable(gl.DEPTH_TEST);
				gl.depthFunc(gl.LEQUAL);
				
				gl.enable(gl.BLEND);
				gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
				
				space.texture0 = 'gfx/space.png';
				space.init(context, { shader: 'textured' });
				
				earth.mesh.texture0 = 'gfx/earth.jpg';
				earth.mesh.texture1 = 'gfx/earth_night.jpg';
				earth.mesh.texture2 = 'gfx/normal_bathymetry.jpg';
				earth.mesh.init(context, { shader: 'globe' });
				
				//points.init(context, { shader: 'generic' });
				
				context.background = glacier.color.GRAY;
				context.projection = cam.matrix;
				
				render();
			})();
			
			glacier.load('demo.geojson', function(data) {
				var geojson = glacier.geoJSON.parse(data);
				
				geojson.forEach(function(feature) {
					points.addPoint(latLngToVec3(
						feature.geometry.lat,
						feature.geometry.lng,
						1.0),
						glacier.color.BLUE
					);
				});
				
				points.init(context, { shader: 'generic' });
			});
		</script>
	</body>
</html>
