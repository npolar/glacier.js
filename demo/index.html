<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<link rel="stylesheet" href="css/demo.css" />
	</head>
	
	<body>
		<canvas id="canvas"></canvas>
		<div id="console"></div>
		<div id="info"></div>
		
		<script src="../dist/glacier.js"></script>
		<script src="js/konsoll.min.js"></script>
		
		<script>
			var konsoll = new Konsoll({
				container: 'console',
				toggleKey: 121,	// F10
				history: 10,
				scrollback: 500
			});
			
			konsoll.log('<strong>glacier.js</strong> v' + glacier.VERSION);
			konsoll.log('http://npolar.no/');
			konsoll.log('');
			konsoll.callback('reload', function() { window.location.reload(); });
			
			konsoll.callback('speed', function(args) {
				var num = (args.length ? Math.round(Number(args[0])) : NaN);
				
				if(!isNaN(num)) {
					konsoll.log('speed = ' + (speed = num) + 'x');
				} else {
					konsoll.log('Usage: <strong>speed &lt;integer&gt</strong>');
				}
			});
			
			var context = new glacier.Context('webgl', 'canvas');
			var gl, rotation = 0.0, speed = 1.0;
			var cam = new glacier.Camera(60.0, context.width / context.height, 0.1, 1000.0);
			var camControl = {
				angle: new glacier.Vector2(0, 0),
				dragStart: null,
				target: new glacier.Vector3(0, 0, 0),
				zoom: 10.0
			};
			
			var earth = new glacier.Sphere(90, 90, 1.0);
			var moon = new glacier.Sphere(30, 30, 0.3);
			var space = new glacier.Sphere(12, 12, 300.0);
			var timestamp = Date.now(), fps = 0;
			
			context.canvas.addEventListener('mousedown', function(event) {
				if(event.button === 0) {
					camControl.dragStart = {
						position: new glacier.Vector2(event.clientX, event.clientY),
						angle: new glacier.Vector2(camControl.angle)
					};
				}
			});
			
			context.canvas.addEventListener('mouseup', function(event) {
				if(event.button === 0) {
					camControl.dragStart = null;
				}
			});
			
			context.canvas.addEventListener('mousemove', function(event) {
				if(camControl.dragStart) {
					var offset = new glacier.Vector2(
						 (event.clientX - camControl.dragStart.position.x) / context.width * 360.0,
						-(event.clientY - camControl.dragStart.position.y) / context.height * 180.0
					);
					
					camControl.angle = new glacier.Vector2(camControl.dragStart.angle).subtract(offset);
					camControl.angle.y = glacier.clamp(camControl.angle.y, -89, 89.0);
				}
			});
			
			context.canvas.addEventListener('wheel', function(event) {
				camControl.zoom = glacier.clamp(camControl.zoom + (event.deltaY > 0.0 ? 0.1 : (event.deltaY < 0.0 ? -0.1 : 0.0)), 1.1, 20.0);
			});
			
			window.addEventListener('resize', function(event) {
				cam.aspectRatio = (context.width / context.height);
			});
			
			function init() {
				gl = (gl || context.gl);
				
				gl.enable(gl.DEPTH_TEST);
				gl.depthFunc(gl.LEQUAL);
				
				gl.enable(gl.BLEND);
				gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
				
				earth.texture = 'gfx/earth.jpg';
				earth.normalMap = 'gfx/normal_bathymetry.jpg';
				earth.init(context, { shader: 'normalMapped' });
				
				moon.texture = 'gfx/moon.jpg';
				moon.init(context, { shader: 'textured' });
				
				space.texture = 'gfx/space.png';
				space.init(context, { shader: 'textured' });
				
				context.background = glacier.color.GRAY;
				context.projection = cam.matrix;
			}
			
			var moonData = {
				dir: 0.0,
				dist: 60.3,
				scale: 1.0,
				get pos() {
					return new glacier.Vector3(
						 this.dist * Math.cos(glacier.degToRad(this.dir)),
						 this.dist * Math.sin(glacier.degToRad(5.14)) * Math.sin(glacier.degToRad(this.dir)),
						-this.dist * Math.sin(glacier.degToRad(this.dir))
					);
				}
			};
			
			function render() {
				var dtime = (Date.now() - timestamp) / 1000.0;
				fps = ((1.0 / dtime) + fps) / 2.0;
				timestamp = Date.now();
				
				document.getElementById('info').innerHTML = 'FPS: ' + fps.toPrecision(3) + '<br/>' + 'Zoom: ' + camControl.zoom.toPrecision(3) + '<br/>' + 'Speed: ' + Math.round(speed) + 'x';
				
				cam.follow(camControl.target, camControl.angle, camControl.zoom);
				
				earth.matrix = new glacier.Matrix44();
				earth.matrix.rotate(glacier.degToRad(-23.4), 0, 0, 1);	// Add earth inclination
				earth.matrix.rotate(glacier.degToRad(90.0 - rotation), 0, 1, 0);
				
				moon.matrix = new glacier.Matrix44();
				moon.matrix.translate(moonData.pos);
				moon.matrix.scale(moonData.scale, moonData.scale, moonData.scale);
				moon.matrix.rotate(glacier.degToRad(-6.6), 0, 0, 1);	// Add moon inclination
				moon.matrix.rotate(glacier.degToRad(-moonData.dir), 0, 1, 0);
				
				context.clear();
				earth.draw();
				moon.draw();
				space.draw();
				
				moonData.dir += 13.3 * dtime * speed;
				rotation += 15.0 * dtime * speed;
				
				//rotation = 180 + (new Date().getTime() * (360 / 86400000)) * speed;
				requestAnimationFrame(render);
			}
			
			init();
			render();
		</script>
	</body>
</html>
