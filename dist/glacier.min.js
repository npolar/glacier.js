var glacier={VERSION:"0.1.2",AUTHORS:["remi@npolar.no"]};"object"==typeof module&&(module.exports=glacier),glacier.load=function(e,r){var t,i="function"==typeof r?!0:!1;try{t=new XMLHttpRequest}catch(a){return!1}i&&(t.onreadystatechange=function(){4!=t.readyState||200!=t.status&&0!==t.status||r(t.responseText)});try{t.open("GET",e,i),t.overrideMimeType("text/plain"),t.send()}catch(a){return!1}return i?!0:t.responseText},glacier.isArray=function(e,r){var t,i;if([Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,Float32Array,Float64Array].forEach(function(r){!i&&e instanceof r&&(i=!0)}),i&&r)if("function"==typeof r){for(t=0;t<e.length;++t)if(!(e[t]instanceof r))return!1}else if("string"==typeof r)for(t=0;t<e.length;++t)if(typeof e[t]!=r)return!1;return!!i},glacier.extend=function(e,r,t){var i,a,n,o,s=arguments,c=[];for(i=1;i<s.length;++i)if(s[i]instanceof Object)if(o=c.push(function(){})-1){if(c[o].prototype=Object.create(c[o-1].prototype),n=s[i].prototype)for(a in n)n.hasOwnProperty(a)&&(c[o].prototype[a]=n[a]);else if(n=s[i])for(a in n)n.hasOwnProperty(a)&&(c[o].prototype[a]=n[a])}else c[o].prototype=Object.create(s[i].prototype||s[i]);n=e.prototype,e.prototype=Object.create(c.pop().prototype);for(i in n)n.hasOwnProperty(i)&&(e.prototype[i]=n[i]);return e},glacier.union=function(e,r,t){function addProperty(i){Object.defineProperty(this,e[i],{get:function(){return r},set:function(a){if("function"==typeof t){if(!(a instanceof t))throw new glacier.exception.InvalidAssignment(e[i],typeof a,t.name);r=a}else{if(typeof a!=typeof r)throw new glacier.exception.InvalidAssignment(e[i],typeof a,typeof r);r=a}}})}e=e instanceof Array?e:[e];for(var i in e)addProperty.call(this,i)},glacier.BufferObject=function BufferObject(e,r,t){if(!(e instanceof glacier.Drawable))throw new glacier.exception.InvalidParameter("drawable",typeof e,"Drawable","(constructor)","BufferObject");if(!(r instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",typeof r,"Context","(constructor)","BufferObject");if(!(t instanceof glacier.Shader))throw new glacier.exception.InvalidParameter("shader",typeof t,"Shader","(constructor)","BufferObject");var i=r.gl,a=[i.POINTS,i.LINE_STRIP,i.LINE_LOOP,i.LINES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN,i.TRIANGLES],n=0,o=0;Object.defineProperties(this,{buffers:{value:{}},context:{value:r},parent:{value:e},textures:{value:[]},elements:{get:function(){return o},set:function(e){if(!("number"==typeof e&&e>=0))throw new glacier.exception.InvalidAssignment("elements",e,"positive integer","BufferObject");o=Math.round(e)}},drawMode:{get:function(){return n},set:function(e){if(-1==a.indexOf(e)){var r=a.join(", "),t=r.lastIndexOf(", ");throw r=t>=0?r.substr(0,t)+" or"+r.substr(t+1):r,new glacier.exception.InvalidAssignment("drawMode",e,r,"BufferObject")}n=e}},shader:{get:function(){return t},set:function(e){if(e instanceof glacier.Shader)t=e;else{if("string"!=typeof e)throw new glacier.exception.InvalidAssignment("shader",typeof t,"Shader","BufferObject");var i=r.shaders.get(e);i instanceof glacier.Shader?t=i:console.warn("Undefined WebGL shader program: "+e)}}}})},glacier.BufferObject.prototype={draw:function(){if(this.context&&this.shader&&this.elements){var e,r,t,i=(Float32Array.BYTES_PER_ELEMENT,this.context.gl);this.shader.use(),this.buffers.vertex&&null!==(e=this.shader.attribute("vertex_xyz"))&&(i.bindBuffer(i.ARRAY_BUFFER,this.buffers.vertex),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,3,i.FLOAT,!1,0,0)),this.buffers.normal&&null!==(e=this.shader.attribute("normal_xyz"))&&(i.bindBuffer(i.ARRAY_BUFFER,this.buffers.normal),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,3,i.FLOAT,!1,0,0)),this.buffers.texCoord&&null!==(e=this.shader.attribute("texture_uv"))&&(i.bindBuffer(i.ARRAY_BUFFER,this.buffers.texCoord),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,2,i.FLOAT,!1,0,0)),this.buffers.color&&null!==(e=this.shader.attribute("color_rgba"))&&(i.bindBuffer(i.ARRAY_BUFFER,this.buffers.color),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,4,i.FLOAT,!1,0,0)),this.textures.forEach(function(e,t){e instanceof WebGLTexture&&(r=this.shader.uniform("tex_samp_"+t))&&(i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(r,t))},this),(r=this.shader.uniform("matrix_mvp"))&&(t=new glacier.Matrix44(this.parent.matrix),this.context.projection instanceof glacier.Matrix44&&t.multiply(this.context.projection),i.uniformMatrix4fv(r,!1,t.array)),(r=this.shader.uniform("resolution"))&&i.uniform2f(r,context.width,constext.height),this.buffers.index?(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffers.index),i.drawElements(this.drawMode,this.elements,i.UNSIGNED_SHORT,0)):this.buffers.vertex&&(i.bindBuffer(i.ARRAY_BUFFER,this.buffers.vertex),i.drawArrays(this.drawMode,0,this.elements)),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),i.bindTexture(i.TEXTURE_2D,null)}},init:function(e,r,t,i,a){if(this.context&&this.shader){var n,o=this.context.gl;if(glacier.isArray(e,glacier.Vector3))e.length&&(n=[],e.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.vertex=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(e)throw new glacier.exception.InvalidParameter("vertices",typeof e,"Vector3 array","init","BufferObject");if(glacier.isArray(r,"number"))r.length&&(n=[],r.forEach(function(e){n.push(e)}),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this.buffers.index=o.createBuffer()),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.STATIC_DRAW));else if(r)throw new glacier.exception.InvalidParameter("indices",typeof r,"number array","init","BufferObject");if(glacier.isArray(t,glacier.Vector3))t.length&&(n=[],t.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.normal=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(t)throw new glacier.exception.InvalidParameter("normals",typeof t,"Vector3 array","init","BufferObject");if(glacier.isArray(i,glacier.Vector2))i.length&&(n=[],i.forEach(function(e){n.push(e.u,e.v)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.texCoord=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(t)throw new glacier.exception.InvalidParameter("texCoords",typeof i,"Vector2 array","init","BufferObject");if(glacier.isArray(a,glacier.Color))a.length&&(n=[],a.forEach(function(e){n.push(e.r/255,e.g/255,e.b/255,e.a)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.color=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(t)throw new glacier.exception.InvalidParameter("colors",typeof a,"Color array","init","BufferObject");return o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),!0}return!1},free:function(){if(this.context){var e,r=this.context.gl;for(e in this.buffers)this.buffers.hasOwnProperty(e)&&(r.deleteBuffer(this.buffers[e]),delete this.buffers[e]);this.textures.forEach(function(e){e instanceof WebGLTexture&&r.deleteTexture(e)}),this.textures.length=0}}},glacier.Camera=function Camera(e,r,t,i){var a=["fieldOfView","aspectRatio","clipNear","clipFar"];t=t||.1,i=i||100,[e,r,t,i].forEach(function(e,r){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter(a[r],typeof e,"positive number","(constructor)","Camera");Object.defineProperty(this,a[r],{get:function(){return e},set:function(t){if(!("number"==typeof t&&t>0))throw new glacier.exception.InvalidAssignment(a[r],t,"positive number","Camera");e=t,this.update()}})},this),glacier.union.call(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.union.call(this,"position",new glacier.Vector3(0,1,1),glacier.Vector3),glacier.union.call(this,"target",new glacier.Vector3(0,0,0),glacier.Vector3),this.update()},glacier.Camera.prototype={follow:function(e,r,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("target",typeof e,"Vector3","follow","Camera");if(!(r instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("angle",typeof e,"Vector2","follow","Camera");if("number"!=typeof t||0>=t)throw new glacier.exception.InvalidParameter("distance",t,"positive number","follow","Camera");var i={},a={},n=new glacier.Vector2(glacier.limitAngle(r.x),glacier.limitAngle(r.y));i.hyp=t,i.opp=i.hyp*Math.sin(glacier.degToRad(n.y)),i.adj=i.hyp*Math.cos(glacier.degToRad(n.y)),a.hyp=i.adj,a.opp=a.hyp*Math.sin(glacier.degToRad(n.x)),a.adj=a.hyp*Math.cos(glacier.degToRad(n.x)),this.target.assign(e),this.position.x=e.x-a.opp,this.position.y=e.y+i.opp,this.position.z=e.z-a.adj,this.update()},update:function(){var e,r,t=new glacier.Vector3(0,1,0);(e=new glacier.Vector3(this.position).subtract(this.target)).length()&&e.normalize(),(r=t.crossProduct(e)).length()&&r.normalize(),(t=e.crossProduct(r)).length()&&t.normalize(),this.matrix.assign(new glacier.Matrix44),this.matrix.perspective(this.fieldOfView,this.aspectRatio,this.clipNear,this.clipFar),this.matrix.assign(new glacier.Matrix44([r.x,t.x,e.x,0,r.y,t.y,e.y,0,r.z,t.z,e.z,0,0,0,0,1]).multiply(this.matrix)).translate(-this.position.x,-this.position.y,-this.position.z)}},glacier.Color=function Color(e){var r,t,i,a=255;if(Object.defineProperties(this,{r:{get:function(){return a>>24&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("r",e,"number between 0 and 255","Color");a=((255&e)<<24)+(16777215&a)>>>0}},g:{get:function(){return a>>16&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("g",e,"number between 0 and 255","Color");a=((255&e)<<16)+(4278255615&a)>>>0}},b:{get:function(){return a>>8&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("b",e,"number between 0 and 255","Color");a=((255&e)<<8)+(4294902015&a)>>>0}},a:{get:function(){return(a>>0&255)/255},set:function(e){if(!("number"==typeof e&&e>=0&&1>=e))throw new glacier.exception.InvalidAssignment("a",e,"number between 0.0 and 1.0","Color");a=((255*e&255)<<0)+(4294967040&a)>>>0}},rgb:{get:function(){return a>>8&16777215},set:function(e){if("number"==typeof e&&e>=0&&16777215>=e)a=((16777215&e)<<8)+(255&a)>>>0;else{if(!glacier.isArray(e))throw e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,new glacier.exception.InvalidAssignment("rgb",e,"RGB as 24-bits integer or array[3] of numbers between 0.0 and 1.0","Color");for(r=0,i=[];r<e.length&&("number"==typeof e[r]&&e[r]>=0&&e[r]<=1);++r)i.push(e[r]);if(3!=i.length)throw new glacier.exception.InvalidAssignment("rgb","["+e.join(", ")+"]","array[3] of numbers between 0.0 and 1.0","Color");this.rgb=(255*i[0]<<16)+(255*i[1]<<8)+255*i[2]>>>0}}},rgba:{get:function(){return a},set:function(e){if("number"==typeof e&&e>=0&&4294967295>=e)a=(4294967295&e)>>>0;else{if(!glacier.isArray(e))throw e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,new glacier.exception.InvalidAssignment("rgba",rgb,"RGBA as 32-bits integer or array[4] of numbers between 0.0 and 1.0","Color");for(r=0,i=[];r<e.length&&("number"==typeof e[r]&&e[r]>=0&&e[r]<=1);++r)i.push(e[r]);if(4!=i.length)throw new glacier.exception.InvalidAssignment("rgba","["+e.join(", ")+"]","array[4] of numbers between 0.0 and 1.0","Color");this.rgba=(255*i[0]<<24)+(255*i[1]<<16)+(255*i[2]<<8)+255*i[3]>>>0}}}}),e instanceof glacier.Color)this.rgba=e.rgba;else if(glacier.isArray(e))this.rgba=e;else switch((t=arguments).length){case 1:this.rgb=t[0];break;case 2:this.rgb=t[0],this.a=t[1];break;case 3:case 4:for(r=0,i=[];r<t.length;++r){if("number"!=typeof t[r])throw new glacier.exception.InvalidParameter(t[r],typeof t[r],"number","(constructor)","Color");i.push(t[r]/(3>r?255:1))}for(;i.length<4;)i.push(1);this.rgba=i}},glacier.Color.prototype={assign:function(e,r,t,i){if(e instanceof glacier.Color)this.rgba=e.rgba;else{var a=["r","g","b"],n=e;if([n,r,t].forEach(function(e,r){if("number"!=typeof e||0>e||e>255)throw new glacier.exception.InvalidParameter(a[r],e,"number between 0 and 255","assign","Color")}),(i||0===i)&&("number"!=typeof i||0>i||i>1))throw new glacier.exception.InvalidParameter("a",i,"number between 0.0 and 1.0","assign","Color");this.r=n,this.g=r,this.b=t,this.a=i||0===i?i:1}return this},toArray:function(){return new Float32Array([this.r/255,this.g/255,this.b/255,this.a])},toString:function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(", ")+")"}},glacier.color={get WHITE(){return new glacier.Color(16777215,1)},get SILVER(){return new glacier.Color(12632256,1)},get GRAY(){return new glacier.Color(8421504,1)},get BLACK(){return new glacier.Color(0,1)},get RED(){return new glacier.Color(16711680,1)},get MAROON(){return new glacier.Color(8388608,1)},get YELLOW(){return new glacier.Color(16776960,1)},get OLIVE(){return new glacier.Color(8421376,1)},get LIME(){return new glacier.Color(65280,1)},get GREEN(){return new glacier.Color(32768,1)},get AQUA(){return new glacier.Color(65535,1)},get TEAL(){return new glacier.Color(32896,1)},get BLUE(){return new glacier.Color(255,1)},get NAVY(){return new glacier.Color(128,1)},get FUCHSIA(){return new glacier.Color(16711935,1)},get PURPLE(){return new glacier.Color(8388736,1)}},glacier.Context=function Context(e,r){var t,i,a,n=null;if(!(e instanceof HTMLCanvasElement)){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("canvas",typeof e,"HTMLCanvasElement or string","(constructor)","Context");if(!((a=document.getElementById(e))instanceof HTMLCanvasElement))throw new glacier.exception.InvalidParameter("canvas",e,"string as HTMLCanvasElement ID","(constructor)","Context");e=a}if(r&&"object"!=typeof r)throw new glacier.exception.InvalidParameter("options",typeof e,"object","(constructor)","Context");if(r||(r={}),!((i=e.getContext("webgl"))instanceof WebGLRenderingContext))throw new glacier.exception.ContextError("WebGL is not supported","(constructor)","Context");Object.defineProperties(this,{background:{get:function(){return t},set:function(e){if(!(e instanceof glacier.Color))throw new glacier.exception.InvalidAssignment("background",typeof e,"Color","Context");t=e,i.clearColor(e.r/255,e.g/255,e.b/255,e.a),i.clear(i.COLOR_BUFFER_BIT)}},canvas:{value:e},gl:{value:i},height:{get:function(){return this.canvas.height},set:function(e){if(!("number"==typeof e&&e>0))throw new glacier.exception.InvalidAssignment("height",e,"positive number","Context");this.resize(width,e)}},projection:{get:function(){return n},set:function(e){if(e instanceof glacier.Matrix44)n=e;else{if(null!==e)throw new glacier.exception.InvalidAssignment("projection",typeof e,"Matrix44 or null","Context");n=null}}},shaders:{value:new glacier.ShaderBank(this)},width:{get:function(){return this.canvas.width},set:function(e){if(!("number"==typeof e&&e>0))throw new glacier.exception.InvalidAssignment("width",e,"positive number","Context");this.resize(e,height)}}}),this.background=glacier.color.BLACK,this.resize(e.offsetWidth,e.offsetHeight),this.shaders.init(),window.addEventListener("resize",function(r){(e.width!=e.offsetWidth||e.height!=e.offsetHeight)&&this.resize(e.offsetWidth,e.offsetHeight)}.bind(this))},glacier.Context.prototype={clear:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},draw:function(e){e instanceof glacier.Drawable&&e.draw()},init:function(e,r){if(e instanceof glacier.Drawable)return e.init(this,r);throw new glacier.exception.InvalidParameter("drawable",typeof e,"Drawable","init","Context")},resize:function(e,r){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter("width",typeof e,"positive number","resize","Context");if("number"!=typeof r||0>=r)throw new glacier.exception.InvalidParameter("height",typeof r,"positive number","resize","Context");this.canvas.width=e,this.canvas.height=r,this.gl.viewport(0,0,e,r)},createProgram:function(e,r){if(!(e instanceof WebGLShader))throw new glacier.exception.InvalidParameter("vertShader",typeof e,"WebGLShader","createProgram","Context");if(!(r instanceof WebGLShader))throw new glacier.exception.InvalidParameter("fragShader",typeof r,"WebGLShader","createProgram","Context");var t=this.gl,i=t.createProgram();return t.attachShader(i,e),t.attachShader(i,r),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(console.warn(t.getProgramInfoLog(i)),null)},createShader:function(e,r){var t,i,a=this.gl,n=[a.FRAGMENT_SHADER,a.VERTEX_SHADER];if("string"!=typeof r)throw new glacier.exception.InvalidParameter("source",typeof r,"string","createShader","Context");if(-1==n.indexOf(e))throw t=(n=n.join(", ")).lastIndexOf(", "),n=t>=0?n.substr(0,t)+" or"+n.substr(t+1):n,new glacier.exception.InvalidParameter("type",e,n,"createShader","Context");return i=a.createShader(e),a.shaderSource(i,r),a.compileShader(i),a.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.warn(a.getShaderInfoLog(i)),null)},createTexture:function(e){if(e instanceof Image){var r=this.gl,t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST),r.generateMipmap(r.TEXTURE_2D),r.bindTexture(r.TEXTURE_2D,null),t}throw new glacier.exception.InvalidParameter("image",typeof e,"Image","createTexture","Context")},worldToScreen:function(e,r){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("point",typeof e,"Vector3","worldToScreen","Context");var t,i;if(r&&!(r instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("modelView",typeof r,"Matrix44 or null","worldToScreen","Context");return t=new glacier.Matrix44(r||null),this.projection instanceof glacier.Matrix44&&t.multiply(this.projection),i={x:t.array[0]*e.x+t.array[4]*e.y+t.array[8]*e.z+t.array[12],y:t.array[1]*e.x+t.array[5]*e.y+t.array[9]*e.z+t.array[13],z:t.array[2]*e.x+t.array[6]*e.y+t.array[10]*e.z+t.array[14],w:t.array[3]*e.x+t.array[7]*e.y+t.array[11]*e.z+t.array[15]},i.w>0?(i.x=.5*(i.x/=i.w)+.5,i.y=.5*(i.y/=i.w)+.5,i.z=.5*(i.z/=i.w)+.5,new glacier.Vector2(Math.round(i.x*context.width),Math.round((1-i.y)*context.height))):null}},glacier.Drawable=function Drawable(){glacier.union.call(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.union.call(this,"visible",!0),["x","y","z"].forEach(function(e,r){Object.defineProperty(this,e,{get:function(){return this.matrix.array[12+r]},set:function(t){if("number"!=typeof t)throw new glacier.exception.InvalidAssignment(e,typeof t,"number","Drawable");this.matrix.array[12+r]=t}})},this);var e=null;Object.defineProperty(this,"buffer",{get:function(){return e},set:function(r){if(r instanceof glacier.BufferObject)e=r;else{if(null!==r)throw new glacier.exception.InvalidAssignment("buffer",typeof buffer,"BufferObject","Drawable");e&&e.free(),e=null}}})},glacier.Drawable.prototype={free:function(){this.buffer=null,this.matrix=new glacier.Matrix44,this.visible=!0},draw:function(){this.visible&&this.buffer instanceof glacier.BufferObject&&this.buffer.draw()},init:function(e,r){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",typeof e,"Context","init","Drawable");var t=e.shaders.get("generic");if("object"==typeof r)"string"==typeof r.shader&&(t=e.shaders.get(r.shader));else if(r)throw new glacier.exception.InvalidParameter("options",typeof r,"object","init","Drawable");return(this.buffer=new glacier.BufferObject(this,e,t)).init()?!0:(this.buffer=null,!1)}},glacier.Exception=function Exception(e,r){if(this.message=e,"object"==typeof r)for(var t in r)r.hasOwnProperty(t)&&(this[t]=r[t])},glacier.exception={ContextError:function(e,r,t){glacier.Exception.call(this,"Context error",{error:e,method:r,"class":t})},IndexOutOfRange:function(e,r,t,i){glacier.Exception.call(this,"Index out of range",{index:e,range:r,method:t,"class":i})},InvalidAssignment:function(e,r,t,i){glacier.Exception.call(this,"Invalid assigment",{variable:e,value:r,expected:t,"class":i})},InvalidParameter:function(e,r,t,i,a){glacier.Exception.call(this,"Invalid parameter",{parameter:e,value:r,expected:t,method:i,"class":a})},MissingParameter:function(e,r,t){glacier.Exception.call(this,"Missing parameter",{parameter:e,method:r,"class":t})},UndefinedElement:function(e,r,t){glacier.Exception.call(this,"Undefined element",{element:e,method:r,"class":t})}},glacier.Shader=function Shader(e,r){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",typeof e,"Context","(constructor)","Shader");if(!(r instanceof WebGLProgram))throw new glacier.exception.InvalidParameter("program",typeof r,"WebGLProgram","(constructor)","Shader");Object.defineProperties(this,{attributes:{value:{}},context:{value:e},program:{value:r},uniforms:{value:{}}})},glacier.Shader.prototype={addAttributes:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("attributeArray",typeof e,"string array","addAttributes","Shader");var r;e.forEach(function(e){this.attributes.hasOwnProperty(e)||(r=this.context.gl.getAttribLocation(this.program,e))>=0&&(this.attributes[e]=r)},this)},addUniforms:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("uniformArray",typeof e,"string array","addUniforms","Shader");var r;e.forEach(function(e){this.uniforms.hasOwnProperty(e)||null!==(r=this.context.gl.getUniformLocation(this.program,e))&&(this.uniforms[e]=r)},this)},attribute:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("attribute",typeof e,"string","attribute","Shader");return"number"==typeof(e=this.attributes[e])&&e>=0?e:null},uniform:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("uniform",typeof e,"string","uniform","Shader");return(e=this.uniforms[e])instanceof WebGLUniformLocation?e:null},use:function(){return this.context&&this.program?(this.context.gl.useProgram(this.program),!0):!1}},glacier.ShaderBank=function ShaderBank(e){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",typeof e,"Context","(constructor)","ShaderBank");Object.defineProperties(this,{context:{value:e},shaders:{value:{}}})},glacier.ShaderBank.prototype={init:function(){if(this.context instanceof glacier.Context){var e,r,t,i,a,n,o,s,c,h=/attribute\s+(?:(?:high|medium|low)p\s+)?(?:float|(?:(?:vec|mat)[234]))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)\s*;/g,l=/uniform\s+(?:(?:high|medium|low)p\s+)?(?:bool|int|float|(?:(?:vec|bvec|ivec|mat)[234])|(?:sampler(?:Cube|2D)))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)(\[(?:(?:\d+)|(?:[a-zA-Z_]+[a-zA-Z0-9_]*))\])?\s*;/g,f={},u={},y=this.context.gl,g=glacier.shaders;for(e in g.vertex)if(g.vertex[e]instanceof Array){for(i=g.vertex[e].join("\n"),n={attributes:[],uniforms:[]};a=h.exec(i);)n.attributes.push(a[1]);for(;a=l.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(y.VERTEX_SHADER,i))&&(f[e]=n)}for(r in g.fragment)if(g.fragment[r]instanceof Array){for(i=g.fragment[r].join("\n"),n={uniforms:[]};a=l.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(y.FRAGMENT_SHADER,i))&&(u[r]=n)}for(t in g.programs)if(g.programs.hasOwnProperty(t)&&(e=f[g.programs[t].vertex],r=u[g.programs[t].fragment],e&&r&&(o=e.shader)&&(s=r.shader)&&(c=this.context.createProgram(o,s)))){var p=new glacier.Shader(this.context,c);p.addAttributes(e.attributes),p.addUniforms(e.uniforms),p.addUniforms(r.uniforms),this.shaders[t]=p}return!0}return!1},get:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("shader",typeof e,"string","shader","ShaderBank");return(e=this.shaders[e])instanceof glacier.Shader?e:null}},glacier.Texture=function Texture(e){var r=null;if(Object.defineProperties(this,{callbacks:{value:[]},image:{get:function(){return r},set:function(e){if(!(e instanceof Image||null===e))throw new glacier.exception.InvalidAssignment("image",typeof e,"Image or null","Texture");r=e}}}),"string"==typeof e)this.load(e);else if(e)throw new glacier.exception.InvalidParameter("source",typeof e,"Image","(constructor)","Texture")},glacier.Texture.prototype={free:function(){this.image=null},load:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("source",typeof e,"string","load","Texture");var r=this,t=new Image;t.onload=function(){return t.width&&t.height?(r.image=t,void r.callbacks.forEach(function(e){"function"==typeof e&&e(t)})):void(r.image=null)},t.src=e},onLoad:function(e){"function"==typeof e&&this.callbacks.push(e),this.image&&e(this.image)},get height(){return this.image?this.image.height:0},get width(){return this.image?this.image.width:0}},glacier.TypedArray=function TypedArray(e,r){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("type",typeof e,"string","(constructor)","TypedArray");if(r&&"function"!=typeof r)throw new glacier.exception.InvalidParameter("ctor",typeof r,"function","(constructor)","TypedArray");Object.defineProperty(this,"type",{value:{name:e,ctor:r}})},glacier.extend(glacier.TypedArray,Array,{push:function(e){var r,t=arguments;for(r=0;r<t.length;++r){if(!(this.type.ctor&&t[r]instanceof this.type.ctor||typeof t[r]==this.type.name))throw new glacier.exception.InvalidParameter("item",typeof t[r],this.type.name,"push","TypedArray");Array.prototype.push.call(this,t[r])}return this.length},splice:function(e,r,t){var i,a=arguments;for(i=2;i<a.length;++i)if(!(this.type.ctor&&a[i]instanceof this.type.ctor)||typeof a[i]!=this.type.name)throw new glacier.exception.InvalidParameter("item",typeof a[i],this.type.name,"splice","TypedArray");return Array.prototype.splice.apply(this,a)},unshift:function(e){var r,t=arguments;for(r=0;r<t.length;++r){if(!(this.type.ctor&&t[r]instanceof this.type.ctor||typeof t[r]==this.type.name))throw new glacier.exception.InvalidParameter("item",typeof t[r],this.type.name,"unshift","TypedArray");Array.prototype.unshift.call(this,t[r])}return this.length}}),function(){var e={Point:function(e,r,t){this.lat="number"==typeof e?e:0,this.lng="number"==typeof r?r:0,this.alt="number"==typeof t?t:void 0},MultiPoint:function(e){this.points=e instanceof Array?e:[]},LineString:function(e){this.points=e instanceof Array?e:[]},MultiLineString:function(e){this.lineStrings=e instanceof Array?e:[]},Polygon:function(e){this.rings=e instanceof Array?e:[]},MultiPolygon:function(e){this.polygons=e instanceof Array?e:[]},Feature:function(e,r,t){this.id=void 0!==t?t:null,this.geometry=e||null,this.properties="object"==typeof r?r:{}},parsePoint:function(r){if(r instanceof Array){var t={lng:"number"==typeof r[0]?r[0]:void 0,lat:"number"==typeof r[1]?r[1]:void 0,alt:"number"==typeof r[2]?r[2]:void 0};if(void 0!==t.lat&&void 0!==t.lng)return new e.Point(t.lat,t.lng,t.alt)}return null},parseMultiPoint:function(r){if(r instanceof Array){var t,i=[];for(t in r)(t=e.parsePoint(r[t]))&&i.push(t);if(i.length==r.length)return new e.MultiPoint(i)}return null},parseLineString:function(r){if(r instanceof Array&&r.length>=2){var t,i=[];for(t in r)(t=e.parsePoint(r[t]))&&i.push(t);if(i.length==r.length)return new e.LineString(i)}return null},parseMultiLineString:function(r){if(r instanceof Array){var t,i=[];for(t in r)(t=e.parseLineString(r[t]))&&i.push(t);if(i.length==r.length)return new e.MultiLineString(i)}return null},parsePolygon:function(r){if(r instanceof Array){var t,i,a=[];for(t in r)(t=e.parseLineString(r[t]))&&(i=t.length)>=4&&t[0].compare(t[i-1])&&a.push(t);if(a.length==r.length)return new e.Polygon(a)}return null},parseMultiPolygon:function(r){if(r instanceof Array){var t,i=[];for(t in r)(t=e.parsePolygon(r[t]))&&i.push(t);if(i.length==r.length)return new e.MultiPolygon(i)}return null},parseGeometry:function(r){if("object"==typeof r){var t="Point,MultiPoint,LineString,MultiLineString,Polygon,MultiPolygon,GeometryCollection".split(",");if(-1!=t.indexOf(r.type))return e.parseObject(r)}return null},parseGeometryCollection:function(r){if(r instanceof Array){var t,i=[];for(t in r)(t=e.parseGeometry(r[t]))&&i.push(t);if(i.length==r.length)return i}return null},parseFeature:function(r){if("object"==typeof r&&"Feature"==r.type){var t,i,a=r.id;return null===r.geometry||(t=e.parseGeometry(r.geometry))?null!==(i=r.properties)&&"object"!=typeof i?null:new e.Feature(t,i,a):null}return null},parseFeatureCollection:function(r){if(r instanceof Array){var t,i=[];for(t in r)(t=e.parseFeature(r[t]))&&i.push(t);if(i.length==r.length)return i}return null},parseObject:function(r){if("object"==typeof r){var t;switch(r.type){case"Point":if(t=e.parsePoint(r.coordinates))return t;break;case"MultiPoint":if(t=e.parseMultiPoint(r.coordinates))return t;break;case"LineString":if(t=e.parseLineString(r.coordinates))return t;break;case"MultiLineString":if(t=e.parseMultiLineString(r.coordinates))return t;break;case"Polygon":if(t=e.parsePolygon(r.coordinates))return t;break;case"MultiPolygon":if(t=e.parseMultiPolygon(r.coordinates))return t;break;case"GeometryCollection":if(t=e.parseGeometryCollection(r.geometries))return t;break;case"Feature":if(t=e.parseFeature(r))return t;break;case"FeatureCollection":if(t=e.parseFeatureCollection(r.features))return t}}return null},parse:function(r){var t;try{t=JSON.parse(r)}catch(i){return null}return e.parseObject(t)}};e.Point.prototype={compare:function(r,t){return r instanceof e.Point&&Math.abs(this.lat-r.lat)<=(t||0)&&Math.abs(this.lng-r.lng)<=(t||0)&&Math.abs(this.alt-r.alt)<=(t||0)}},glacier.geoJSON=e}(),glacier.EPSILON=1e-4,glacier.compare=function(e,r){var t,i=glacier.isArray(e),a=glacier.isArray(r);if(!i||!a){if(i||a){var n=i?e:r,o=i?r:e;for(t=0;t<n.length;++t)if("number"==typeof n[t]&&"number"==typeof o){if(Math.abs(n[t]-o)>=glacier.EPSILON)return!1}else if(n[t]!==o)return!1;return!0}return"number"==typeof e&&"number"==typeof r?Math.abs(e-r)<glacier.EPSILON:e===r}if(e.length==r.length){for(t=0;t<e.length;++t)if("number"==typeof e[t]&&"number"==typeof r[t]){if(Math.abs(e[t]-r[t])>=glacier.EPSILON)return!1}else if(e!==r)return!1;return!0}return!1},glacier.degToRad=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("degrees",typeof e,"number","degToRad");return e*Math.PI/180},glacier.radToDeg=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",typeof e,"number","radToDeg");return 180*e/Math.PI},glacier.limitAngle=function(e,r,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("angle",typeof e,"number","limitAngle");if("number"!=typeof(r=void 0===r?360:r))throw new glacier.exception.InvalidParameter("max",typeof r,"number","limitAngle");if("number"!=typeof(t=void 0===t?0:t))throw new glacier.exception.InvalidParameter("min",typeof t,"number","limitAngle");for(t>r&&(r=t+(t=r,0));e>r;)e-=r;for(;t>e;)e+=r;return e},glacier.clamp=function(e,r,t){var i=["value","min","max"];return[e,r,t].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[r],typeof e,"number","clamp")}),r>t&&(t=r+(r=t,0)),Math.max(r,Math.min(t,e))},glacier.shaders={vertex:{generic:["attribute highp vec3 vertex_xyz;","attribute highp vec3 normal_xyz;","attribute highp vec2 texture_uv;","attribute highp vec4 color_rgba;","uniform highp mat4 matrix_mvp;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","varying highp vec3 mvp_normal;","void main()","{","gl_PointSize = 2.0;","gl_Position = matrix_mvp * vec4(vertex_xyz, 1.0);","tex_coords = texture_uv; frag_color = color_rgba;","mvp_normal = normalize(matrix_mvp * vec4(normal_xyz, 1.0)).xyz;","}"]},fragment:{generic:["varying highp vec4 frag_color;","void main()","{","gl_FragColor = frag_color;","}"],globe:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","uniform sampler2D tex_samp_2;","uniform highp vec2 resolution;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","varying highp vec3 mvp_normal;","void main()","{","vec3 lightPos = normalize(vec3(-28.0, 2.0, 12.0));","vec3 normal = normalize(texture2D(tex_samp_2, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(mvp_normal, lightPos), 0.0);","vec3 dayColor = texture2D(tex_samp_0, tex_coords).rgb * diffuse;","vec3 nightColor = texture2D(tex_samp_1, tex_coords).rgb * (1.0 - diffuse);","gl_FragColor = vec4(nightColor + dayColor * max(dot(normal, lightPos), 0.3), 1.0);","}"],
normalMapped:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","void main()","{","vec3 lightPos = normalize(vec3(1.0, 1.0, 1.0));","vec4 fragColor = vec4(1.0, 1.0, 1.0, 1.0);","vec3 normal = normalize(texture2D(tex_samp_1, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(normal, lightPos), 0.0);","gl_FragColor = vec4(diffuse * texture2D(tex_samp_0, tex_coords).rgb, 1.0);","}"],textured:["precision highp float;","uniform sampler2D tex_samp_0;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","void main()","{","gl_FragColor = texture2D(tex_samp_0, tex_coords);","}"]},programs:{generic:{vertex:"generic",fragment:"generic"},globe:{vertex:"generic",fragment:"globe"},normalMapped:{vertex:"generic",fragment:"normalMapped"},textured:{vertex:"generic",fragment:"textured"}}},glacier.Mesh=function Mesh(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},indices:{value:new glacier.TypedArray("number")},normals:{value:new glacier.TypedArray("Vector3",glacier.Vector3)},texCoords:{value:new glacier.TypedArray("Vector2",glacier.Vector2)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}}),[0,1,2,3].forEach(function(e){var r=new glacier.Texture,t="texture"+e;Object.defineProperty(this,t,{get:function(){return r},set:function(e){if("string"==typeof e)r.load(e);else{if(null!==e)throw new glacier.exception.InvalidAssignment(t,typeof e,"string or null","Mesh");r.free()}}})},this)},glacier.extend(glacier.Mesh,glacier.Drawable,{free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.indices.length=0,this.normals.length=0,this.texCoords.length=0,this.vertices.length=0},init:function(e,r){var t=this;return glacier.Drawable.prototype.init.call(this,e,r)&&t.buffer.init(t.vertices,t.indices,t.normals,t.texCoords,t.colors)?(t.buffer.drawMode=e.gl.TRIANGLES,t.buffer.elements=t.indices.length?t.indices.length:t.vertices.length/3,t.texture0.onLoad(function(r){t.buffer.textures[0]=e.createTexture(r)}),t.texture1.onLoad(function(r){t.buffer.textures[1]=e.createTexture(r)}),t.texture2.onLoad(function(r){t.buffer.textures[2]=e.createTexture(r)}),t.texture3.onLoad(function(r){t.buffer.textures[3]=e.createTexture(r)}),!0):(t.buffer=null,!1)}}),glacier.PointCollection=function PointCollection(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}})},glacier.extend(glacier.PointCollection,glacier.Drawable,{addPoint:function(e,r){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",typeof e,"Vector3","addPoint","PointCollection");if(r&&!(r instanceof glacier.Color))throw new glacier.exception.InvalidParameter("color",typeof r,"Color","addPoint","PointCollection");this.colors.push(r||glacier.color.WHITE),this.vertices.push(e)},free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.vertices.length=0},init:function(e,r){var t=this;return glacier.Drawable.prototype.init.call(this,e,r)&&t.buffer.init(t.vertices,null,null,null,t.colors)?(t.buffer.drawMode=e.gl.POINTS,t.buffer.elements=t.vertices.length,!0):(t.buffer=null,!1)}}),glacier.Matrix33=function Matrix33(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,1,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix33.prototype={assign:function(e){var r,t,i;if(e instanceof glacier.Matrix33)for(i in e.array)this.array[i]=e.array[i];else if(e instanceof glacier.Matrix44)for(t=0;3>t;++t)for(r=0;3>r;++r)this.array[3*t+r]=e.array[4*t+r];else if(glacier.isArray(e)&&9==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number, Matrix33, Matrix44 or array[9]","assign","Matrix33");for(i in this.array)this.array[i]=e}return this},determinant:function(){return this.array[0]*(this.array[4]*this.array[8]-this.array[5]*this.array[7])-this.array[1]*(this.array[3]*this.array[8]-this.array[5]*this.array[6])+this.array[2]*(this.array[3]*this.array[7]-this.array[4]*this.array[6])},element:function(e,r){if("number"==typeof r&&"number"==typeof e){if(r>=0&&3>=r&&e>=0&&3>=e)return this.array[3*e+r]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(r||0),"0-9","element","Matrix33")},multiply:function(e){var r,t,i,a;if(e instanceof glacier.Matrix33)for(a=new Float32Array(this.array),r=0;3>r;++r)for(t=0;3>t;++t)this.array[3*r+t]=a[3*r+0]*e.array[0+t]+a[3*r+1]*e.array[3+t]+a[3*r+2]*e.array[6+t];else if(e instanceof glacier.Matrix44)this.multiply(new glacier.Matrix33(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number, Matrix33 or Matrix44","multiply","Matrix33");for(i in this.array)this.array[i]*=e}return this},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[3],this.array[3]=e,e=this.array[2],this.array[2]=this.array[6],this.array[6]=e,e=this.array[5],this.array[5]=this.array[7],this.array[7]=e,this},transposed:function(){var e=new glacier.Matrix33(this);return e.transpose()},inverse:function(){var e=new glacier.Matrix33(this);return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=new Float32Array([this.array[4]*this.array[8]-this.array[5]*this.array[7],this.array[2]*this.array[7]-this.array[1]*this.array[8],this.array[1]*this.array[5]-this.array[2]*this.array[4],this.array[5]*this.array[6]-this.array[3]*this.array[8],this.array[0]*this.array[8]-this.array[2]*this.array[6],this.array[2]*this.array[3]-this.array[0]*this.array[5],this.array[3]*this.array[7]-this.array[4]*this.array[6],this.array[1]*this.array[6]-this.array[0]*this.array[7],this.array[0]*this.array[4]-this.array[1]*this.array[3]]),r=this.array[0]*e[0]+this.array[1]*e[3]+this.array[2]*e[6];if(glacier.compare(r,0))return!1;r=1/r;for(var t=0;t<e.length;++t)this.array[t]=e[t]*r;return!0},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+"], ["+this.array[3].toPrecision(5)+", "+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+"], ["+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+", "+this.array[8].toPrecision(5)+"]]"}},glacier.Matrix44=function Matrix44(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix44.prototype={assign:function(e){var r,t,i;if(e instanceof glacier.Matrix33){for(t=0;3>t;++t)for(r=0;3>r;++r)this.array[4*t+r]=e.array[3*t+r];this.array[3]=this.array[7]=this.array[11]=0,this.array[12]=this.array[13]=this.array[14]=0,this.array[16]=1}else if(e instanceof glacier.Matrix44)for(i in e.array)this.array[i]=e.array[i];else if(glacier.isArray(e)&&16==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number, Matrix33, Matrix44 or array[16]","assign","Matrix44");for(i in this.array)this.array[i]=e}return this},determinant:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],r=this.array[0]*this.array[6]-this.array[2]*this.array[4],t=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],h=this.array[9]*this.array[14]-this.array[10]*this.array[13],l=this.array[9]*this.array[15]-this.array[11]*this.array[13],f=this.array[10]*this.array[15]-this.array[11]*this.array[14];return e*f-r*l+t*h+i*c-a*s+n*o},element:function(e,r){if("number"==typeof r&&"number"==typeof e){if(r>=0&&4>=r&&e>=0&&4>=e)return this.array[4*e+r]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(r||0),"0-16","element","Matrix44")},frustum:function(e,r,t,i,a,n){var o,s,c,h="left,right,bottom,top,near,far".split(",");return[e,r,t,i,a,n].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(h[r],typeof e,"number","frustum","Matrix44")}),0>=a||0>=n||(o=r-e)<=0||(s=i-t)<=0||(c=n-a)<=0?!1:(this.assign(new glacier.Matrix44([2*a/o,0,0,0,0,2*a/s,0,0,(r+e)/o,(i+t)/s,-(a+n)/c,-1,0,0,-2*a*n/c,0]).multiply(this)),!0)},inverse:function(){var e=new glacier.Matrix44(this);return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],r=this.array[0]*this.array[6]-this.array[2]*this.array[4],t=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],h=this.array[9]*this.array[14]-this.array[10]*this.array[13],l=this.array[9]*this.array[15]-this.array[11]*this.array[13],f=this.array[10]*this.array[15]-this.array[11]*this.array[14],u=e*f-r*l+t*h+i*c-a*s+n*o;if(glacier.compare(u,0))return!1;var y=new Float32Array([this.array[5]*f-this.array[6]*l+this.array[7]*h,-this.array[1]*f+this.array[2]*l-this.array[3]*h,this.array[13]*n-this.array[14]*a+this.array[15]*i,-this.array[9]*n+this.array[10]*a-this.array[11]*i,-this.array[4]*f+this.array[6]*c-this.array[7]*s,this.array[0]*f-this.array[2]*c+this.array[3]*s,-this.array[12]*n+this.array[14]*t-this.array[15]*r,this.array[8]*n-this.array[10]*t+this.array[11]*r,this.array[4]*l-this.array[5]*c+this.array[7]*o,-this.array[0]*l+this.array[1]*c-this.array[3]*o,this.array[12]*a-this.array[13]*t+this.array[15]*e,-this.array[8]*a+this.array[9]*t-this.array[11]*e,-this.array[4]*h+this.array[5]*s-this.array[6]*o,this.array[0]*h-this.array[1]*s+this.array[2]*o,-this.array[12]*i+this.array[13]*r-this.array[14]*e,this.array[8]*i-this.array[9]*r+this.array[10]*e]);u=1/u;for(var g=0;g<y.length;++g)this.array[g]=y[g]*u;return!0},multiply:function(e){var r,t,i,a;if(e instanceof glacier.Matrix44)for(a=new Float32Array(this.array),r=0;4>r;++r)for(t=0;4>t;++t)this.array[4*r+t]=a[4*r+0]*e.array[0+t]+a[4*r+1]*e.array[4+t]+a[4*r+2]*e.array[8+t]+a[4*r+3]*e.array[12+t];else if(e instanceof glacier.Matrix33)this.multiply(new glacier.Matrix44(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number, Matrix33 or Matrix44","multiply","Matrix44");for(i in this.array)this.array[i]*=e}return this},ortho:function(e,r,t,i,a,n){var o="left,right,bottom,top,near,far".split(",");return[e,r,t,i,a,n].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[r],typeof e,"number","ortho","Matrix44")}),(dX=r-e)&&(dY=i-t)&&(dZ=n-a)?(this.assign(new glacier.Matrix44([2/dX,0,0,0,0,2/dY,0,0,0,0,-2/dZ,0,-(r+e)/dX,-(i+t)/dY,-(a+n)/dZ,1]).multiply(this)),!0):!1},perspective:function(e,r,t,i){var a,n,o="verticalViewAngle,aspectRatio,near,far".split(","),s=new glacier.Matrix44;return[e,r,t,i].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[r],typeof e,"number","perspective","Matrix44")}),0>=t||0>=i?!1:(a=Math.tan(e/360*Math.PI)*t,n=a*r,s.frustum(-n,n,-a,a,t,i)?(this.assign(s.multiply(this)),!0):!1)},rotate:function(e,r,t,i){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",typeof e,"number","rotate","Matrix44");if(r instanceof glacier.Vector3)return this.rotate(e,r.x,r.y,r.z);var a,n,o,s,c=["x","y","z"],h=r;return[h,t,i].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(c[r],typeof e,"number","rotate","Matrix44")}),s=1-(a=Math.cos(e)),n=Math.sin(e),isNaN(o=Math.sqrt(h*h+t*t+i*i))||(h/=o,t/=o,i/=o,this.assign(new glacier.Matrix44([s*h*h+a,s*h*t-i*n,s*h*i+t*n,0,s*t*h+i*n,s*t*t+a,s*t*i-h*n,0,s*i*h-t*n,s*i*t+h*n,s*i*i+a,0,0,0,0,1]).multiply(this))),this},scale:function(e,r,t){if(e instanceof glacier.Vector3)return this.scale(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,r,t].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[r],typeof e,"number","scale","Matrix44")}),this.array[0]*=a,this.array[4]*=r,this.array[8]*=t,this.array[1]*=a,this.array[5]*=r,this.array[9]*=t,this.array[2]*=a,this.array[6]*=r,this.array[10]*=t,this.array[3]*=a,this.array[7]*=r,this.array[11]*=t,this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+", "+this.array[3].toPrecision(5)+"], ["+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+", "+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+"], ["+this.array[8].toPrecision(5)+", "+this.array[9].toPrecision(5)+", "+this.array[10].toPrecision(5)+", "+this.array[11].toPrecision(5)+"], ["+this.array[12].toPrecision(5)+", "+this.array[13].toPrecision(5)+", "+this.array[14].toPrecision(5)+", "+this.array[15].toPrecision(5)+"]]"},translate:function(e,r,t){if(e instanceof glacier.Vector3)return this.translate(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,r,t].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[r],typeof e,"number","translate","Matrix44")}),this.array[12]+=this.array[0]*a+this.array[4]*r+this.array[8]*t,this.array[13]+=this.array[1]*a+this.array[5]*r+this.array[9]*t,this.array[14]+=this.array[2]*a+this.array[6]*r+this.array[10]*t,this.array[15]+=this.array[3]*a+this.array[7]*r+this.array[11]*t,this},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[4],this.array[4]=e,e=this.array[2],this.array[2]=this.array[8],this.array[8]=e,e=this.array[3],this.array[3]=this.array[12],this.array[12]=e,e=this.array[6],this.array[6]=this.array[9],this.array[9]=e,e=this.array[7],this.array[7]=this.array[13],this.array[13]=e,e=this.array[11],this.array[11]=this.array[14],this.array[14]=e,this},transposed:function(){var e=new glacier.Matrix44(this);return e.transpose()}},glacier.Vector2=function Vector2(e,r){glacier.union.call(this,["x","u"],"number"==typeof e?e:0),glacier.union.call(this,["y","v"],"number"==typeof r?r:0),e instanceof glacier.Vector2&&this.assign(e)},glacier.Vector2.prototype={add:function(e){if(e instanceof glacier.Vector2)this.x+=e.x,this.y+=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector2","add","Vector2");this.x+=e,this.y+=e}return this},assign:function(e,r){if(e instanceof glacier.Vector2)return this.assign(e.x,e.y);var t=["x","y"],i=e;return[i,r].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(t[r],typeof e,"number","assign","Vector2")}),this.x=i,this.y=r,this},distance:function(e){var r=this.x-e.x,t=this.y-e.y;return Math.sqrt(r*r+t*t)},divide:function(e){if(e instanceof glacier.Vector2)this.x/=e.x,this.y/=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector2","divide","Vector2");this.x/=e,this.y/=e}return this},dotProduct:function(e){return this.x*e.x+this.y*e.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},multiply:function(e){if(e instanceof glacier.Vector2)this.x*=e.x,this.y*=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector2","multiply","Vector2");this.x*=e,this.y*=e}return this},normalize:function(){var e=1/this.length();return this.x*=e,this.y*=e,this},rotate:function(e){var r=Math.cos(e),t=Math.sin(e),i=this.x*r-this.y*t,a=this.x*t+this.y*r;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector2)this.x-=e.x,this.y-=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector2","subtract","Vector2");this.x-=e,this.y-=e}return this},toString:function(){return"("+this.x+", "+this.y+")"},get array(){return new Float32Array([this.x,this.y])}},glacier.Vector3=function Vector3(e,r,t){glacier.union.call(this,["x","u"],"number"==typeof e?e:0),glacier.union.call(this,["y","v"],"number"==typeof r?r:0),glacier.union.call(this,["z","w"],"number"==typeof t?t:0),e instanceof glacier.Vector3&&this.assign(e)},glacier.Vector3.prototype={add:function(e){if(e instanceof glacier.Vector3)this.x+=e.x,this.y+=e.y,this.z+=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector3","add","Vector3");this.x+=e,this.y+=e,this.z+=e}return this},angle:function(e){var r=Math.acos(this.dotProduct(e)/(this.length()*e.length()));return isNaN(r)?0:r},assign:function(e,r,t){if(e instanceof glacier.Vector3)return this.assign(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,r,t].forEach(function(e,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[r],typeof e,"number","assign","Vector3")}),this.x=a,this.y=r,this.z=t,this},crossProduct:function(e){return new glacier.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},distance:function(e){var r=this.x-e.x,t=this.y-e.y,i=this.z-e.z;return Math.sqrt(r*r+t*t+i*i)},divide:function(e){if(e instanceof glacier.Vector3)this.x/=e.x,this.y/=e.y,this.z/=e.z;else if("number"==typeof e)this.x/=e,this.y/=e,this.z/=e;else if(e instanceof glacier.Matrix33)this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2);else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",typeof e,"number, Vector3, Matrix33 or Matrix44","divide","Vector3");this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2)+e.element(0,3),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2)+e.element(1,3),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2)+e.element(2,3)}return this},dotProduct:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},multiply:function(e){if(e instanceof glacier.Vector3)this.x*=e.x,this.y*=e.y,this.z*=e.z;else if("number"==typeof e)this.x*=e,this.y*=e,this.z*=e;else if(e instanceof glacier.Matrix33)this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2);else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",typeof e,"number, Vector3, Matrix33 or Matrix44","multiply","Vector3");this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2)+e.element(0,3),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2)+e.element(1,3),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2)+e.element(2,3)}return this},normalize:function(){var e=1/this.length();return this.x*=e,this.y*=e,this.z*=e,this},rotateX:function(e){var r=Math.cos(e),t=Math.sin(e),i=this.y*r-this.z*t,a=this.y*t+this.z*r;return this.y=i,this.z=a,this},rotateY:function(e){var r=Math.cos(e),t=Math.sin(e),i=this.x*r-this.z*t,a=this.x*t+this.z*r;return this.x=i,this.z=a,this},rotateZ:function(e){var r=Math.cos(e),t=Math.sin(e),i=this.x*r-this.y*t,a=this.x*t+this.y*r;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector3)this.x-=e.x,this.y-=e.y,this.z-=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",typeof e,"number or Vector3","subtract","Vector3");this.x-=e,this.y-=e,this.z-=e}return this},toString:function(){return"("+this.x+", "+this.y+", "+this.z+")"},get array(){return new Float32Array([this.x,this.y,this.z])}},glacier.Sphere=function Sphere(e,r,t){glacier.Mesh.call(this),t="number"==typeof t&&t>=0?t:0,Object.defineProperty(this,"radius",{get:function(){return t},set:function(e){if(!("number"==typeof e&&e>=0))throw new glacier.exception.InvalidAssignment("radius",e,"positive number","Sphere");e>0?this.vertices.forEach(function(r){r=r/t*e}):this.indices.length&&this.free(),t=e}}),e&&r&&this.generate(e,r,t||1)},glacier.extend(glacier.Sphere,glacier.Mesh,{free:function(){glacier.Mesh.prototype.free.call(this),this.radius=0},generate:function(e,r,t){if("number"!=typeof e||3>e)throw new glacier.exception.InvalidParameter("latitudes",e,"number (>= 3)","generate","Sphere");if(e=Math.round(Math.abs(e)),"number"!=typeof r||3>r)throw new glacier.exception.InvalidParameter("longitudes",r,"number (>= 3)","generate","Sphere");if(r=Math.round(Math.abs(r)),void 0===t)t=1;else if("number"!=typeof t||0>=t)throw new glacier.exception.InvalidParameter("radius",t,"number (> 0.0)","generate","Sphere");this.free(),this.radius=t;var i,a,n,o,s,c,h,l,f,u,y,g,p;for(i=0;e>=i;++i)for(n=i*Math.PI/e,o=Math.sin(n),s=Math.cos(n),a=0;r>=a;++a)c=2*a*Math.PI/r,h=Math.sin(c),l=Math.cos(c),f=l*o,u=s,y=h*o,g=1-a/r,p=i/e,this.vertices.push(new glacier.Vector3(t*f,t*u,t*y)),this.normals.push(new glacier.Vector3(f,u,y)),this.texCoords.push(new glacier.Vector2(g,p));for(i=0;e>i;++i)for(a=0;r>a;++a)f=i*(r+1)+a,u=f+r+1,this.indices.push(f,u,f+1),this.indices.push(u,u+1,f+1);return!0}});