var glacier={};!function(e){var r;Object.defineProperties(e,{VERSION:{value:"0.0.8"},language:{get:function(){return r},set:function(t){if(e.i18n[t])r=t;else{var a=e.i18n.alias[t]?e.i18n.alias[t][0]:null;r=e.i18n[a]?a:"en",e.warn("UNDEFINED_LANGUAGE",{language:t,fallback:r})}}}}),e.load=function(e,r){var t,a="function"==typeof r?!0:!1;try{t=new XMLHttpRequest}catch(i){return!1}a&&(t.onreadystatechange=function(){4!=t.readyState||200!=t.status&&0!==t.status||r(t.responseText)});try{t.open("GET",e,a),t.overrideMimeType("text/plain"),t.send()}catch(i){return!1}return a?!0:t.responseText},e.log=function(r,t,a){var i,n=e.i18n(r);if(n||("warning"==t?(n=e.i18n("UNDEFINED_WARNING"),a={warning:r}):"error"==t&&(n=e.i18n("UNDEFINED_ERROR"),a={error:r})),"object"==typeof a&&(i=n.match(/\{[^\}]*\}/g)))for(var o in i){var s=i[o].substr(1,i[o].length-2);a.hasOwnProperty(s)&&(n=n.replace(i[o],a[s]))}switch(t){case"error":console.error(n);break;case"warning":console.warn(n);break;default:console.log(r)}},e.error=function(r,t){e.log(r,"error",t)},e.warn=function(r,t){e.log(r,"warning",t)},e.isArray=function(e,r){var t,a;if([Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,Float32Array,Float64Array].forEach(function(r){!a&&e instanceof r&&(a=!0)}),a&&r)if("function"==typeof r){for(t=0;t<e.length;++t)if(!(e[t]instanceof r))return!1}else if("string"==typeof r)for(t=0;t<e.length;++t)if(typeof e[t]!=r)return!1;return!!a},e.extend=function(e,r,t){var a,i,n,o,s=arguments,c=[];for(a=1;a<s.length;++a)if(s[a]instanceof Object)if(o=c.push(function(){})-1){if(c[o].prototype=Object.create(c[o-1].prototype),n=s[a].prototype)for(i in n)n.hasOwnProperty(i)&&(c[o].prototype[i]=n[i]);else if(n=s[a])for(i in n)n.hasOwnProperty(i)&&(c[o].prototype[i]=n[i])}else c[o].prototype=Object.create(s[a].prototype||s[a]);n=e.prototype,e.prototype=Object.create(c.pop().prototype);for(a in n)n.hasOwnProperty(a)&&(e.prototype[a]=n[a]);return e},e.union=function(r,t,a){function addProperty(i){Object.defineProperty(this,r[i],{get:function(){return t},set:function(n){"function"==typeof a?n instanceof a?t=n:e.error("INVALID_ASSIGNMENT",{variable:r[i],value:typeof n,expected:a.name}):typeof n==typeof t?t=n:e.error("INVALID_ASSIGNMENT",{variable:r[i],value:typeof n,expected:typeof t})}})}r=r instanceof Array?r:[r];for(var i in r)addProperty.call(this,i)},"object"==typeof module&&(module.exports=e)}(glacier),glacier.Camera=function Camera(e,r){var t,a=["verticalViewAngle","aspectRatio"];Object.defineProperties(this,{aspectRatio:{get:function(){return r},set:function(e){"number"==typeof e&&e>0?(r=e,update()):glacier.error("INVALID_ASSIGNMENT",{variable:"Camera.aspectRatio",value:e,expected:"positive number"})}},fieldOfView:{get:function(){return e},set:function(r){"number"==typeof r&&r>0?(e=r,update()):glacier.error("INVALID_ASSIGNMENT",{variable:"camera.fieldOfView",value:r,expected:"positive number"})}},matrix:{value:new glacier.Matrix44,writable:!1},position:{value:new glacier.Vector3(0,1,1),writable:!1},target:{value:new glacier.Vector3(0,0,0),writable:!1}}),[e,r].forEach(function(e,r){("number"!=typeof e||0>=e)&&(glacier.error("INVALID_PARAMETER",{parameter:a[r],value:typeof e,expected:"positive number",method:"Camera constructor"}),t=!0)}),t&&(e="number"==typeof e&&e>0?e:60,r="number"==typeof r&&r>0?r:16/9),this.update()},glacier.Camera.prototype={follow:function(e,r,t){if(!(e instanceof glacier.Vector3))return void glacier.error("INVALID_PARAMETER",{parameter:"target",value:typeof e,expected:"Vector3",method:"Camera.follow"});if(!(r instanceof glacier.Vector2))return void glacier.error("INVALID_PARAMETER",{parameter:"angle",value:typeof r,expected:"Vector2",method:"Camera.follow"});if("number"!=typeof t||0>=t)return void glacier.error("INVALID_PARAMETER",{parameter:"distance",value:typeof t,expected:"positive number",method:"Camera.follow"});var a={},i={},n=new glacier.Vector2(glacier.limitAngle(r.x),glacier.limitAngle(r.y));a.hyp=t,a.opp=a.hyp*Math.sin(glacier.degToRad(n.y)),a.adj=a.hyp*Math.cos(glacier.degToRad(n.y)),i.hyp=a.adj,i.opp=i.hyp*Math.sin(glacier.degToRad(n.x)),i.adj=i.hyp*Math.cos(glacier.degToRad(n.x)),this.target=e,this.position.x=e.x-i.opp,this.position.y=e.y+a.opp,this.position.z=e.z-i.adj,this.update()},update:function(){var e,r,t=new glacier.Vector3(0,1,0);(e=new glacier.Vector3(this.position).subtract(this.target)).length()&&e.normalize(),(r=t.crossProduct(e)).length()&&r.normalize(),(t=e.crossProduct(r)).length()&&t.normalize(),this.matrix.assign(new glacier.Matrix44),this.matrix.perspective(this.fieldOfView,this.aspectRatio,.1,100),this.matrix.assign(new glacier.Matrix44([r.x,t.x,e.x,0,r.y,t.y,e.y,0,r.z,t.z,e.z,0,0,0,0,1]).multiply(this.matrix)).translate(-this.position.x,-this.position.y,-this.position.z)}},glacier.Color=function Color(e){var r,t,a,i=255;if(Object.defineProperties(this,{r:{get:function(){return i>>24&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?i=((255&e)<<24)+(16777215&i)>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.r",value:e,expected:"number between 0 and 255"})}},g:{get:function(){return i>>16&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?i=((255&e)<<16)+(4278255615&i)>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.g",value:e,expected:"number between 0 and 255"})}},b:{get:function(){return i>>8&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?i=((255&e)<<8)+(4294902015&i)>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.b",value:e,expected:"number between 0 and 255"})}},a:{get:function(){return(i>>0&255)/255},set:function(e){"number"==typeof e&&e>=0&&1>=e?i=((255*e&255)<<0)+(4294967040&i)>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.a",value:e,expected:"number between 0.0 and 1.0"})}},rgb:{get:function(){return i>>8&16777215},set:function(e){if("number"==typeof e&&e>=0&&16777215>=e)i=((16777215&e)<<8)+(255&i)>>>0;else if(glacier.isArray(e)){for(r=0,a=[];r<e.length&&("number"==typeof e[r]&&e[r]>=0&&e[r]<=1);++r)a.push(e[r]);3==a.length?this.rgb=(255*a[0]<<16)+(255*a[1]<<8)+255*a[2]>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.rgb",value:"["+e.join(", ")+"]",expected:"array[3] of numbers between 0.0 and 1.0"})}else e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,glacier.error("INVALID_ASSIGNMENT",{variable:"Color.rgb",value:e,expected:"RGB as 24-bits integer or array[3] of numbers between 0.0 and 1.0"})}},rgba:{get:function(){return i},set:function(e){if("number"==typeof e&&e>=0&&4294967295>=e)i=(4294967295&e)>>>0;else if(glacier.isArray(e)){for(r=0,a=[];r<e.length&&("number"==typeof e[r]&&e[r]>=0&&e[r]<=1);++r)a.push(e[r]);4==a.length?this.rgba=(255*a[0]<<24)+(255*a[1]<<16)+(255*a[2]<<8)+255*a[3]>>>0:glacier.error("INVALID_ASSIGNMENT",{variable:"Color.rgba",value:"["+e.join(", ")+"]",expected:"array[4] of numbers between 0.0 and 1.0"})}else e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,glacier.error("INVALID_ASSIGNMENT",{variable:"Color.rgba",value:e,expected:"RGBA as 32-bits integer or array[4] of numbers between 0.0 and 1.0"})}}}),e instanceof glacier.Color)this.rgba=e.rgba;else if(glacier.isArray(e))this.rgba=e;else switch((t=arguments).length){case 1:this.rgb=t[0];break;case 2:this.rgb=t[0],this.a=t[1];break;case 3:case 4:for(r=0,a=[];r<t.length;++r){if("number"!=typeof t[r])return void glacier.error("INVALID_PARAMETER",{parameter:t[r],expected:"number",method:"Color constructor"});a.push(t[r]/(3>r?255:1))}for(;a.length<4;)a.push(1);this.rgba=a}},glacier.Color.prototype={assign:function(e,r,t,a){if(e instanceof glacier.Color)this.rgba=e.rgba;else{var i,n=["r","g","b"],o=e;[o,r,t].forEach(function(e,r){("number"!=typeof e||0>e||e>255)&&(glacier.error("INVALID_PARAMETER",{parameter:n[r],value:e,expected:"number between 0 and 255",method:"Color.assign"}),i=!0)}),(a||0===a)&&("number"!=typeof a||0>a||a>1)&&(glacier.error("INVALID_PARAMETER",{parameter:"a",value:a,expected:"number between 0.0 and 1.0",method:"Color.assign"}),i=!0),i||(this.r=o,this.g=r,this.b=t,this.a=a||0===a?a:1)}return this},toArray:function(){return new Float32Array([this.r/255,this.g/255,this.b/255,this.a])},toString:function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(", ")+")"}},glacier.color={},Object.defineProperties(glacier.color,{WHITE:{get:function(){return new glacier.Color(16777215,1)}},SILVER:{get:function(){return new glacier.Color(12632256,1)}},GRAY:{get:function(){return new glacier.Color(8421504,1)}},BLACK:{get:function(){return new glacier.Color(0,1)}},RED:{get:function(){return new glacier.Color(16711680,1)}},MAROON:{get:function(){return new glacier.Color(8388608,1)}},YELLOW:{get:function(){return new glacier.Color(16776960,1)}},OLIVE:{get:function(){return new glacier.Color(8421376,1)}},LIME:{get:function(){return new glacier.Color(65280,1)}},GREEN:{get:function(){return new glacier.Color(32768,1)}},AQUA:{get:function(){return new glacier.Color(65535,1)}},TEAL:{get:function(){return new glacier.Color(32896,1)}},BLUE:{get:function(){return new glacier.Color(255,1)}},NAVY:{get:function(){return new glacier.Color(128,1)}},FUCHSIA:{get:function(){return new glacier.Color(16711935,1)}},PURPLE:{get:function(){return new glacier.Color(8388736,1)}}}),glacier.context={},glacier.Context=function Context(e,r){var t,a=[];if("string"==typeof e)for(t in glacier.context)if(glacier.context.hasOwnProperty(t)){if(t.toLowerCase()==e.toLowerCase())return"string"==typeof r&&(r={container:r}),ctor=new glacier.context[t](r),Object.defineProperty(ctor,"type",{value:t,writable:!1}),ctor;a.push(t)}a=a.join(", ");var i=a.lastIndexOf(", ");return a=i>=0?a.substr(0,i)+" or"+a.substr(i+1):a,glacier.error("INVALID_PARAMETER",{parameter:"type",value:e,expected:a,method:"Context constructor"}),null},glacier.Context.prototype={clear:function(){glacier.warn("MISSING_IMPLEMENTATION",{implementation:"clear",child:this.type,parent:"Context"})},draw:function(e){glacier.warn("MISSING_IMPLEMENTATION",{implementation:"draw",child:this.type,parent:"Context"})},init:function(e,r){glacier.warn("MISSING_IMPLEMENTATION",{implementation:"init",child:this.type,parent:"Context"})},resize:function(e,r){glacier.warn("MISSING_IMPLEMENTATION",{implementation:"resize",child:this.type,parent:"Context"})}},glacier.Drawable=function Drawable(){glacier.union.call(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.union.call(this,"visible",!0),["x","y","z"].forEach(function(e,r){Object.defineProperty(this,e,{get:function(){return this.matrix.array[12+r]},set:function(t){"number"==typeof t?this.matrix.array[12+r]=t:glacier.error("INVALID_ASSIGNMENT",{variable:"Drawable."+e,value:typeof t,expected:"number"})}})},this)},glacier.Drawable.prototype={context:null,contextData:null,free:function(){this.context=null,this.contextData=null,this.matrix=new glacier.Matrix44,this.visible=!0},draw:function(){context instanceof glacier.Context&&context.draw(this)},init:function(e,r){if(e instanceof glacier.Context){if(r&&"object"!=typeof r)return glacier.error("INVALID_PARAMETER",{parameter:"options",value:typeof r,expected:"object",method:"Drawable.init"}),!1;if(e.init(this,r))return this.context=e,!0}else glacier.error("INVALID_PARAMETER",{parameter:"context",value:typeof e,expected:"Context",method:"Drawable.init"});return!1}},glacier.Mesh=function Mesh(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},indices:{value:new glacier.TypedArray("number")},normals:{value:new glacier.TypedArray("Vector3",glacier.Vector3)},texCoords:{value:new glacier.TypedArray("Vector2",glacier.Vector2)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}}),["texture","normalMap"].forEach(function(e){var r=new glacier.Texture;Object.defineProperty(this,e,{get:function(){return r},set:function(t){"string"==typeof t?r.load(t):null===t?r.free():glacier.error("INVALID_ASSIGNMENT",{variable:"Mesh."+e,value:typeof t,expected:"string or null"})}})},this)},glacier.extend(glacier.Mesh,glacier.Drawable,{free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.indices.length=0,this.normals.length=0,this.texCoords.length=0,this.vertices.length=0}}),glacier.Texture=function Texture(e){var r=null;Object.defineProperties(this,{callbacks:{value:[]},image:{get:function(){return r},set:function(e){e instanceof Image||null===e?r=e:glacier.error("INVALID_ASSIGNMENT",{variable:"Texture.image",value:typeof e,expected:"Image or null"})}}}),"string"==typeof e?this.load(e):e&&glacier.error("INVALID_PARAMETER",{parameter:"source",value:typeof e,expected:"Image",method:"Texture constructor"})},glacier.Texture.prototype={free:function(){this.image=null},load:function(e){if("string"!=typeof e)return void glacier.error("INVALID_PARAMETER",{parameter:"source",value:typeof e,expected:"string",method:"Texture.load"});var r=this,t=new Image;t.onload=function(){return t.width&&t.height?(r.image=t,void r.callbacks.forEach(function(e){"function"==typeof e&&e(t)})):void(r.image=null)},t.src=e},onLoad:function(e){"function"==typeof e&&this.callbacks.push(e),this.image&&e(this.image)},get height(){return this.image?this.image.height:0},get width(){return this.image?this.image.width:0}},glacier.TypedArray=function TypedArray(e,r){"string"==typeof e?(r&&"function"!=typeof r&&(glacier.error("INVALID_PARAMETER",{parameter:"ctor",value:typeof r,expected:"function",method:"TypedArray constructor"}),r=void 0),Object.defineProperty(this,"type",{value:{name:e,ctor:r}})):glacier.error("INVALID_PARAMETER",{parameter:"type",value:typeof e,expected:"string",method:"TypedArray constructor"})},glacier.extend(glacier.TypedArray,Array,{push:function(e){var r,t=arguments;for(r=0;r<t.length;++r)this.type.ctor&&t[r]instanceof this.type.ctor||typeof t[r]==this.type.name?Array.prototype.push.call(this,t[r]):glacier.error("INVALID_PARAMETER",{parameter:"item",value:typeof t[r],expected:this.type.name,method:"TypedArray.push"});return this.length},splice:function(e,r,t){var a,i,n=arguments;for(a=2;a<n.length;++a)this.type.ctor&&n[a]instanceof this.type.ctor&&typeof n[a]==this.type.name||(glacier.error("INVALID_PARAMETER",{parameter:"item",value:typeof n[a],expected:this.type.name,method:"TypedArray.splice"}),i=!0);return i?[]:Array.prototype.splice.apply(this,n)},unshift:function(e){var r,t=arguments;for(r=0;r<t.length;++r)this.type.ctor&&t[r]instanceof this.type.ctor||typeof t[r]==this.type.name?Array.prototype.unshift.call(this,t[r]):glacier.error("INVALID_PARAMETER",{parameter:"item",value:typeof t[r],expected:this.type.name,method:"TypedArray.unshift"});return this.length}}),glacier.i18n=function(e,r){if(r=r||glacier.language,glacier.i18n[r]&&glacier.i18n[r][e])return glacier.i18n[r][e];if(glacier.i18n.alias[r])for(var t in glacier.i18n.alias[r]){var a=glacier.i18n.alias[r][t];if(glacier.i18n[a]&&glacier.i18n[a][e])return glacier.i18n[a][e]}return glacier.i18n.en[e]||null},glacier.i18n.alias={no:["nb","nn"],nb:["nn"],nn:["nb"]},glacier.EPSILON=1e-4,glacier.compare=function(e,r){var t,a=glacier.isArray(e),i=glacier.isArray(r);if(!a||!i){if(a||i){var n=a?e:r,o=a?r:e;for(t=0;t<n.length;++t)if("number"==typeof n[t]&&"number"==typeof o){if(Math.abs(n[t]-o)>=glacier.EPSILON)return!1}else if(n[t]!==o)return!1;return!0}return"number"==typeof e&&"number"==typeof r?Math.abs(e-r)<glacier.EPSILON:e===r}if(e.length==r.length){for(t=0;t<e.length;++t)if("number"==typeof e[t]&&"number"==typeof r[t]){if(Math.abs(e[t]-r[t])>=glacier.EPSILON)return!1}else if(e!==r)return!1;return!0}return!1},glacier.degToRad=function(e){return"number"==typeof e?e*Math.PI/180:(glacier.error("INVALID_PARAMETER",{parameter:"degrees",value:typeof e,expected:"number",method:"degToRad"}),e)},glacier.radToDeg=function(e){return"number"==typeof e?180*e/Math.PI:(glacier.error("INVALID_PARAMETER",{parameter:"radians",value:typeof e,expected:"number",method:"radToDeg"}),e)},glacier.limitAngle=function(e,r,t){if("number"!=typeof e)return glacier.error("INVALID_PARAMETER",{parameter:"angle",value:typeof e,expected:"number",method:"limitAngle"}),null;if("number"!=typeof(r=void 0===r?360:r))return glacier.error("INVALID_PARAMETER",{parameter:"max",value:typeof r,expected:"number",method:"limitAngle"}),null;if("number"!=typeof(t=void 0===t?0:t))return glacier.error("INVALID_PARAMETER",{parameter:"min",value:typeof t,expected:"number",method:"limitAngle"}),null;for(t>r&&(r=t+(t=r,0));e>r;)e-=r;for(;t>e;)e+=r;return e},glacier.clamp=function(e,r,t){var a,i=["value","min","max"];return[e,r,t].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:i[r],value:typeof e,expected:"number",method:"clamp"}),a=!0)}),a?null:(r>t&&(t=r+(r=t,0)),Math.max(r,Math.min(t,e)))},glacier.context.WebGL=function WebGLContext(e){e="object"==typeof e?e:{};var r,t,a,i;e.container instanceof HTMLElement?a=e.container:"string"==typeof e.container?(a=document.getElementById(e.container))||glacier.error("UNDEFINED_ELEMENT",{element:e.container,method:"context.WebGL constructor"}):glacier.error("MISSING_PARAMETER",{parameter:"container",method:"context.WebGL constructor"}),a instanceof HTMLCanvasElement?t=a:a instanceof HTMLElement&&(t=document.createElement("CANVAS"),t.style.position="relative;",t.style.width="100%",t.style.height="100%",a.appendChild(t)),t instanceof HTMLCanvasElement&&(Object.defineProperties(this,{canvas:{value:t},width:{get:function(){return this.canvas.width},set:function(e){"number"==typeof e&&e>0?this.resize(e,height):glacier.error("INVALID_ASSIGNMENT",{variable:"Context.width",value:e,expected:"positive number"})}},height:{get:function(){return this.canvas.height},set:function(e){"number"==typeof e&&e>0?this.resize(width,e):glacier.error("INVALID_ASSIGNMENT",{variable:"Context.height",value:e,expected:"positive number"})}}}),this.canvas.width=t.offsetWidth,this.canvas.height=t.offsetHeight,window.addEventListener("resize",function(e){(t.width!=t.offsetWidth||t.height!=t.offsetHeight)&&this.resize(t.offsetWidth,t.offsetHeight)}.bind(this)),(i=this.canvas.getContext("webgl"))&&Object.defineProperty(this,"gl",{value:i}),this.gl&&(Object.defineProperties(this,{background:{get:function(){return r},set:function(e){e instanceof glacier.Color?(r=e,this.gl.clearColor(e.r/255,e.g/255,e.b/255,e.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT)):glacier.error("INVALID_ASSIGNMENT",{variable:"Context.background",value:typeof e,expected:"Color"})}},shaderBank:{value:new glacier.context.WebGL.ShaderBank(this)}}),this.background=glacier.color.BLACK,this.shaderBank.init()),this.clear())},glacier.extend(glacier.context.WebGL,glacier.Context,{clear:function(){this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},draw:function(e){e instanceof glacier.Drawable&&e.contextData instanceof glacier.context.WebGL.Drawable&&e.contextData.draw()},init:function(e,r){if(e instanceof glacier.Mesh){var t,a,i=this;return"object"==typeof r&&"string"==typeof r.shader&&(t=this.shaderBank.shader(r.shader)),a=new glacier.context.WebGL.Drawable(this,this.gl.TRIANGLES,t),a.init(e.vertices,e.indices,e.normals,e.texCoords,e.colors)?(e.texture.onLoad(function(e){a.textures.base=i.createTexture(e)}),e.normalMap.onLoad(function(e){a.textures.normal=i.createTexture(e)}),e.contextData=a,!0):!1}return glacier.error("INVALID_PARAMETER",{parameter:"drawable",value:typeof e,expected:"Mesh",method:"context.WebGL.init"}),!1},resize:function(e,r){return"number"!=typeof e||0>=e?void glacier.error("INVALID_PARAMETER",{parameter:"width",value:typeof e,expected:"positive number",method:"Context.resize"}):"number"!=typeof r||0>=r?void glacier.error("INVALID_PARAMETER",{parameter:"height",value:typeof r,expected:"positive number",method:"Context.resize"}):(this.canvas&&(this.canvas.width=e,this.canvas.height=r),void(this.gl&&this.gl.viewport(0,0,e,r)))},createProgram:function(e,r){if(!this.gl)return glacier.error("CONTEXT_ERROR",{context:"WebGL",error:"uninitialized context"}),null;if(!(e instanceof WebGLShader))return glacier.error("INVALID_PARAMETER",{parameter:"vertShader",value:typeof e,expected:"WebGLShader",method:"context.WebGL.createProgram"}),null;if(!(r instanceof WebGLShader))return glacier.error("INVALID_PARAMETER",{parameter:"fragShader",value:typeof r,expected:"WebGLShader",method:"context.WebGL.createProgram"}),null;var t=this.gl,a=t.createProgram();return t.attachShader(a,e),t.attachShader(a,r),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?a:(glacier.error("CONTEXT_ERROR",{context:"WebGL",error:t.getProgramInfoLog(a)}),null)},createShader:function(e,r){if(!this.gl)return glacier.error("CONTEXT_ERROR",{context:"WebGL",error:"uninitialized context"}),null;var t,a,i=this.gl,n=[i.FRAGMENT_SHADER,i.VERTEX_SHADER];return"string"!=typeof r?(glacier.error("INVALID_PARAMETER",{parameter:"source",value:typeof r,expected:"string",method:"context.WebGL.createShader"}),null):-1==n.indexOf(e)?(t=(n=n.join(", ")).lastIndexOf(", "),n=t>=0?n.substr(0,t)+" or"+n.substr(t+1):n,glacier.error("INVALID_PARAMETER",{parameter:"type",value:e,expected:n,method:"context.WebGL.createShader"}),null):(a=i.createShader(e),i.shaderSource(a,r),i.compileShader(a),i.getShaderParameter(a,this.gl.COMPILE_STATUS)?a:(glacier.error("CONTEXT_ERROR",{context:"WebGL",error:i.getShaderInfoLog(a)}),null))},createTexture:function(e){if(!this.gl)return glacier.error("CONTEXT_ERROR",{context:"WebGL",error:"uninitialized context"}),null;if(e instanceof Image){var r=this.gl,t=r.createTexture();return r.bindTexture(r.TEXTURE_2D,t),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_NEAREST),r.generateMipmap(r.TEXTURE_2D),r.bindTexture(r.TEXTURE_2D,null),t}return glacier.error("INVALID_PARAMETER",{parameter:"image",value:typeof e,expected:"Image",method:"context.WebGL.createTexture"}),null}}),glacier.Sphere=function Sphere(e,r,t){glacier.Mesh.call(this),t="number"==typeof t&&t>=0?t:0,Object.defineProperty(this,"radius",{get:function(){return t},set:function(e){"number"==typeof e&&e>=0?(e>0?this.vertices.forEach(function(r){r=r/t*e}):this.indices.length&&this.free(),t=e):glacier.error("INVALID_ASSIGNMENT",{variable:"Sphere.radius",value:e,expected:"positive number"})}}),e&&r&&this.generate(e,r,t||1)},glacier.extend(glacier.Sphere,glacier.Mesh,{free:function(){glacier.Mesh.prototype.free.call(this),this.radius=0},generate:function(e,r,t){if("number"!=typeof e||3>e)return glacier.error("INVALID_PARAMETER",{parameter:"latitudes",value:e,expected:"number (>= 3)",method:"Sphere.generate"}),!1;if(e=Math.round(Math.abs(e)),"number"!=typeof r||3>r)return glacier.error("INVALID_PARAMETER",{parameter:"longitudes",value:r,expected:"number (>= 3)",method:"Sphere.generate"}),!1;if(r=Math.round(Math.abs(r)),void 0===t)t=1;else if("number"!=typeof t||0>=t)return glacier.error("INVALID_PARAMETER",{parameter:"radius",value:t,expected:"number (> 0.0)",method:"Sphere.generate"}),!1;this.free(),this.radius=t;var a,i,n,o,s,c,h,l,u,f,y,g,p;for(a=0;e>=a;++a)for(n=a*Math.PI/e,o=Math.sin(n),s=Math.cos(n),i=0;r>=i;++i)c=2*i*Math.PI/r,h=Math.sin(c),l=Math.cos(c),u=l*o,f=s,y=h*o,g=1-i/r,p=a/e,this.vertices.push(new glacier.Vector3(t*u,t*f,t*y)),this.normals.push(new glacier.Vector3(u,f,y)),this.texCoords.push(new glacier.Vector2(g,p));for(a=0;e>a;++a)for(i=0;r>i;++i)u=a*(r+1)+i,f=u+r+1,this.indices.push(u,f,u+1),this.indices.push(f,f+1,u+1);return!0}}),glacier.i18n.en={CONTEXT_ERROR:"{context} context error: {error}",INDEX_OUT_OF_RANGE:"Index out of range: {index} (expected range {range}) in {method}",INVALID_ASSIGNMENT:"Invalid assigment of {variable}: {value} (expected {expected})",INVALID_PARAMETER:"Invalid parameter {parameter}: {value} (expected {expected}) in {method}",MATRIX_NO_INVERSE:"Inverse matrix does not exist: {matrix} in {method}",MISSING_IMPLEMENTATION:"Missing implementation: {implementation} in {child} extension of {parent}",MISSING_PARAMETER:"Missing mandatory parameter: {parameter} in {method}",UNDEFINED_ELEMENT:"Undefined element ID: {element} in {method}",UNDEFINED_ERROR:"Undefined error: {error}",UNDEFINED_WARNING:"Undefined warning: {warning}",UNDEFINED_LANGUAGE:"Undefined language: {language} (using {fallback} as fallback)",UNKNOWN_PROPERTY:"Unrecognized property: {property} in {object}"},glacier.i18n.nb={CONTEXT_ERROR:"{context} kontekstfeil: {error}",INDEX_OUT_OF_RANGE:"Index out of range: {index} (expected range {range}) in {method}",INVALID_ASSIGNMENT:"Ugyldig tildeing av {variable}: {value} (forventet {expected})",INVALID_PARAMETER:"Ugyldig parameter {parameter}: {value} (forventet {expected}) i {method}",MATRIX_NO_INVERSE:"Invers matrise eksisterer ikke: {matrix} i {method}",MISSING_IMPLEMENTATION:"Mangler implementasjon: {implementation} i {child} utvidelse av {parent}",MISSING_PARAMETER:"Mangler obligatorisk parameter: {parameter} i {method}",UNDEFINED_ELEMENT:"Udefinert element ID: {element} i {method}",UNDEFINED_ERROR:"Udefinert feilmelding: {error}",UNDEFINED_WARNING:"Udefinert advarsel: {warning}",UNDEFINED_LANGUAGE:"Udefinert språkkode: {language} (bruker {fallback})",UNKNOWN_PROPERTY:"Ukjent egenskap: {property} i {object}"},glacier.Matrix33=function Matrix33(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,1,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix33.prototype={assign:function(e){var r,t,a;if(e instanceof glacier.Matrix33)for(a in e.array)this.array[a]=e.array[a];else if(e instanceof glacier.Matrix44)for(t=0;3>t;++t)for(r=0;3>r;++r)this.array[3*t+r]=e.array[4*t+r];else if(glacier.isArray(e)&&9==e.length)for(a=0;a<e.length;++a)this.array[a]=e[a];else if("number"==typeof e)for(a in this.array)this.array[a]=e;else glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Matrix33, Matrix44 or array[9]",method:"Matrix33.assign"});return this},determinant:function(){return this.array[0]*(this.array[4]*this.array[8]-this.array[5]*this.array[7])-this.array[1]*(this.array[3]*this.array[8]-this.array[5]*this.array[6])+this.array[2]*(this.array[3]*this.array[7]-this.array[4]*this.array[6])},element:function(e,r){if("number"==typeof r&&"number"==typeof e){if(r>=0&&3>=r&&e>=0&&3>=e)return this.array[3*e+r]}else if("number"==typeof e)return this.array[e];return void glacier.error("INDEX_OUT_OF_RANGE",{index:e+(r||0),range:"0-9",method:"Matrix33.element"})},multiply:function(e){var r,t,a,i;if(e instanceof glacier.Matrix33)for(i=new Float32Array(this.array),r=0;3>r;++r)for(t=0;3>t;++t)this.array[3*r+t]=i[3*r+0]*e.array[0+t]+i[3*r+1]*e.array[3+t]+i[3*r+2]*e.array[6+t];else if(e instanceof glacier.Matrix44)this.multiply(new glacier.Matrix33(e));else if("number"==typeof e)for(a in this.array)this.array[a]*=e;else glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Matrix33 or Matrix44",method:"Matrix33.multiply"});return this},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[3],this.array[3]=e,e=this.array[2],this.array[2]=this.array[6],this.array[6]=e,e=this.array[5],this.array[5]=this.array[7],this.array[7]=e,this},transposed:function(){var e=new glacier.Matrix33(this);return e.transpose()},inverse:function(){var e=new glacier.Matrix33(this);return e.invert()?e:void glacier.error("MATRIX_NO_INVERSE",{matrix:e.toString(),method:"Matrix33.inverse"})},invert:function(){var e=new Float32Array([this.array[4]*this.array[8]-this.array[5]*this.array[7],this.array[2]*this.array[7]-this.array[1]*this.array[8],this.array[1]*this.array[5]-this.array[2]*this.array[4],this.array[5]*this.array[6]-this.array[3]*this.array[8],this.array[0]*this.array[8]-this.array[2]*this.array[6],this.array[2]*this.array[3]-this.array[0]*this.array[5],this.array[3]*this.array[7]-this.array[4]*this.array[6],this.array[1]*this.array[6]-this.array[0]*this.array[7],this.array[0]*this.array[4]-this.array[1]*this.array[3]]),r=this.array[0]*e[0]+this.array[1]*e[3]+this.array[2]*e[6];if(glacier.compare(r,0))return!1;r=1/r;for(var t=0;t<e.length;++t)this.array[t]=e[t]*r;return!0},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+"], ["+this.array[3].toPrecision(5)+", "+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+"], ["+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+", "+this.array[8].toPrecision(5)+"]]"}},glacier.Matrix44=function Matrix44(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix44.prototype={assign:function(e){var r,t,a;if(e instanceof glacier.Matrix33){for(t=0;3>t;++t)for(r=0;3>r;++r)this.array[4*t+r]=e.array[3*t+r];this.array[3]=this.array[7]=this.array[11]=0,this.array[12]=this.array[13]=this.array[14]=0,this.array[16]=1}else if(e instanceof glacier.Matrix44)for(a in e.array)this.array[a]=e.array[a];else if(glacier.isArray(e)&&16==e.length)for(a=0;a<e.length;++a)this.array[a]=e[a];else if("number"==typeof e)for(a in this.array)this.array[a]=e;else glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Matrix33, Matrix44 or array[16]",method:"Matrix44.assign"});return this},determinant:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],r=this.array[0]*this.array[6]-this.array[2]*this.array[4],t=this.array[0]*this.array[7]-this.array[3]*this.array[4],a=this.array[1]*this.array[6]-this.array[2]*this.array[5],i=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],h=this.array[9]*this.array[14]-this.array[10]*this.array[13],l=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14];return e*u-r*l+t*h+a*c-i*s+n*o},element:function(e,r){if("number"==typeof r&&"number"==typeof e){if(r>=0&&4>=r&&e>=0&&4>=e)return this.array[4*e+r]}else if("number"==typeof e)return this.array[e];return void glacier.error("INDEX_OUT_OF_RANGE",{index:e+(r||0),range:"0-16",method:"Matrix44.element"})},frustum:function(e,r,t,a,i,n){var o,s,c,h,l="left,right,bottom,top,near,far".split(",");return[e,r,t,a,i,n].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:l[r],value:typeof e,expected:"number",method:"Matrix44.frustum"}),o=!0)}),o||0>=i||0>=n||(s=r-e)<=0||(c=a-t)<=0||(h=n-i)<=0?!1:(this.assign(new glacier.Matrix44([2*i/s,0,0,0,0,2*i/c,0,0,(r+e)/s,(a+t)/c,-(i+n)/h,-1,0,0,-2*i*n/h,0]).multiply(this)),!0)},inverse:function(){var e=new glacier.Matrix44(this);return e.invert()?e:void glacier.error("MATRIX_NO_INVERSE",{matrix:e.toString(),method:"Matrix44.inverse"})},invert:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],r=this.array[0]*this.array[6]-this.array[2]*this.array[4],t=this.array[0]*this.array[7]-this.array[3]*this.array[4],a=this.array[1]*this.array[6]-this.array[2]*this.array[5],i=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],h=this.array[9]*this.array[14]-this.array[10]*this.array[13],l=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14],f=e*u-r*l+t*h+a*c-i*s+n*o;if(glacier.compare(f,0))return!1;var y=new Float32Array([this.array[5]*u-this.array[6]*l+this.array[7]*h,-this.array[1]*u+this.array[2]*l-this.array[3]*h,this.array[13]*n-this.array[14]*i+this.array[15]*a,-this.array[9]*n+this.array[10]*i-this.array[11]*a,-this.array[4]*u+this.array[6]*c-this.array[7]*s,this.array[0]*u-this.array[2]*c+this.array[3]*s,-this.array[12]*n+this.array[14]*t-this.array[15]*r,this.array[8]*n-this.array[10]*t+this.array[11]*r,this.array[4]*l-this.array[5]*c+this.array[7]*o,-this.array[0]*l+this.array[1]*c-this.array[3]*o,this.array[12]*i-this.array[13]*t+this.array[15]*e,-this.array[8]*i+this.array[9]*t-this.array[11]*e,-this.array[4]*h+this.array[5]*s-this.array[6]*o,this.array[0]*h-this.array[1]*s+this.array[2]*o,-this.array[12]*a+this.array[13]*r-this.array[14]*e,this.array[8]*a-this.array[9]*r+this.array[10]*e]);

f=1/f;for(var g=0;g<y.length;++g)this.array[g]=y[g]*f;return!0},multiply:function(e){var r,t,a,i;if(e instanceof glacier.Matrix44)for(i=new Float32Array(this.array),r=0;4>r;++r)for(t=0;4>t;++t)this.array[4*r+t]=i[4*r+0]*e.array[0+t]+i[4*r+1]*e.array[4+t]+i[4*r+2]*e.array[8+t]+i[4*r+3]*e.array[12+t];else if(e instanceof glacier.Matrix33)this.multiply(new glacier.Matrix44(e));else if("number"==typeof e)for(a in this.array)this.array[a]*=e;else glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Matrix33 or Matrix44",method:"Matrix44.multiply"});return this},ortho:function(e,r,t,a,i,n){var o,s="left,right,bottom,top,near,far".split(",");return[e,r,t,a,i,n].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:s[r],value:typeof e,expected:"number",method:"Matrix44.ortho"}),o=!0)}),!o&&(dX=r-e)&&(dY=a-t)&&(dZ=n-i)?(this.assign(new glacier.Matrix44([2/dX,0,0,0,0,2/dY,0,0,0,0,-2/dZ,0,-(r+e)/dX,-(a+t)/dY,-(i+n)/dZ,1]).multiply(this)),!0):!1},perspective:function(e,r,t,a){var i,n,o,s="verticalViewAngle,aspectRatio,near,far".split(","),c=new glacier.Matrix44;return[e,r,t,a].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:s[r],value:typeof e,expected:"number",method:"Matrix44.perspective"}),i=!0)}),i||0>=t||0>=a?!1:(n=Math.tan(e/360*Math.PI)*t,o=n*r,c.frustum(-o,o,-n,n,t,a)?(this.assign(c.multiply(this)),!0):!1)},rotate:function(e,r,t,a){if("number"!=typeof e)glacier.error("INVALID_PARAMETER",{parameter:"radians",value:typeof e,expected:"number",method:"Matrix44.rotate"});else{if(r instanceof glacier.Vector3)return this.rotate(e,r.x,r.y,r.z);var i,n,o,s,c,h=["x","y","z"],l=r;[l,t,a].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:h[r],value:typeof e,expected:"number",method:"Matrix44.rotate"}),i=!0)}),i||(c=1-(n=Math.cos(e)),o=Math.sin(e),isNaN(s=Math.sqrt(l*l+t*t+a*a))||(l/=s,t/=s,a/=s,this.assign(new glacier.Matrix44([c*l*l+n,c*l*t-a*o,c*l*a+t*o,0,c*t*l+a*o,c*t*t+n,c*t*a-l*o,0,c*a*l-t*o,c*a*t+l*o,c*a*a+n,0,0,0,0,1]).multiply(this))))}return this},scale:function(e,r,t){if(e instanceof glacier.Vector3)return this.scale(e.x,e.y,e.z);var a,i=["x","y","z"],n=e;return[n,r,t].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:i[r],value:typeof e,expected:"number",method:"Matrix44.scale"}),a=!0)}),a||(this.array[0]*=n,this.array[4]*=r,this.array[8]*=t,this.array[1]*=n,this.array[5]*=r,this.array[9]*=t,this.array[2]*=n,this.array[6]*=r,this.array[10]*=t,this.array[3]*=n,this.array[7]*=r,this.array[11]*=t),this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+", "+this.array[3].toPrecision(5)+"], ["+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+", "+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+"], ["+this.array[8].toPrecision(5)+", "+this.array[9].toPrecision(5)+", "+this.array[10].toPrecision(5)+", "+this.array[11].toPrecision(5)+"], ["+this.array[12].toPrecision(5)+", "+this.array[13].toPrecision(5)+", "+this.array[14].toPrecision(5)+", "+this.array[15].toPrecision(5)+"]]"},translate:function(e,r,t){if(e instanceof glacier.Vector3)return this.translate(e.x,e.y,e.z);var a,i=["x","y","z"],n=e;return[n,r,t].forEach(function(e,r){"number"!=typeof e&&(glacier.error("INVALID_PARAMETER",{parameter:i[r],value:typeof e,expected:"number",method:"Matrix44.translate"}),a=!0)}),a||(this.array[12]+=this.array[0]*n+this.array[4]*r+this.array[8]*t,this.array[13]+=this.array[1]*n+this.array[5]*r+this.array[9]*t,this.array[14]+=this.array[2]*n+this.array[6]*r+this.array[10]*t,this.array[15]+=this.array[3]*n+this.array[7]*r+this.array[11]*t),this},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[4],this.array[4]=e,e=this.array[2],this.array[2]=this.array[8],this.array[8]=e,e=this.array[3],this.array[3]=this.array[12],this.array[12]=e,e=this.array[6],this.array[6]=this.array[9],this.array[9]=e,e=this.array[7],this.array[7]=this.array[13],this.array[13]=e,e=this.array[11],this.array[11]=this.array[14],this.array[14]=e,this},transposed:function(){var e=new glacier.Matrix44(this);return e.transpose()}},glacier.Vector2=function Vector2(e,r){glacier.union.call(this,["x","u"],"number"==typeof e?e:0),glacier.union.call(this,["y","v"],"number"==typeof r?r:0),e instanceof glacier.Vector2&&this.assign(e)},glacier.Vector2.prototype={add:function(e){return e instanceof glacier.Vector2?(this.x+=e.x,this.y+=e.y):"number"==typeof e?(this.x+=e,this.y+=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector2",method:"Vector2.add"}),this},assign:function(e,r){if(e instanceof glacier.Vector2)return this.assign(e.x,e.y);var t,a=["x","y"],i=e;return[i,r].forEach(function(e,r){"number"!=typeof e&&(glaicer.error("INVALID_PARAMETER",{parameter:a[r],value:typeof e,expected:"number",method:"Vector2.assign"}),t=!0)}),t||(this.x=i,this.y=r),this},distance:function(e){var r=this.x-e.x,t=this.y-e.y;return Math.sqrt(r*r+t*t)},divide:function(e){return e instanceof glacier.Vector2?(this.x/=e.x,this.y/=e.y):"number"==typeof e?(this.x/=e,this.y/=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector2",method:"Vector2.divide"}),this},dotProduct:function(e){return this.x*e.x+this.y*e.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},multiply:function(e){return e instanceof glacier.Vector2?(this.x*=e.x,this.y*=e.y):"number"==typeof e?(this.x*=e,this.y*=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector2",method:"Vector2.multiply"}),this},normalize:function(){var e=1/this.length();return this.x*=e,this.y*=e,this},rotate:function(e){var r=Math.cos(e),t=Math.sin(e),a=this.x*r-this.y*t,i=this.x*t+this.y*r;return this.x=a,this.y=i,this},subtract:function(e){return e instanceof glacier.Vector2?(this.x-=e.x,this.y-=e.y):"number"==typeof e?(this.x-=e,this.y-=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector2",method:"Vector2.subtract"}),this},toString:function(){return"("+this.x+", "+this.y+")"},get array(){return new Float32Array([this.x,this.y])}},glacier.Vector3=function Vector3(e,r,t){glacier.union.call(this,["x","u"],"number"==typeof e?e:0),glacier.union.call(this,["y","v"],"number"==typeof r?r:0),glacier.union.call(this,["z","w"],"number"==typeof t?t:0),e instanceof glacier.Vector3&&this.assign(e)},glacier.Vector3.prototype={add:function(e){return e instanceof glacier.Vector3?(this.x+=e.x,this.y+=e.y,this.z+=e.z):"number"==typeof e?(this.x+=e,this.y+=e,this.z+=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector3",method:"Vector3.add"}),this},angle:function(e){var r=Math.acos(this.dotProduct(e)/(this.length()*e.length()));return isNaN(r)?0:r},assign:function(e,r,t){if(e instanceof glacier.Vector3)return this.assign(e.x,e.y,e.z);var a,i=["x","y","z"],n=e;return[n,r,t].forEach(function(e,r){"number"!=typeof e&&(glaicer.error("INVALID_PARAMETER",{parameter:i[r],value:typeof e,expected:"number",method:"Vector3.assign"}),a=!0)}),a||(this.x=n,this.y=r,this.z=t),this},crossProduct:function(e){return new glacier.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},distance:function(e){var r=this.x-e.x,t=this.y-e.y,a=this.z-e.z;return Math.sqrt(r*r+t*t+a*a)},divide:function(e){return e instanceof glacier.Vector3?(this.x/=e.x,this.y/=e.y,this.z/=e.z):"number"==typeof e?(this.x/=e,this.y/=e,this.z/=e):e instanceof glacier.Matrix33?(this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2)):e instanceof glacier.Matrix44?(this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2)+e.element(0,3),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2)+e.element(1,3),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2)+e.element(2,3)):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Vector3, Matrix33 or Matrix44",method:"Vector3.divide"}),this},dotProduct:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},multiply:function(e){return e instanceof glacier.Vector3?(this.x*=e.x,this.y*=e.y,this.z*=e.z):"number"==typeof e?(this.x*=e,this.y*=e,this.z*=e):e instanceof glacier.Matrix33?(this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2)):e instanceof glacier.Matrix44?(this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2)+e.element(0,3),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2)+e.element(1,3),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2)+e.element(2,3)):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number, Vector3, Matrix33 or Matrix44",method:"Vector3.multiply"}),this},normalize:function(){var e=1/this.length();return this.x*=e,this.y*=e,this.z*=e,this},rotateX:function(e){var r=Math.cos(e),t=Math.sin(e),a=this.y*r-this.z*t,i=this.y*t+this.z*r;return this.y=a,this.z=i,this},rotateY:function(e){var r=Math.cos(e),t=Math.sin(e),a=this.x*r-this.z*t,i=this.x*t+this.z*r;return this.x=a,this.z=i,this},rotateZ:function(e){var r=Math.cos(e),t=Math.sin(e),a=this.x*r-this.y*t,i=this.x*t+this.y*r;return this.x=a,this.y=i,this},subtract:function(e){return e instanceof glacier.Vector3?(this.x-=e.x,this.y-=e.y,this.z-=e.z):"number"==typeof e?(this.x-=e,this.y-=e,this.z-=e):glacier.error("INVALID_PARAMETER",{parameter:"value",value:typeof e,expected:"number or Vector3",method:"Vector3.subtract"}),this},toString:function(){return"("+this.x+", "+this.y+", "+this.z+")"},get array(){return new Float32Array([this.x,this.y,this.z])}},glacier.context.WebGL.Drawable=function(e,r,t){if(!(e instanceof glacier.context.WebGL))return void glacier.error("INVALID_PARAMETER",{parameter:"context",value:typeof e,expected:"context.WebGL",method:"context.WebGL.Drawable constructor"});var a=e.gl,i=[a.POINTS,a.LINE_STRIP,a.LINE_LOOP,a.LINES,a.TRIANGLE_STRIP,a.TRIANGLE_FAN,a.TRIANGLES];return-1==i.indexOf(r)?void glacier.error("INVALID_PARAMETER",{parameter:"drawMode",value:r,expected:"valid WebGL draw mode",method:"context.WebGL.Drawable constructor"}):t instanceof glacier.context.WebGL.Shader?void Object.defineProperties(this,{buffers:{value:{}},context:{value:e},drawMode:{value:r},elements:{value:0,configurable:!0},textures:{value:{}},shader:{get:function(){return t},set:function(e){e instanceof glacier.context.WebGL.Shader?t=e:glacier.error("INVALID_ASSIGNMENT",{variable:"context.WebGL.Drawable.shader",value:typeof t,expected:"glacier.context.WebGL.Shader"})}}}):void glacier.error("INVALID_PARAMETER",{parameter:"shader",value:typeof t,expected:"context.WebGL.Shader",method:"context.WebGL.Drawable constructor"})},glacier.context.WebGL.Drawable.prototype={draw:function(){if(this.context&&this.shader){var e,r,t=(Float32Array.BYTES_PER_ELEMENT,this.context.gl);t.useProgram(this.shader.program),this.buffers.vertex&&null!==(e=this.shader.attribute("vertex_xyz"))&&(t.bindBuffer(t.ARRAY_BUFFER,this.buffers.vertex),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,3,t.FLOAT,!1,0,0)),this.buffers.normal&&null!==(e=this.shader.attribute("normal_xyz"))&&(t.bindBuffer(t.ARRAY_BUFFER,this.buffers.normal),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,3,t.FLOAT,!1,0,0)),this.buffers.texCoord&&null!==(e=this.shader.attribute("texture_uv"))&&(t.bindBuffer(t.ARRAY_BUFFER,this.buffers.texCoord),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,2,t.FLOAT,!1,0,0)),this.buffers.color&&null!==(e=this.shader.attribute("color_rgba"))&&(t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,4,t.FLOAT,!1,0,0)),this.textures.base&&(r=this.shader.uniform("sampler_texture"))&&(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.textures.base),t.uniform1i(r,0)),this.textures.normal&&(r=this.shader.uniform("sampler_normal_map"))&&(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.textures.normal),t.uniform1i(r,1)),this.buffers.index&&(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffers.index),t.drawElements(this.drawMode,this.elements,t.UNSIGNED_SHORT,0)),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}},init:function(e,r,t,a,i){if(this.context&&this.shader){var n,o=this.context.gl;if(glacier.isArray(e,glacier.Vector3))n=[],e.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.vertex=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW);else if(e)return glacier.error("INVALID_PARAMETER",{parameter:"vertices",value:typeof e,expected:"Vector3 array",method:"context.WebGL.Drawable.init"}),!1;if(glacier.isArray(r,"number"))n=[],r.forEach(function(e){n.push(e)}),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this.buffers.index=o.createBuffer()),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.STATIC_DRAW),Object.defineProperty(this,"elements",{value:n.length});else if(r)return glacier.error("INVALID_PARAMETER",{parameter:"indices",value:typeof r,expected:"number array",method:"context.WebGL.Drawable.init"}),!1;if(glacier.isArray(t,glacier.Vector3))n=[],t.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.normal=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW);else if(t)return glacier.error("INVALID_PARAMETER",{parameter:"normals",value:typeof t,expected:"Vector3 array",method:"context.WebGL.Drawable.init"}),!1;if(glacier.isArray(a,glacier.Vector2))n=[],a.forEach(function(e){n.push(e.u,e.v)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.texCoord=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW);else if(t)return glacier.error("INVALID_PARAMETER",{parameter:"texCoords",value:typeof a,expected:"Vector2 array",method:"context.WebGL.Drawable.init"}),!1;if(glacier.isArray(i,glacier.Color))n=[],i.forEach(function(e){n.push(e.r,e.g,e.b,e.a)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.color=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW);else if(t)return glacier.error("INVALID_PARAMETER",{parameter:"colors",value:typeof i,expected:"Color array",method:"context.WebGL.Drawable.init"}),!1;return o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),!0}return!1},free:function(){if(this.context){var e,r=this.context.gl;for(e in this.buffers)this.buffers.hasOwnProperty(e)&&(r.deleteBuffer(this.buffers[e]),delete this.buffers[e]);["base","alpha","normal","specular"].forEach(function(e,t){this.textures[e]instanceof WebGLTexture&&(r.deleteTexture(this.textures[e]),delete this.textures[e])},this)}}},glacier.context.WebGL.Shader=function(e,r){return e instanceof glacier.context.WebGL?r instanceof WebGLProgram?void Object.defineProperties(this,{attributes:{value:{}},context:{value:e},program:{value:r},uniforms:{value:{}}}):void glacier.error("INVALID_PARAMETER",{parameter:"program",value:typeof r,expected:"WebGLProgram",method:"context.WebGL.Shader constructor"}):void glacier.error("INVALID_PARAMETER",{parameter:"context",value:typeof e,expected:"context.WebGL",method:"context.WebGL.Shader constructor"})},glacier.context.WebGL.Shader.prototype={addAttributes:function(e){if(glacier.isArray(e,"string")){var r;e.forEach(function(e){this.attributes.hasOwnProperty(e)||(r=this.context.gl.getAttribLocation(this.program,e))>=0&&(this.attributes[e]=r)},this)}else glacier.error("INVALID_PARAMETER",{parameter:"attributeArray",value:typeof e,expected:"string array",method:"glacier.WebGL.Shader.addAttributes"})},addUniforms:function(e){if(glacier.isArray(e,"string")){var r;e.forEach(function(e){this.uniforms.hasOwnProperty(e)||null!==(r=this.context.gl.getUniformLocation(this.program,e))&&(this.uniforms[e]=r)},this)}else glacier.error("INVALID_PARAMETER",{parameter:"uniformArray",value:typeof e,expected:"string array",method:"glacier.WebGL.Shader.addUniforms"})},attribute:function(e){if("string"==typeof e){if("number"==typeof(e=this.attributes[e]))return e>=0?e:null}else glacier.error("INVALID_PARAMETER",{parameter:"attribute",value:typeof e,expected:"string",method:"context.WebGL.Shader.attribute"});return null},uniform:function(e){if("string"==typeof e){if((e=this.uniforms[e])instanceof WebGLUniformLocation)return e}else glacier.error("INVALID_PARAMETER",{parameter:"uniform",value:typeof e,expected:"string",method:"context.WebGL.Shader.uniform"});return null},use:function(){return this.context&&this.program?(this.context.gl.useProgram(this.program),!0):!1}},glacier.context.WebGL.ShaderBank=function(e){return e instanceof glacier.context.WebGL?void Object.defineProperties(this,{context:{value:e},shaders:{value:{}}}):void glacier.error("INVALID_PARAMETER",{parameter:"context",value:typeof e,expected:"context.WebGL",method:"context.WebGL.ShaderBank constructor"})},glacier.context.WebGL.ShaderBank.prototype={init:function(){if(this.context instanceof glacier.context.WebGL){var e,r,t,a,i,n,o,s,c,h=/attribute\s+(?:(?:high|medium|low)p\s+)?(?:float|(?:(?:vec|mat)[234]))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)\s*;/g,l=/uniform\s+(?:(?:high|medium|low)p\s+)?(?:bool|int|float|(?:(?:vec|bvec|ivec|mat)[234])|(?:sampler(?:Cube|2D)))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)(\[(?:(?:\d+)|(?:[a-zA-Z_]+[a-zA-Z0-9_]*))\])?\s*;/g,u={},f={},y=this.context.gl,g=glacier.context.WebGL.shaders;for(e in g.vertex)if(g.vertex[e]instanceof Array){for(a=g.vertex[e].join("\n"),n={attributes:[],uniforms:[]};i=h.exec(a);)n.attributes.push(i[1]);for(;i=l.exec(a);)n.uniforms.push(i[1]);(n.shader=this.context.createShader(y.VERTEX_SHADER,a))&&(u[e]=n)}for(r in g.fragment)if(g.fragment[r]instanceof Array){for(a=g.fragment[r].join("\n"),n={uniforms:[]};i=l.exec(a);)n.uniforms.push(i[1]);(n.shader=this.context.createShader(y.FRAGMENT_SHADER,a))&&(f[r]=n)}for(t in g.programs)if(g.programs.hasOwnProperty(t)&&(e=u[g.programs[t].vertex],r=f[g.programs[t].fragment],e&&r&&(o=e.shader)&&(s=r.shader)&&(c=this.context.createProgram(o,s)))){var p=new glacier.context.WebGL.Shader(this.context,c);p.addAttributes(e.attributes),p.addUniforms(e.uniforms),p.addUniforms(r.uniforms),Object.defineProperty(this,t,{value:p})}return!0}return!1},shader:function(e){if("string"==typeof e){if((e=this.shaders[e])instanceof glacier.context.WebGLShader)return e}else glacier.error("INVALID_PARAMETER",{parameter:"shader",value:typeof e,expected:"string",method:"context.WebGL.ShaderBank.shader"});return null}},glacier.context.WebGL.shaders={vertex:{general:["attribute highp vec3 vertex_xyz;","attribute highp vec3 normal_xyz;","attribute highp vec2 texture_uv;","attribute highp vec4 color_rgba;","uniform highp mat4 matrix_mvp;","varying mediump vec2 tex_coords;","varying mediump vec4 frag_color;","void main()","{","gl_Position = matrix_mvp * vec4(vertex_xyz, 1.0);","tex_coords = texture_uv; frag_color = color_rgba;","}"]},fragment:{textured:["precision mediump float;","uniform sampler2D sampler_texture;","varying mediump vec2 tex_coords;","varying mediump vec4 frag_color;","void main()","{","gl_FragColor = texture2D(sampler_texture, tex_coords);","}"],normalMapped:["precision mediump float;","uniform sampler2D sampler_texture;","uniform sampler2D sampler_normal_map;","varying mediump vec2 tex_coords;","varying mediump vec4 frag_color;","void main()","{","vec3 lightPos = normalize(vec3(1.0, 1.0, 1.0));","vec4 fragColor = vec4(1.0, 1.0, 1.0, 1.0);","vec3 normal = normalize(texture2D(sampler_normal_map, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(normal, lightPos), 0.0);","gl_FragColor = vec4(diffuse * texture2D(sampler_texture, tex_coords).rgb, 1.0);","}"]},programs:{textured:{vertex:"general",fragment:"textured"},normalMapped:{vertex:"general",fragment:"normalMapped"}}};