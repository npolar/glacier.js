var glacier={VERSION:"0.1.5",AUTHORS:["remi@npolar.no"]};"object"==typeof module&&(module.exports=glacier),glacier.load=function(e,t){var r,i="function"==typeof t?!0:!1;try{r=new XMLHttpRequest}catch(a){return!1}i&&(r.onreadystatechange=function(){4!=r.readyState||200!=r.status&&0!==r.status||t(r.responseText)});try{r.open("GET",e,i),r.overrideMimeType("text/plain"),r.send()}catch(a){return!1}return i?!0:r.responseText},glacier.isArray=function(e,t){var r,i;if([Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,Float32Array,Float64Array].forEach(function(t){!i&&e instanceof t&&(i=!0)}),i&&t)if("function"==typeof t){for(r=0;r<e.length;++r)if(!(e[r]instanceof t))return!1}else if("string"==typeof t)for(r=0;r<e.length;++r)if(typeof e[r]!=t)return!1;return!!i},glacier.extend=function(e,t,r){var i,a,n,o,s=arguments,c=[];for(i=1;i<s.length;++i)if(s[i]instanceof Object)if(o=c.push(function(){})-1){if(c[o].prototype=Object.create(c[o-1].prototype),n=s[i].prototype)for(a in n)n.hasOwnProperty(a)&&(c[o].prototype[a]=n[a]);else if(n=s[i])for(a in n)n.hasOwnProperty(a)&&(c[o].prototype[a]=n[a])}else c[o].prototype=Object.create(s[i].prototype||s[i]);n=e.prototype,e.prototype=Object.create(c.pop().prototype);for(i in n)n.hasOwnProperty(i)&&(e.prototype[i]=n[i]);return e},glacier.addTypedProperty=function(e,t,r,i){function typedProperty(a){Object.defineProperty(e,t[a],{get:function(){return r},set:function(e){if("function"==typeof i){if(!(e instanceof i))throw new glacier.exception.InvalidAssignment(t[a],e,i.name);r=e}else{if(typeof e!=typeof r)throw new glacier.exception.InvalidAssignment(t[a],e,typeof r);r=e}}})}t=t instanceof Array?t:[t];for(var a in t)typedProperty(a)},glacier.parseOptions=function(e,t,r){function getDefault(e){if(e instanceof Array){if(void 0!==e[0]&&null!==e[0]&&"object"==typeof e[0])return getDefault(e[0])}else if("object"==typeof e)for(a in e)if(e.hasOwnProperty(a)&&-1==s.indexOf(a))return e[a];return null}function getOverride(e,t,i){if(t instanceof Array){var a,o,c,l,h=[];for(a in t)if(null===t[a]){if(h.push("null"),null===e||void 0===e)return e}else if("object"==typeof t[a]){for(c in t[a])if(t[a].hasOwnProperty(c)&&-1==s.indexOf(c)&&(h.push(c),null!==(l=getOverride(t[a]))))return l}else if("string"==typeof t[a]&&(h.push(t[a]),typeof e==t[a]))return e;throw h=h.join(", "),o=h.lastIndexOf(", "),h=o>=0?h.substr(0,o)+" or"+h.substr(o+1):h,new glacier.exception.InvalidOption(i,e,h,r)}if("object"==typeof t)for(n in t)if(t.hasOwnProperty(n)&&-1==s.indexOf(n)){if("function"==typeof t["class"]){if(e instanceof t["class"])return e;throw new glacier.exception.InvalidOption(i,e,n,r)}if(typeof e==n){if(void 0!==t.not&&e===t.not)throw new glacier.exception.InvalidOption(i,e,n+" (except "+t.not+")",r);if(void 0!==t.gt&&e<=t.gt)throw new glacier.exception.InvalidOption(i,e,n+" (greater than "+t.gt+")",r);if(void 0!==t.lt&&e>=t.lt)throw new glacier.exception.InvalidOption(i,e,n+" (less than "+t.gt+")",r);return e}throw new glacier.exception.InvalidOption(i,e,n,r)}return null}var i,a,n,o={},s="gt,lt,class,not".split(",");if(e&&"object"!=typeof e)throw new glacier.exception.InvalidParameter("options",t,"object","parseOptions");if(e||(e={}),"object"!=typeof t)throw new glacier.exception.InvalidParameter("defaults",t,"object","parseOptions");for(i in t)t.hasOwnProperty(i)&&(o[i]=getDefault(t[i]),e.hasOwnProperty(i)&&(o[i]=getOverride(e[i],t[i],i)));return o},glacier.BufferObject=function BufferObject(e,t,r){if(!(e instanceof glacier.Drawable))throw new glacier.exception.InvalidParameter("drawable",e,"Drawable","(constructor)","BufferObject");if(!(t instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",t,"Context","(constructor)","BufferObject");if(!(r instanceof glacier.Shader))throw new glacier.exception.InvalidParameter("shader",r,"Shader","(constructor)","BufferObject");var i=t.gl,a=[i.POINTS,i.LINE_STRIP,i.LINE_LOOP,i.LINES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN,i.TRIANGLES],n=0,o=0;Object.defineProperties(this,{buffers:{value:{}},context:{value:t},parent:{value:e},textures:{value:[]},elements:{get:function(){return o},set:function(e){if(!("number"==typeof e&&e>=0))throw new glacier.exception.InvalidAssignment("elements",e,"positive integer","BufferObject");o=Math.round(e)}},drawMode:{get:function(){return n},set:function(e){if(-1==a.indexOf(e)){a.sort(function(e,t){return e-t});var t=a.join(", "),r=t.lastIndexOf(", ");throw t=r>=0?t.substr(0,r)+" or"+t.substr(r+1):t,new glacier.exception.InvalidAssignment("drawMode",e,t,"BufferObject")}n=e}},shader:{get:function(){return r},set:function(e){if(e instanceof glacier.Shader)r=e;else{if("string"!=typeof e)throw new glacier.exception.InvalidAssignment("shader",r,"Shader","BufferObject");var i=t.shaders.get(e);i instanceof glacier.Shader?r=i:console.warn("Undefined WebGL shader program: "+e)}}}})},glacier.BufferObject.MAX_TEXTURE_COUNT=4,glacier.BufferObject.prototype={draw:function(){if(this.context&&this.shader&&this.elements){var e,t,r,i,a=(Float32Array.BYTES_PER_ELEMENT,this.context.gl);for(this.shader.use(),this.buffers.vertex&&null!==(e=this.shader.attribute("vertex_xyz"))&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertex),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,3,a.FLOAT,!1,0,0)),this.buffers.normal&&null!==(e=this.shader.attribute("normal_xyz"))&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.normal),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,3,a.FLOAT,!1,0,0)),this.buffers.texCoord&&null!==(e=this.shader.attribute("texture_uv"))&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.texCoord),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0)),this.buffers.color&&null!==(e=this.shader.attribute("color_rgba"))&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.color),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,4,a.FLOAT,!1,0,0)),i=0;i<glacier.BufferObject.MAX_TEXTURE_COUNT;++i)(t=this.shader.uniform("tex_samp_"+i))&&(a.activeTexture(a.TEXTURE0+i),a.bindTexture(a.TEXTURE_2D,this.textures[i]instanceof WebGLTexture?this.textures[i]:null),a.uniform1i(t,i));(t=this.shader.uniform("matrix_mvp"))&&(r=new glacier.Matrix44(this.parent.matrix),this.context.projection instanceof glacier.Matrix44&&r.multiply(this.context.projection),a.uniformMatrix4fv(t,!1,r.array)),(t=this.shader.uniform("resolution"))&&a.uniform2f(t,context.width,constext.height),this.buffers.index?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffers.index),a.drawElements(this.drawMode,this.elements,a.UNSIGNED_SHORT,0)):this.buffers.vertex&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertex),a.drawArrays(this.drawMode,0,this.elements)),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindTexture(a.TEXTURE_2D,null)}},init:function(e,t,r,i,a){if(this.context&&this.shader){var n,o=this.context.gl;if(glacier.isArray(e,glacier.Vector3))e.length&&(n=[],e.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.vertex=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(e)throw new glacier.exception.InvalidParameter("vertices",e,"Vector3 array","init","BufferObject");if(glacier.isArray(t,"number"))t.length&&(n=[],t.forEach(function(e){n.push(e)}),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this.buffers.index=o.createBuffer()),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.STATIC_DRAW));else if(t)throw new glacier.exception.InvalidParameter("indices",t,"number array","init","BufferObject");if(glacier.isArray(r,glacier.Vector3))r.length&&(n=[],r.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.normal=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(r)throw new glacier.exception.InvalidParameter("normals",r,"Vector3 array","init","BufferObject");if(glacier.isArray(i,glacier.Vector2))i.length&&(n=[],i.forEach(function(e){n.push(e.u,e.v)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.texCoord=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(r)throw new glacier.exception.InvalidParameter("texCoords",i,"Vector2 array","init","BufferObject");if(glacier.isArray(a,glacier.Color))a.length&&(n=[],a.forEach(function(e){n.push(e.r/255,e.g/255,e.b/255,e.a)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.color=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(r)throw new glacier.exception.InvalidParameter("colors",a,"Color array","init","BufferObject");return o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),!0}return!1},free:function(){if(this.context){var e;for(e in this.buffers)this.buffers.hasOwnProperty(e)&&(this.context.gl.deleteBuffer(this.buffers[e]),delete this.buffers[e]);for(e=0;e<glacier.BufferObject.MAX_TEXTURE_COUNT;++e)this.freeTexture(e)}},freeTexture:function(e){this.context&&this.textures[e]&&(this.textures[e]instanceof WebGLTexture&&this.context.gl.deleteTexture(this.textures[e]),this.textures[e]=null)}},glacier.Camera=function Camera(e,t,r,i){var a=["fieldOfView","aspectRatio","clipNear","clipFar"];r=r||.1,i=i||100,[e,t,r,i].forEach(function(e,t){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter(a[t],e,"positive number","(constructor)","Camera");Object.defineProperty(this,a[t],{get:function(){return e},set:function(r){if(!("number"==typeof r&&r>0))throw new glacier.exception.InvalidAssignment(a[t],r,"positive number","Camera");e=r,this.update()}})},this),glacier.addTypedProperty(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.addTypedProperty(this,"position",new glacier.Vector3(0,1,1),glacier.Vector3),glacier.addTypedProperty(this,"target",new glacier.Vector3(0,0,0),glacier.Vector3),this.update()},glacier.Camera.prototype={bindMouse:function(e,t){if("string"==typeof e&&(e=document.getElementById(e)),!(e instanceof HTMLElement))throw new glacier.exception.InvalidParameter("container",e,"HTMLElement","bindMouse","Scene");var r,i=this;t=glacier.parseOptions(t,{movementButton:[{number:null},null],rotationButton:[{number:0},null],zoomButton:[{number:null},null],zoomMin:{number:1.01,gt:0},zoomMax:{number:10,gt:0},zoomSteps:{number:30,gt:0},wheelMovement:{"boolean":!1},wheelRotation:{"boolean":!1},wheelZoom:{"boolean":!0}}),i.mouseHandler={container:e,target:new glacier.Vector3(0,0,0),angle:new glacier.Vector2(0,0),zoom:t.zoomMax,zoomStep:t.zoomSteps,callbacks:{mousedown:function(e){null!==t.rotationButton&&e.button===t.rotationButton&&(i.mouseHandler.rotationStart={position:new glacier.Vector2(e.clientX,e.clientY),angle:new glacier.Vector2(i.mouseHandler.angle)})},mouseup:function(e){null!==t.rotationButton&&e.button===t.rotationButton&&(i.mouseHandler.rotationStart=null)},mousemove:function(e){if(i.mouseHandler.rotationStart){var t=new glacier.Vector2((e.clientX-i.mouseHandler.rotationStart.position.x)/i.mouseHandler.container.offsetWidth*360,-(e.clientY-i.mouseHandler.rotationStart.position.y)/i.mouseHandler.container.offsetHeight*180);i.mouseHandler.angle=new glacier.Vector2(i.mouseHandler.rotationStart.angle).subtract(t),i.mouseHandler.angle.y=glacier.clamp(i.mouseHandler.angle.y,-89,89),r()}},wheel:function(e){function easeIn(e,t,r,i){return(r-t)*Math.pow(2,10*(e/i-1))+t}t.wheelZoom&&(i.mouseHandler.zoomStep=glacier.clamp(i.mouseHandler.zoomStep+(e.deltaY>0?1:e.deltaY<0?-1:0),-t.zoomSteps,t.zoomSteps),i.mouseHandler.zoom=easeIn(i.mouseHandler.zoomStep,t.zoomMin,t.zoomMax,t.zoomSteps),r())}}},(r=function(){i.follow(i.mouseHandler.target,i.mouseHandler.angle,i.mouseHandler.zoom)}).call();for(var a in i.mouseHandler.callbacks)i.mouseHandler.callbacks.hasOwnProperty(a)&&"function"==typeof i.mouseHandler.callbacks[a]&&i.mouseHandler.container.addEventListener(a,i.mouseHandler.callbacks[a])},unbindMouse:function(){if(this.mouseHandler.container instanceof HTMLElement)for(var e in this.mouseHandler.callbacks)this.mouseHandler.callbacks.hasOwnProperty(e)&&"function"==typeof this.mouseHandler.callbacks[e]&&(this.mouseHandler.container.removeEventListener(e,this.mouseHandler.callbacks[e]),this.mouseHandler.callbacks[e]=null);this.mouseHandler.container=null},follow:function(e,t,r){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("target",e,"Vector3","follow","Camera");if(!(t instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("angle",e,"Vector2","follow","Camera");if("number"!=typeof r||0>=r)throw new glacier.exception.InvalidParameter("distance",r,"positive number","follow","Camera");var i={},a={},n=new glacier.Vector2(glacier.limitAngle(t.x),glacier.limitAngle(t.y));i.hyp=r,i.opp=i.hyp*Math.sin(glacier.degToRad(n.y)),i.adj=i.hyp*Math.cos(glacier.degToRad(n.y)),a.hyp=i.adj,a.opp=a.hyp*Math.sin(glacier.degToRad(n.x)),a.adj=a.hyp*Math.cos(glacier.degToRad(n.x)),this.target.assign(e),this.position.x=e.x-a.opp,this.position.y=e.y+i.opp,this.position.z=e.z-a.adj,this.update()},update:function(){var e,t,r=new glacier.Vector3(0,1,0);(e=new glacier.Vector3(this.position).subtract(this.target)).length&&e.normalize(),(t=r.cross(e)).length&&t.normalize(),(r=e.cross(t)).length&&r.normalize(),this.matrix.assign(new glacier.Matrix44),this.matrix.perspective(this.fieldOfView,this.aspectRatio,this.clipNear,this.clipFar),this.matrix.assign(new glacier.Matrix44([t.x,r.x,e.x,0,t.y,r.y,e.y,0,t.z,r.z,e.z,0,0,0,0,1]).multiply(this.matrix)).translate(-this.position.x,-this.position.y,-this.position.z)}},glacier.Color=function Color(e){var t,r,i,a=255;if(Object.defineProperties(this,{r:{get:function(){return a>>24&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("r",e,"number between 0 and 255","Color");a=((255&e)<<24)+(16777215&a)>>>0}},g:{get:function(){return a>>16&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("g",e,"number between 0 and 255","Color");a=((255&e)<<16)+(4278255615&a)>>>0}},b:{get:function(){return a>>8&255},set:function(e){if(!("number"==typeof e&&e>=0&&255>=e))throw new glacier.exception.InvalidAssignment("b",e,"number between 0 and 255","Color");a=((255&e)<<8)+(4294902015&a)>>>0}},a:{get:function(){return(a>>0&255)/255},set:function(e){if(!("number"==typeof e&&e>=0&&1>=e))throw new glacier.exception.InvalidAssignment("a",e,"number between 0.0 and 1.0","Color");a=((255*e&255)<<0)+(4294967040&a)>>>0}},rgb:{get:function(){return a>>8&16777215},set:function(e){if("number"==typeof e&&e>=0&&16777215>=e)a=((16777215&e)<<8)+(255&a)>>>0;else{if(!glacier.isArray(e))throw e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,new glacier.exception.InvalidAssignment("rgb",e,"RGB as 24-bits integer or array[3] of numbers between 0.0 and 1.0","Color");for(t=0,i=[];t<e.length&&("number"==typeof e[t]&&e[t]>=0&&e[t]<=1);++t)i.push(e[t]);if(3!=i.length)throw new glacier.exception.InvalidAssignment("rgb","["+e.join(", ")+"]","array[3] of numbers between 0.0 and 1.0","Color");this.rgb=(255*i[0]<<16)+(255*i[1]<<8)+255*i[2]>>>0}}},rgba:{get:function(){return a},set:function(e){if("number"==typeof e&&e>=0&&4294967295>=e)a=(4294967295&e)>>>0;else{if(!glacier.isArray(e))throw e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,new glacier.exception.InvalidAssignment("rgba",rgb,"RGBA as 32-bits integer or array[4] of numbers between 0.0 and 1.0","Color");for(t=0,i=[];t<e.length&&("number"==typeof e[t]&&e[t]>=0&&e[t]<=1);++t)i.push(e[t]);if(4!=i.length)throw new glacier.exception.InvalidAssignment("rgba","["+e.join(", ")+"]","array[4] of numbers between 0.0 and 1.0","Color");this.rgba=(255*i[0]<<24)+(255*i[1]<<16)+(255*i[2]<<8)+255*i[3]>>>0}}}}),e instanceof glacier.Color)this.rgba=e.rgba;else if(glacier.isArray(e))this.rgba=e;else switch((r=arguments).length){case 1:this.rgb=r[0];break;case 2:this.rgb=r[0],this.a=r[1];break;case 3:case 4:for(t=0,i=[];t<r.length;++t){if("number"!=typeof r[t])throw new glacier.exception.InvalidParameter(r[t],r[t],"number","(constructor)","Color");i.push(r[t]/(3>t?255:1))}for(;i.length<4;)i.push(1);this.rgba=i}},glacier.Color.prototype={assign:function(e,t,r,i){if(e instanceof glacier.Color)this.rgba=e.rgba;else{var a=["r","g","b"],n=e;if([n,t,r].forEach(function(e,t){if("number"!=typeof e||0>e||e>255)throw new glacier.exception.InvalidParameter(a[t],e,"number between 0 and 255","assign","Color")}),(i||0===i)&&("number"!=typeof i||0>i||i>1))throw new glacier.exception.InvalidParameter("a",i,"number between 0.0 and 1.0","assign","Color");this.r=n,this.g=t,this.b=r,this.a=i||0===i?i:1}return this},toArray:function(){return new Float32Array([this.r/255,this.g/255,this.b/255,this.a])},toString:function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(", ")+")"}},glacier.color={get WHITE(){return new glacier.Color(16777215,1)},get SILVER(){return new glacier.Color(12632256,1)},get GRAY(){return new glacier.Color(8421504,1)},get BLACK(){return new glacier.Color(0,1)},get RED(){return new glacier.Color(16711680,1)},get MAROON(){return new glacier.Color(8388608,1)},get YELLOW(){return new glacier.Color(16776960,1)},get OLIVE(){return new glacier.Color(8421376,1)},get LIME(){return new glacier.Color(65280,1)},get GREEN(){return new glacier.Color(32768,1)},get AQUA(){return new glacier.Color(65535,1)},get TEAL(){return new glacier.Color(32896,1)},get BLUE(){return new glacier.Color(255,1)},get NAVY(){return new glacier.Color(128,1)},get FUCHSIA(){return new glacier.Color(16711935,1)},get PURPLE(){return new glacier.Color(8388736,1)}},glacier.Context=function Context(e,t){var r,i,a,n=null;if(!(e instanceof HTMLCanvasElement)){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("canvas",e,"HTMLCanvasElement or string","(constructor)","Context");if(!((a=document.getElementById(e))instanceof HTMLCanvasElement))throw new glacier.exception.InvalidParameter("canvas",e,"string as HTMLCanvasElement ID","(constructor)","Context");e=a}if(t&&"object"!=typeof t)throw new glacier.exception.InvalidParameter("options",e,"object","(constructor)","Context");if(t||(t={}),!((i=e.getContext("webgl"))instanceof WebGLRenderingContext))throw new glacier.exception.ContextError("WebGL is not supported","(constructor)","Context");Object.defineProperties(this,{background:{get:function(){return r},set:function(e){if(!(e instanceof glacier.Color))throw new glacier.exception.InvalidAssignment("background",e,"Color","Context");r=e,i.clearColor(e.r/255,e.g/255,e.b/255,e.a),i.clear(i.COLOR_BUFFER_BIT)}},canvas:{value:e},gl:{value:i},height:{get:function(){return this.canvas.height},set:function(e){if(!("number"==typeof e&&e>0))throw new glacier.exception.InvalidAssignment("height",e,"positive number","Context");this.resize(width,e)}},projection:{get:function(){return n},set:function(e){if(e instanceof glacier.Matrix44)n=e;else{if(null!==e)throw new glacier.exception.InvalidAssignment("projection",e,"Matrix44 or null","Context");n=null}}},shaders:{value:new glacier.ShaderBank(this)},width:{get:function(){return this.canvas.width},set:function(e){if(!("number"==typeof e&&e>0))throw new glacier.exception.InvalidAssignment("width",e,"positive number","Context");this.resize(e,height)}}}),this.background=glacier.color.BLACK,this.resize(e.offsetWidth,e.offsetHeight),this.shaders.init(),window.addEventListener("resize",function(t){(e.width!=e.offsetWidth||e.height!=e.offsetHeight)&&this.resize(e.offsetWidth,e.offsetHeight)}.bind(this))},glacier.Context.prototype={clear:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},draw:function(e){e instanceof glacier.Drawable&&e.draw()},init:function(e,t){if(e instanceof glacier.Drawable)return e.init(this,t);throw new glacier.exception.InvalidParameter("drawable",e,"Drawable","init","Context")},resize:function(e,t){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter("width",e,"positive number","resize","Context");if("number"!=typeof t||0>=t)throw new glacier.exception.InvalidParameter("height",t,"positive number","resize","Context");this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t)},createProgram:function(e,t){if(!(e instanceof WebGLShader))throw new glacier.exception.InvalidParameter("vertShader",e,"WebGLShader","createProgram","Context");if(!(t instanceof WebGLShader))throw new glacier.exception.InvalidParameter("fragShader",t,"WebGLShader","createProgram","Context");var r=this.gl,i=r.createProgram();return r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),r.getProgramParameter(i,r.LINK_STATUS)?i:(console.warn(r.getProgramInfoLog(i)),null)},createShader:function(e,t){var r,i,a=this.gl,n=[a.FRAGMENT_SHADER,a.VERTEX_SHADER];if("string"!=typeof t)throw new glacier.exception.InvalidParameter("source",t,"string","createShader","Context");if(-1==n.indexOf(e))throw r=(n=n.join(", ")).lastIndexOf(", "),n=r>=0?n.substr(0,r)+" or"+n.substr(r+1):n,new glacier.exception.InvalidParameter("type",e,n,"createShader","Context");return i=a.createShader(e),a.shaderSource(i,t),a.compileShader(i),a.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.warn(a.getShaderInfoLog(i)),null)},createTexture:function(e){if(e instanceof Image){var t=this.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),r}throw new glacier.exception.InvalidParameter("image",e,"Image","createTexture","Context")},worldToScreen:function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("point",e,"Vector3","worldToScreen","Context");var r,i;if(t&&!(t instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("modelView",t,"Matrix44 or null","worldToScreen","Context");return r=new glacier.Matrix44(t||null),this.projection instanceof glacier.Matrix44&&r.multiply(this.projection),i={x:r.array[0]*e.x+r.array[4]*e.y+r.array[8]*e.z+r.array[12],y:r.array[1]*e.x+r.array[5]*e.y+r.array[9]*e.z+r.array[13],z:r.array[2]*e.x+r.array[6]*e.y+r.array[10]*e.z+r.array[14],w:r.array[3]*e.x+r.array[7]*e.y+r.array[11]*e.z+r.array[15]},i.w>0?(i.x=.5*(i.x/=i.w)+.5,i.y=.5*(i.y/=i.w)+.5,i.z=.5*(i.z/=i.w)+.5,new glacier.Vector2(Math.round(i.x*this.width),Math.round((1-i.y)*this.height))):null}},glacier.Drawable=function Drawable(){glacier.addTypedProperty(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.addTypedProperty(this,"visible",!0),["x","y","z"].forEach(function(e,t){Object.defineProperty(this,e,{get:function(){return this.matrix.array[12+t]},set:function(r){if("number"!=typeof r)throw new glacier.exception.InvalidAssignment(e,r,"number","Drawable");this.matrix.array[12+t]=r}})},this);var e=null;Object.defineProperty(this,"buffer",{get:function(){return e},set:function(t){if(t instanceof glacier.BufferObject)e=t;else{if(null!==t)throw new glacier.exception.InvalidAssignment("buffer",buffer,"BufferObject","Drawable");e&&e.free(),e=null}}})},glacier.Drawable.prototype={free:function(){this.buffer=null,this.matrix=new glacier.Matrix44,this.visible=!0},draw:function(){this.visible&&this.buffer instanceof glacier.BufferObject&&this.buffer.draw()},init:function(e,t){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","init","Drawable");var r=e.shaders.get("generic");if("object"==typeof t)"string"==typeof t.shader&&(r=e.shaders.get(t.shader));else if(t)throw new glacier.exception.InvalidParameter("options",t,"object","init","Drawable");return(this.buffer=new glacier.BufferObject(this,e,r)).init()?!0:(this.buffer=null,!1)}},glacier.Exception=function Exception(e,t){if(this.message=e,"object"==typeof t)for(var r in t)t.hasOwnProperty(r)&&(this[r]=t[r])},glacier.exception={ContextError:function(e,t,r){glacier.Exception.call(this,"Context error",{error:e,method:t,"class":r})},IndexOutOfRange:function(e,t,r,i){glacier.Exception.call(this,"Index out of range",{index:e,range:t,method:r,"class":i})},InvalidAssignment:function(e,t,r,i){glacier.Exception.call(this,"Invalid assigment",{variable:e,value:t,type:typeof t,expected:r,"class":i})},InvalidParameter:function(e,t,r,i,a){glacier.Exception.call(this,"Invalid parameter",{parameter:e,value:t,type:typeof t,expected:r,method:i,"class":a})},InvalidOption:function(e,t,r,i){glacier.Exception.call(this,"Invalid option",{option:e,value:t,type:typeof t,expected:r,"class":i})},MissingParameter:function(e,t,r){glacier.Exception.call(this,"Missing parameter",{parameter:e,method:t,"class":r})},UndefinedElement:function(e,t,r){glacier.Exception.call(this,"Undefined element",{element:e,method:t,"class":r})}},glacier.Scene=function Scene(e,t){var r=!1,i={},a=new glacier.Context(e,i),n=new glacier.Camera(60,a.width/a.height,1,100);Object.defineProperties(this,{camera:{value:n},context:{value:a},runCallbacks:{value:[]},running:{get:function(){return r},set:function(e){if("boolean"!=typeof e)throw new glacier.exception.InvalidAssignment("running",e,"boolean","Scene");(r=e)?this.run():this.end()}}}),window.addEventListener("resize",function(e){this.camera.aspectRatio=a.width/a.height}.bind(this))},glacier.Scene.prototype={fps:0,end:function(){this.running&&(this.fps=0,this.running=!1)},run:function(){var e,t=this;t.running||(t.running=!0,function sceneRunner(r){if(t.running){var i=(r-e)/1e3;t.fps=(1/i+t.fps)/2||0,e=r,t.runCallbacks.forEach(function(e){"function"==typeof e&&e.call(t,i)}),requestAnimationFrame(sceneRunner)}}())}},glacier.Shader=function Shader(e,t){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","(constructor)","Shader");if(!(t instanceof WebGLProgram))throw new glacier.exception.InvalidParameter("program",t,"WebGLProgram","(constructor)","Shader");Object.defineProperties(this,{attributes:{value:{}},context:{value:e},program:{value:t},uniforms:{value:{}}})},glacier.Shader.prototype={addAttributes:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("attributeArray",e,"string array","addAttributes","Shader");var t;e.forEach(function(e){this.attributes.hasOwnProperty(e)||(t=this.context.gl.getAttribLocation(this.program,e))>=0&&(this.attributes[e]=t)},this)},addUniforms:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("uniformArray",e,"string array","addUniforms","Shader");var t;e.forEach(function(e){this.uniforms.hasOwnProperty(e)||null!==(t=this.context.gl.getUniformLocation(this.program,e))&&(this.uniforms[e]=t)},this)},attribute:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("attribute",e,"string","attribute","Shader");return"number"==typeof(e=this.attributes[e])&&e>=0?e:null},uniform:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("uniform",e,"string","uniform","Shader");return(e=this.uniforms[e])instanceof WebGLUniformLocation?e:null},use:function(){return this.context&&this.program?(this.context.gl.useProgram(this.program),!0):!1}},glacier.ShaderBank=function ShaderBank(e){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","(constructor)","ShaderBank");Object.defineProperties(this,{context:{value:e},shaders:{value:{}}})},glacier.ShaderBank.prototype={init:function(){if(this.context instanceof glacier.Context){var e,t,r,i,a,n,o,s,c,l=/attribute\s+(?:(?:high|medium|low)p\s+)?(?:float|(?:(?:vec|mat)[234]))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)\s*;/g,h=/uniform\s+(?:(?:high|medium|low)p\s+)?(?:bool|int|float|(?:(?:vec|bvec|ivec|mat)[234])|(?:sampler(?:Cube|2D)))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)(\[(?:(?:\d+)|(?:[a-zA-Z_]+[a-zA-Z0-9_]*))\])?\s*;/g,u={},f={},g=this.context.gl,y=glacier.shaders;for(e in y.vertex)if(y.vertex[e]instanceof Array){for(i=y.vertex[e].join("\n"),n={attributes:[],uniforms:[]};a=l.exec(i);)n.attributes.push(a[1]);for(;a=h.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(g.VERTEX_SHADER,i))&&(u[e]=n)}for(t in y.fragment)if(y.fragment[t]instanceof Array){for(i=y.fragment[t].join("\n"),n={uniforms:[]};a=h.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(g.FRAGMENT_SHADER,i))&&(f[t]=n)}for(r in y.programs)if(y.programs.hasOwnProperty(r)&&(e=u[y.programs[r].vertex],t=f[y.programs[r].fragment],e&&t&&(o=e.shader)&&(s=t.shader)&&(c=this.context.createProgram(o,s)))){var p=new glacier.Shader(this.context,c);p.addAttributes(e.attributes),p.addUniforms(e.uniforms),p.addUniforms(t.uniforms),this.shaders[r]=p}return!0}return!1},get:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("shader",e,"string","shader","ShaderBank");return(e=this.shaders[e])instanceof glacier.Shader?e:null}},glacier.Texture=function Texture(e){var t=null;if(Object.defineProperties(this,{onFreeCallbacks:{value:[]},onLoadCallbacks:{value:[]},image:{get:function(){return t},set:function(e){if(e instanceof Image){var r=this;r.image=null,(t=e).onload=function(){return t.width&&t.height?void r.onLoadCallbacks.forEach(function(e){"function"==typeof e&&e(t)}):void(t=null)}}else{if(null!==e)throw new glacier.exception.InvalidAssignment("image",e,"Image or null","Texture");t&&this.onFreeCallbacks.forEach(function(e){"function"==typeof e&&e()}),t=null}}}}),"string"==typeof e)this.load(e);else if(e)throw new glacier.exception.InvalidParameter("source",e,"Image","(constructor)","Texture")},glacier.Texture.prototype={free:function(){this.image=null},load:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("source",e,"string","load","Texture");this.image=new Image,this.image.src=e},onFree:function(e){"function"==typeof e&&this.onFreeCallbacks.push(e)},onLoad:function(e){"function"==typeof e&&this.onLoadCallbacks.push(e)},get height(){return this.image?this.image.height:0},get width(){return this.image?this.image.width:0}},glacier.TypedArray=function TypedArray(e,t){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("type",e,"string","(constructor)","TypedArray");if(t&&"function"!=typeof t)throw new glacier.exception.InvalidParameter("ctor",t,"function","(constructor)","TypedArray");Object.defineProperty(this,"type",{value:{name:e,ctor:t}})},glacier.extend(glacier.TypedArray,Array,{push:function(e){var t,r=arguments;for(t=0;t<r.length;++t){if(!(this.type.ctor&&r[t]instanceof this.type.ctor||typeof r[t]==this.type.name))throw new glacier.exception.InvalidParameter("item",r[t],this.type.name,"push","TypedArray");Array.prototype.push.call(this,r[t])}return this.length},splice:function(e,t,r){var i,a=arguments;for(i=2;i<a.length;++i)if(!(this.type.ctor&&a[i]instanceof this.type.ctor)||typeof a[i]!=this.type.name)throw new glacier.exception.InvalidParameter("item",a[i],this.type.name,"splice","TypedArray");return Array.prototype.splice.apply(this,a)},unshift:function(e){var t,r=arguments;for(t=0;t<r.length;++t){if(!(this.type.ctor&&r[t]instanceof this.type.ctor||typeof r[t]==this.type.name))throw new glacier.exception.InvalidParameter("item",r[t],this.type.name,"unshift","TypedArray");Array.prototype.unshift.call(this,r[t])}return this.length}}),function(){var e={Point:function(e,t,r){this.lat="number"==typeof e?e:0,this.lng="number"==typeof t?t:0,this.alt="number"==typeof r?r:void 0},MultiPoint:function(e){this.points=e instanceof Array?e:[]},LineString:function(e){this.points=e instanceof Array?e:[]},MultiLineString:function(e){this.lineStrings=e instanceof Array?e:[]},Polygon:function(e){this.rings=e instanceof Array?e:[]},MultiPolygon:function(e){this.polygons=e instanceof Array?e:[]},Feature:function(e,t,r){this.id=void 0!==r?r:null,this.geometry=e||null,this.properties="object"==typeof t?t:{}},parsePoint:function(t){if(t instanceof Array){var r={lng:"number"==typeof t[0]?t[0]:void 0,lat:"number"==typeof t[1]?t[1]:void 0,alt:"number"==typeof t[2]?t[2]:void 0};if(void 0!==r.lat&&void 0!==r.lng)return new e.Point(r.lat,r.lng,r.alt);

}return null},parseMultiPoint:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parsePoint(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiPoint(i)}return null},parseLineString:function(t){if(t instanceof Array&&t.length>=2){var r,i=[];for(r in t)(r=e.parsePoint(t[r]))&&i.push(r);if(i.length==t.length)return new e.LineString(i)}return null},parseMultiLineString:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseLineString(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiLineString(i)}return null},parsePolygon:function(t){if(t instanceof Array){var r,i,a=[];for(r in t)(r=e.parseLineString(t[r]))&&(i=r.length)>=4&&r[0].compare(r[i-1])&&a.push(r);if(a.length==t.length)return new e.Polygon(a)}return null},parseMultiPolygon:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parsePolygon(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiPolygon(i)}return null},parseGeometry:function(t){if("object"==typeof t){var r="Point,MultiPoint,LineString,MultiLineString,Polygon,MultiPolygon,GeometryCollection".split(",");if(-1!=r.indexOf(t.type))return e.parseObject(t)}return null},parseGeometryCollection:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseGeometry(t[r]))&&i.push(r);if(i.length==t.length)return i}return null},parseFeature:function(t){if("object"==typeof t&&"Feature"==t.type){var r,i,a=t.id;return null===t.geometry||(r=e.parseGeometry(t.geometry))?null!==(i=t.properties)&&"object"!=typeof i?null:new e.Feature(r,i,a):null}return null},parseFeatureCollection:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseFeature(t[r]))&&i.push(r);if(i.length==t.length)return i}return null},parseObject:function(t){if("object"==typeof t){var r;switch(t.type){case"Point":if(r=e.parsePoint(t.coordinates))return r;break;case"MultiPoint":if(r=e.parseMultiPoint(t.coordinates))return r;break;case"LineString":if(r=e.parseLineString(t.coordinates))return r;break;case"MultiLineString":if(r=e.parseMultiLineString(t.coordinates))return r;break;case"Polygon":if(r=e.parsePolygon(t.coordinates))return r;break;case"MultiPolygon":if(r=e.parseMultiPolygon(t.coordinates))return r;break;case"GeometryCollection":if(r=e.parseGeometryCollection(t.geometries))return r;break;case"Feature":if(r=e.parseFeature(t))return r;break;case"FeatureCollection":if(r=e.parseFeatureCollection(t.features))return r}}return null},parse:function(t){var r;try{r=JSON.parse(t)}catch(i){return null}return e.parseObject(r)}};e.Point.prototype={compare:function(t,r){return t instanceof e.Point&&Math.abs(this.lat-t.lat)<=(r||0)&&Math.abs(this.lng-t.lng)<=(r||0)&&Math.abs(this.alt-t.alt)<=(r||0)}},glacier.geoJSON=e}(),glacier.EPSILON=1e-4,glacier.compare=function(e,t){var r,i=glacier.isArray(e),a=glacier.isArray(t);if(!i||!a){if(i||a){var n=i?e:t,o=i?t:e;for(r=0;r<n.length;++r)if("number"==typeof n[r]&&"number"==typeof o){if(Math.abs(n[r]-o)>=glacier.EPSILON)return!1}else if(n[r]!==o)return!1;return!0}return"number"==typeof e&&"number"==typeof t?Math.abs(e-t)<glacier.EPSILON:e===t}if(e.length==t.length){for(r=0;r<e.length;++r)if("number"==typeof e[r]&&"number"==typeof t[r]){if(Math.abs(e[r]-t[r])>=glacier.EPSILON)return!1}else if(e!==t)return!1;return!0}return!1},glacier.degToRad=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("degrees",e,"number","degToRad");return e*Math.PI/180},glacier.radToDeg=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","radToDeg");return 180*e/Math.PI},glacier.limitAngle=function(e,t,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("angle",e,"number","limitAngle");if("number"!=typeof(t=void 0===t?360:t))throw new glacier.exception.InvalidParameter("max",t,"number","limitAngle");if("number"!=typeof(r=void 0===r?0:r))throw new glacier.exception.InvalidParameter("min",r,"number","limitAngle");for(r>t&&(t=r+(r=t,0));e>t;)e-=t;for(;r>e;)e+=t;return e},glacier.clamp=function(e,t,r){var i=["value","min","max"];return[e,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","clamp")}),t>r&&(r=t+(t=r,0)),Math.max(t,Math.min(r,e))},glacier.shaders={vertex:{generic:["attribute highp vec3 vertex_xyz;","attribute highp vec3 normal_xyz;","attribute highp vec2 texture_uv;","attribute highp vec4 color_rgba;","uniform highp mat4 matrix_mvp;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","varying highp vec3 mvp_normal;","void main()","{","gl_PointSize = 2.0;","gl_Position = matrix_mvp * vec4(vertex_xyz, 1.0);","tex_coords = texture_uv; frag_color = color_rgba;","mvp_normal = normalize(matrix_mvp * vec4(normal_xyz, 1.0)).xyz;","}"]},fragment:{generic:["varying highp vec4 frag_color;","void main()","{","gl_FragColor = frag_color;","}"],globe:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","uniform sampler2D tex_samp_2;","uniform highp vec2 resolution;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","varying highp vec3 mvp_normal;","void main()","{","vec3 lightPos = normalize(vec3(-28.0, 2.0, 12.0));","vec3 normal = normalize(texture2D(tex_samp_2, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(mvp_normal, lightPos), 0.0);","vec3 dayColor = texture2D(tex_samp_0, tex_coords).rgb * diffuse;","vec3 nightColor = texture2D(tex_samp_1, tex_coords).rgb * (1.0 - diffuse);","vec3 normalColor = dayColor * max(dot(normal, lightPos), 0.3);","dayColor = ((1.0 - nightColor) * dayColor) + normalColor;","gl_FragColor = vec4(dayColor + ((1.0 - dayColor) * nightColor * 0.5), 1.0);","}"],normalMapped:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","void main()","{","vec3 lightPos = normalize(vec3(1.0, 1.0, 1.0));","vec4 fragColor = vec4(1.0, 1.0, 1.0, 1.0);","vec3 normal = normalize(texture2D(tex_samp_1, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(normal, lightPos), 0.0);","gl_FragColor = vec4(diffuse * texture2D(tex_samp_0, tex_coords).rgb, 1.0);","}"],textured:["precision highp float;","uniform sampler2D tex_samp_0;","varying highp vec2 tex_coords;","varying highp vec4 frag_color;","void main()","{","gl_FragColor = texture2D(tex_samp_0, tex_coords);","}"]},programs:{generic:{vertex:"generic",fragment:"generic"},globe:{vertex:"generic",fragment:"globe"},normalMapped:{vertex:"generic",fragment:"normalMapped"},textured:{vertex:"generic",fragment:"textured"}}},glacier.Mesh=function Mesh(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},indices:{value:new glacier.TypedArray("number")},normals:{value:new glacier.TypedArray("Vector3",glacier.Vector3)},texCoords:{value:new glacier.TypedArray("Vector2",glacier.Vector2)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}}),[0,1,2,3].forEach(function(e){var t=new glacier.Texture,r="texture"+e;Object.defineProperty(this,r,{get:function(){return t},set:function(e){if("string"==typeof e)t.load(e);else{if(null!==e)throw new glacier.exception.InvalidAssignment(r,e,"string or null","Mesh");t.free()}}})},this)},glacier.extend(glacier.Mesh,glacier.Drawable,{free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.indices.length=0,this.normals.length=0,this.texCoords.length=0,this.vertices.length=0},init:function(e,t){var r=this;return glacier.Drawable.prototype.init.call(this,e,t)&&r.buffer.init(r.vertices,r.indices,r.normals,r.texCoords,r.colors)?(r.buffer.drawMode=e.gl.TRIANGLES,r.buffer.elements=r.indices.length?r.indices.length:r.vertices.length/3,[0,1,2,3].forEach(function(t){r["texture"+t].onLoad(function(i){r.buffer.textures[t]=e.createTexture(i)}),r["texture"+t].onFree(function(){r.buffer.freeTexture(t)})}),!0):(r.buffer=null,!1)}}),glacier.PointCollection=function PointCollection(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}})},glacier.extend(glacier.PointCollection,glacier.Drawable,{addPoint:function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","addPoint","PointCollection");if(t&&!(t instanceof glacier.Color))throw new glacier.exception.InvalidParameter("color",t,"Color","addPoint","PointCollection");this.colors.push(t||glacier.color.WHITE),this.vertices.push(e)},free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.vertices.length=0},init:function(e,t){var r=this;return glacier.Drawable.prototype.init.call(this,e,t)&&r.buffer.init(r.vertices,null,null,null,r.colors)?(r.buffer.drawMode=e.gl.POINTS,r.buffer.elements=r.vertices.length,!0):(r.buffer=null,!1)},addGeoJSON:function(e,t,r){var i=this;glacier.load(e,function(e){function latLngToVec3(e,t,r){var i=glacier.degToRad(t),a=glacier.degToRad(e);return new glacier.Vector3(-r*Math.cos(a)*Math.cos(i),r*Math.sin(a),r*Math.cos(a)*Math.sin(i))}function addObject(t){t instanceof glacier.geoJSON.Point?i.addPoint(latLngToVec3(t.lat,t.lng,1),r||glacier.color.WHITE):t instanceof glacier.geoJSON.MultiPoint?t.points.forEach(function(e){i.addPoint(latLngToVec3(e.lat,e.lng,1),r||glacier.color.WHITE)}):t instanceof glacier.geoJSON.Feature?addObject(t.geometry):t instanceof Array&&e.forEach(function(e){addObject(e)})}(e=glacier.geoJSON.parse(e))&&(addObject(e),"function"==typeof t&&t())})}}),glacier.Matrix33=function Matrix33(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,1,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix33.prototype={assign:function(e){var t,r,i;if(e instanceof glacier.Matrix33)for(i in e.array)this.array[i]=e.array[i];else if(e instanceof glacier.Matrix44)for(r=0;3>r;++r)for(t=0;3>t;++t)this.array[3*r+t]=e.array[4*r+t];else if(glacier.isArray(e)&&9==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33, Matrix44 or array[9]","assign","Matrix33");for(i in this.array)this.array[i]=e}return this},get determinant(){return this.array[0]*(this.array[4]*this.array[8]-this.array[5]*this.array[7])-this.array[1]*(this.array[3]*this.array[8]-this.array[5]*this.array[6])+this.array[2]*(this.array[3]*this.array[7]-this.array[4]*this.array[6])},element:function(e,t){if("number"==typeof t&&"number"==typeof e){if(t>=0&&3>=t&&e>=0&&3>=e)return this.array[3*e+t]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(t||0),"0-9","element","Matrix33")},get inverse(){var e=new glacier.Matrix33(this);return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=new Float32Array([this.array[4]*this.array[8]-this.array[5]*this.array[7],this.array[2]*this.array[7]-this.array[1]*this.array[8],this.array[1]*this.array[5]-this.array[2]*this.array[4],this.array[5]*this.array[6]-this.array[3]*this.array[8],this.array[0]*this.array[8]-this.array[2]*this.array[6],this.array[2]*this.array[3]-this.array[0]*this.array[5],this.array[3]*this.array[7]-this.array[4]*this.array[6],this.array[1]*this.array[6]-this.array[0]*this.array[7],this.array[0]*this.array[4]-this.array[1]*this.array[3]]),t=this.array[0]*e[0]+this.array[1]*e[3]+this.array[2]*e[6];if(glacier.compare(t,0))return!1;t=1/t;for(var r=0;r<e.length;++r)this.array[r]=e[r]*t;return!0},multiply:function(e){var t,r,i,a;if(e instanceof glacier.Matrix33)for(a=new Float32Array(this.array),t=0;3>t;++t)for(r=0;3>r;++r)this.array[3*t+r]=a[3*t+0]*e.array[0+r]+a[3*t+1]*e.array[3+r]+a[3*t+2]*e.array[6+r];else if(e instanceof glacier.Matrix44)this.multiply(new glacier.Matrix33(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33 or Matrix44","multiply","Matrix33");for(i in this.array)this.array[i]*=e}return this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+"], ["+this.array[3].toPrecision(5)+", "+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+"], ["+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+", "+this.array[8].toPrecision(5)+"]]"},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[3],this.array[3]=e,e=this.array[2],this.array[2]=this.array[6],this.array[6]=e,e=this.array[5],this.array[5]=this.array[7],this.array[7]=e,this},get transposed(){var e=new glacier.Matrix33(this);return e.transpose()}},glacier.Matrix44=function Matrix44(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}),e&&this.assign(e)},glacier.Matrix44.prototype={assign:function(e){var t,r,i;if(e instanceof glacier.Matrix33){for(r=0;3>r;++r)for(t=0;3>t;++t)this.array[4*r+t]=e.array[3*r+t];this.array[3]=this.array[7]=this.array[11]=0,this.array[12]=this.array[13]=this.array[14]=0,this.array[16]=1}else if(e instanceof glacier.Matrix44)for(i in e.array)this.array[i]=e.array[i];else if(glacier.isArray(e)&&16==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33, Matrix44 or array[16]","assign","Matrix44");for(i in this.array)this.array[i]=e}return this},get determinant(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],t=this.array[0]*this.array[6]-this.array[2]*this.array[4],r=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],l=this.array[9]*this.array[14]-this.array[10]*this.array[13],h=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14];return e*u-t*h+r*l+i*c-a*s+n*o},element:function(e,t){if("number"==typeof t&&"number"==typeof e){if(t>=0&&4>=t&&e>=0&&4>=e)return this.array[4*e+t]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(t||0),"0-16","element","Matrix44")},frustum:function(e,t,r,i,a,n){var o,s,c,l="left,right,bottom,top,near,far".split(",");return[e,t,r,i,a,n].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(l[t],e,"number","frustum","Matrix44")}),0>=a||0>=n||(o=t-e)<=0||(s=i-r)<=0||(c=n-a)<=0?!1:(this.assign(new glacier.Matrix44([2*a/o,0,0,0,0,2*a/s,0,0,(t+e)/o,(i+r)/s,-(a+n)/c,-1,0,0,-2*a*n/c,0]).multiply(this)),!0)},get inverse(){var e=new glacier.Matrix44(this);return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],t=this.array[0]*this.array[6]-this.array[2]*this.array[4],r=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],l=this.array[9]*this.array[14]-this.array[10]*this.array[13],h=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14],f=e*u-t*h+r*l+i*c-a*s+n*o;if(glacier.compare(f,0))return!1;var g=new Float32Array([this.array[5]*u-this.array[6]*h+this.array[7]*l,-this.array[1]*u+this.array[2]*h-this.array[3]*l,this.array[13]*n-this.array[14]*a+this.array[15]*i,-this.array[9]*n+this.array[10]*a-this.array[11]*i,-this.array[4]*u+this.array[6]*c-this.array[7]*s,this.array[0]*u-this.array[2]*c+this.array[3]*s,-this.array[12]*n+this.array[14]*r-this.array[15]*t,this.array[8]*n-this.array[10]*r+this.array[11]*t,this.array[4]*h-this.array[5]*c+this.array[7]*o,-this.array[0]*h+this.array[1]*c-this.array[3]*o,this.array[12]*a-this.array[13]*r+this.array[15]*e,-this.array[8]*a+this.array[9]*r-this.array[11]*e,-this.array[4]*l+this.array[5]*s-this.array[6]*o,this.array[0]*l-this.array[1]*s+this.array[2]*o,-this.array[12]*i+this.array[13]*t-this.array[14]*e,this.array[8]*i-this.array[9]*t+this.array[10]*e]);f=1/f;for(var y=0;y<g.length;++y)this.array[y]=g[y]*f;return!0},multiply:function(e){var t,r,i,a;if(e instanceof glacier.Matrix44)for(a=new Float32Array(this.array),t=0;4>t;++t)for(r=0;4>r;++r)this.array[4*t+r]=a[4*t+0]*e.array[0+r]+a[4*t+1]*e.array[4+r]+a[4*t+2]*e.array[8+r]+a[4*t+3]*e.array[12+r];else if(e instanceof glacier.Matrix33)this.multiply(new glacier.Matrix44(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33 or Matrix44","multiply","Matrix44");for(i in this.array)this.array[i]*=e}return this},ortho:function(e,t,r,i,a,n){var o="left,right,bottom,top,near,far".split(",");return[e,t,r,i,a,n].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[t],e,"number","ortho","Matrix44")}),(dX=t-e)&&(dY=i-r)&&(dZ=n-a)?(this.assign(new glacier.Matrix44([2/dX,0,0,0,0,2/dY,0,0,0,0,-2/dZ,0,-(t+e)/dX,-(i+r)/dY,-(a+n)/dZ,1]).multiply(this)),!0):!1},perspective:function(e,t,r,i){var a,n,o="verticalViewAngle,aspectRatio,near,far".split(","),s=new glacier.Matrix44;return[e,t,r,i].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[t],e,"number","perspective","Matrix44")}),0>=r||0>=i?!1:(a=Math.tan(e/360*Math.PI)*r,n=a*t,s.frustum(-n,n,-a,a,r,i)?(this.assign(s.multiply(this)),!0):!1)},rotate:function(e,t,r,i){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotate","Matrix44");if(t instanceof glacier.Vector3)return this.rotate(e,t.x,t.y,t.z);var a,n,o,s,c=["x","y","z"],l=t;return[l,r,i].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(c[t],e,"number","rotate","Matrix44")}),s=1-(a=Math.cos(e)),n=Math.sin(e),isNaN(o=Math.sqrt(l*l+r*r+i*i))||(l/=o,r/=o,i/=o,this.assign(new glacier.Matrix44([s*l*l+a,s*l*r-i*n,s*l*i+r*n,0,s*r*l+i*n,s*r*r+a,s*r*i-l*n,0,s*i*l-r*n,s*i*r+l*n,s*i*i+a,0,0,0,0,1]).multiply(this))),this},scale:function(e,t,r){if(e instanceof glacier.Vector3)return this.scale(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","scale","Matrix44")}),this.array[0]*=a,this.array[4]*=t,this.array[8]*=r,this.array[1]*=a,this.array[5]*=t,this.array[9]*=r,this.array[2]*=a,this.array[6]*=t,this.array[10]*=r,this.array[3]*=a,this.array[7]*=t,this.array[11]*=r,this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+", "+this.array[3].toPrecision(5)+"], ["+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+", "+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+"], ["+this.array[8].toPrecision(5)+", "+this.array[9].toPrecision(5)+", "+this.array[10].toPrecision(5)+", "+this.array[11].toPrecision(5)+"], ["+this.array[12].toPrecision(5)+", "+this.array[13].toPrecision(5)+", "+this.array[14].toPrecision(5)+", "+this.array[15].toPrecision(5)+"]]"},translate:function(e,t,r){if(e instanceof glacier.Vector3)return this.translate(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","translate","Matrix44")}),this.array[12]+=this.array[0]*a+this.array[4]*t+this.array[8]*r,this.array[13]+=this.array[1]*a+this.array[5]*t+this.array[9]*r,this.array[14]+=this.array[2]*a+this.array[6]*t+this.array[10]*r,this.array[15]+=this.array[3]*a+this.array[7]*t+this.array[11]*r,this},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[4],this.array[4]=e,e=this.array[2],this.array[2]=this.array[8],this.array[8]=e,e=this.array[3],this.array[3]=this.array[12],this.array[12]=e,e=this.array[6],this.array[6]=this.array[9],this.array[9]=e,e=this.array[7],this.array[7]=this.array[13],this.array[13]=e,e=this.array[11],this.array[11]=this.array[14],this.array[14]=e,this},get transposed(){var e=new glacier.Matrix44(this);return e.transpose()}},glacier.Ray=function Ray(e,t){glacier.addTypedProperty(this,["a","start"],e instanceof glacier.Vector3?e:new glacier.Vector3(0),glacier.Vector3),glacier.addTypedProperty(this,["b","direction"],t instanceof glacier.Vector3?t:new glacier.Vector3(0),glacier.Vector3),e instanceof glacier.Ray&&this.assign(e)},glacier.Ray.prototype={get array(){return new Float32Array([this.a,this.b])},assign:function(e,t){if(e instanceof glacier.Ray)return this.assign(e.a,e.b);var r=["start","direction"];return[e,t].forEach(function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter(r[t],e,"Vector3","assign","Ray")}),this.a=e,this.b=t,this},deviation:function(e){if(e instanceof glacier.Ray)return this.b.dot(e.b);throw new glacier.exception.InvalidParameter("ray",e,"Ray","deviation","Ray")},toString:function(){return"Ray("+this.a.toString()+" + "+this.b.normalized.toString()+")"}},glacier.Vector2=function Vector2(e,t){glacier.addTypedProperty(this,["x","u"],"number"==typeof e?e:0),glacier.addTypedProperty(this,["y","v"],"number"==typeof t?t:0),e instanceof glacier.Vector2&&this.assign(e)},glacier.Vector2.prototype={add:function(e){if(e instanceof glacier.Vector2)this.x+=e.x,this.y+=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","add","Vector2");this.x+=e,this.y+=e}return this},get array(){return new Float32Array([this.x,this.y])},assign:function(e,t){if(e instanceof glacier.Vector2)return this.assign(e.x,e.y);var r=["x","y"],i=e;return[i,t].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(r[t],e,"number","assign","Vector2")}),this.x=i,this.y=t,this},distance:function(e){var t=this.x-e.x,r=this.y-e.y;return Math.sqrt(t*t+r*r)},divide:function(e){if(e instanceof glacier.Vector2)this.x/=e.x,this.y/=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","divide","Vector2");this.x/=e,this.y/=e}return this},dot:function(e){return this.x*e.x+this.y*e.y},get length(){return Math.sqrt(this.x*this.x+this.y*this.y)},multiply:function(e){if(e instanceof glacier.Vector2)this.x*=e.x,this.y*=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","multiply","Vector2");this.x*=e,this.y*=e}return this},normalize:function(){var e=1/this.length;return this.x*=e,this.y*=e,this},get normalized(){return new glacier.Vector2(this).normalize()},rotate:function(e){var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.y*r,a=this.x*r+this.y*t;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector2)this.x-=e.x,this.y-=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","subtract","Vector2");this.x-=e,this.y-=e}return this},toString:function(){return"("+this.x+", "+this.y+")"}},glacier.Vector3=function Vector3(e,t,r){glacier.addTypedProperty(this,["x","u"],"number"==typeof e?e:0),glacier.addTypedProperty(this,["y","v"],"number"==typeof t?t:0),glacier.addTypedProperty(this,["z","w"],"number"==typeof r?r:0),e instanceof glacier.Vector3&&this.assign(e)},glacier.Vector3.prototype={add:function(e){if(e instanceof glacier.Vector3)this.x+=e.x,this.y+=e.y,this.z+=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector3","add","Vector3");this.x+=e,this.y+=e,this.z+=e}return this},angle:function(e){var t=Math.acos(this.dot(e)/(this.length*e.length));return isNaN(t)?0:t},get array(){return new Float32Array([this.x,this.y,this.z])},assign:function(e,t,r){if(e instanceof glacier.Vector3)return this.assign(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","assign","Vector3")}),this.x=a,this.y=t,this.z=r,this},cross:function(e){return new glacier.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},distance:function(e){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+r*r+i*i)},divide:function(e){if(e instanceof glacier.Vector3)this.x/=e.x,this.y/=e.y,this.z/=e.z;else if("number"==typeof e)this.x/=e,this.y/=e,this.z/=e;else if(e instanceof glacier.Matrix33)this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2);else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector3, Matrix33 or Matrix44","divide","Vector3");this.x=this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2)+e.element(0,3),this.y=this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2)+e.element(1,3),this.z=this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2)+e.element(2,3)}return this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},multiply:function(e){if(e instanceof glacier.Vector3)this.x*=e.x,this.y*=e.y,this.z*=e.z;else if("number"==typeof e)this.x*=e,this.y*=e,this.z*=e;else if(e instanceof glacier.Matrix33)this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2);else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector3, Matrix33 or Matrix44","multiply","Vector3");this.x=this.x*e.element(0,0)+this.y*e.element(0,1)+this.z*e.element(0,2)+e.element(0,3),this.y=this.x*e.element(1,0)+this.y*e.element(1,1)+this.z*e.element(1,2)+e.element(1,3),this.z=this.x*e.element(2,0)+this.y*e.element(2,1)+this.z*e.element(2,2)+e.element(2,3)}return this},normalize:function(){var e=1/this.length;return this.x*=e,this.y*=e,this.z*=e,this},get normalized(){return new glacier.Vector3(this).normalize()},rotateX:function(e){var t=Math.cos(e),r=Math.sin(e),i=this.y*t-this.z*r,a=this.y*r+this.z*t;return this.y=i,this.z=a,this},rotateY:function(e){var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.z*r,a=this.x*r+this.z*t;return this.x=i,this.z=a,this},rotateZ:function(e){var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.y*r,a=this.x*r+this.y*t;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector3)this.x-=e.x,this.y-=e.y,this.z-=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector3","subtract","Vector3");this.x-=e,this.y-=e,this.z-=e}return this},toString:function(){return"("+this.x+", "+this.y+", "+this.z+")"}},glacier.GlobeScene=function GlobeScene(e,t){glacier.Scene.call(this,e,t),t=glacier.parseOptions(t,{latitudes:{number:45,gt:2},longitudes:{number:90,gt:2},radius:{number:1,gt:0},color:{Color:glacier.color.BLUE,"class":glacier.Color},rotationSpeed:{number:0},obliquity:{number:0},texture:[null,"string"],nightTexture:[null,"string"],normalMap:[null,"string"],mouseControl:{"boolean":!0}},"GlobeScene");var r=0;Object.defineProperties(this,{base:{get:function(){return this.layers[0]}},data:{value:{}},layers:{value:new glacier.TypedArray("Sphere",glacier.Sphere)},obliquity:{get:function(){return t.obliquity},set:function(e){"number"==typeof e&&(t.obliquity=e)}},rotation:{get:function(){return r},set:function(e){"number"==typeof e&&(r=e)}}}),this.layers.push(new glacier.Sphere(t.latitudes,t.longitudes,t.radius)),this.base.texture0=t.texture,this.base.texture1=t.nightTexture,this.base.texture2=t.normalMap,this.base.init(this.context,{shader:"globe"}),this.camera.clipNear=.01,this.camera.clipFar=100,this.context.projection=this.camera.matrix,t.mouseControl&&this.camera.bindMouse(e),this.runCallbacks.push(function(){var e,t=this.context.gl;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.context.clear(),this.base.matrix=new glacier.Matrix44,this.base.matrix.rotate(glacier.degToRad(-this.obliquity),0,0,1),this.base.matrix.rotate(glacier.degToRad(this.rotation),0,1,0),this.base.draw();for(e in this.data)this.data[e]instanceof glacier.Drawable&&(this.data[e].matrix.assign(this.base.matrix),this.data[e].draw())})},glacier.extend(glacier.GlobeScene,glacier.Scene,{addData:function(e,t){var r=this,i=[];if("string"!=typeof e)throw new glacier.exception.InvalidParameter("geoJsonURL",e,"string","addData","GlobeScene");glacier.load(e,function(e){function addGeometry(e){e instanceof glacier.geoJSON.Point?(r.data.points instanceof glacier.PointCollection||(r.data.points=new glacier.PointCollection),r.data.points.addPoint(r.latLngToWorld(e.lat,e.lng,e.alt),t instanceof glacier.Color?t:glacier.color.WHITE),-1==i.indexOf("points")&&i.push("points")):e instanceof glacier.geoJSON.MultiPoint?e.points.forEach(function(e){addGeometry(e)}):e instanceof glacier.geoJSON.Feature?addGeometry(e.geometry):e instanceof Array&&e.forEach(function(e){addGeometry(e)})}(e=glacier.geoJSON.parse(e))&&(addGeometry(e),i.forEach(function(e){r.data[e]instanceof glacier.Drawable&&r.data[e].init(r.context)}))})},latLngToWorld:function(e,t,r){var i=glacier.degToRad(t),a=glacier.degToRad(e);return new glacier.Vector3(-this.base.radius*Math.cos(a)*Math.cos(i),this.base.radius*Math.sin(a),this.base.radius*Math.cos(a)*Math.sin(i))}}),glacier.Sphere=function Sphere(e,t,r){glacier.Mesh.call(this),r="number"==typeof r&&r>=0?r:0,Object.defineProperty(this,"radius",{get:function(){return r},set:function(e){if(!("number"==typeof e&&e>=0))throw new glacier.exception.InvalidAssignment("radius",e,"positive number","Sphere");e>0?this.vertices.forEach(function(t){t=t/r*e}):this.indices.length&&this.free(),r=e}}),e&&t&&this.generate(e,t,r||1)},glacier.extend(glacier.Sphere,glacier.Mesh,{free:function(){glacier.Mesh.prototype.free.call(this),this.radius=0},generate:function(e,t,r){if("number"!=typeof e||3>e)throw new glacier.exception.InvalidParameter("latitudes",e,"number (>= 3)","generate","Sphere");if(e=Math.round(Math.abs(e)),"number"!=typeof t||3>t)throw new glacier.exception.InvalidParameter("longitudes",t,"number (>= 3)","generate","Sphere");if(t=Math.round(Math.abs(t)),void 0===r)r=1;else if("number"!=typeof r||0>=r)throw new glacier.exception.InvalidParameter("radius",r,"number (> 0.0)","generate","Sphere");this.free(),this.radius=r;var i,a,n,o,s,c,l,h,u,f,g,y,p;for(i=0;e>=i;++i)for(n=i*Math.PI/e,o=Math.sin(n),s=Math.cos(n),a=0;t>=a;++a)c=2*a*Math.PI/t,l=Math.sin(c),h=Math.cos(c),u=h*o,f=s,g=l*o,y=1-a/t,p=i/e,this.vertices.push(new glacier.Vector3(r*u,r*f,r*g)),this.normals.push(new glacier.Vector3(u,f,g)),this.texCoords.push(new glacier.Vector2(y,p));for(i=0;e>i;++i)for(a=0;t>a;++a)u=i*(t+1)+a,f=u+t+1,this.indices.push(u,f,u+1),this.indices.push(f,f+1,u+1);return!0}});