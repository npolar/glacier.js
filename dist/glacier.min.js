var glacier={VERSION:"0.3.0",AUTHORS:["remi@npolar.no"]};"object"==typeof module&&(module.exports=glacier),glacier.load=function(e,t){var r,i="function"==typeof t?!0:!1;try{r=new XMLHttpRequest}catch(a){return!1}i&&(r.onreadystatechange=function(){4!=r.readyState||200!=r.status&&0!==r.status||t(r.responseText)});try{r.open("GET",e,i),r.overrideMimeType("text/plain"),r.send()}catch(a){return!1}return i?!0:r.responseText},glacier.isArray=function(e,t){var r,i;if([Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,Float32Array,Float64Array].forEach(function(t){!i&&e instanceof t&&(i=!0)}),i&&t)if("function"==typeof t){for(r=0;r<e.length;++r)if(!(e[r]instanceof t))return!1}else if("string"==typeof t)for(r=0;r<e.length;++r)if(typeof e[r]!=t)return!1;return!!i},glacier.extend=function(e,t){var r,i,a,n,o=arguments,s=[];for(r=1;r<o.length;++r)if(o[r]instanceof Object)if(n=s.push(function(){})-1){if(s[n].prototype=Object.create(s[n-1].prototype),a=o[r].prototype)for(i in a)a.hasOwnProperty(i)&&(s[n].prototype[i]=a[i]);else if(a=o[r])for(i in a)a.hasOwnProperty(i)&&(s[n].prototype[i]=a[i])}else s[n].prototype=Object.create(o[r].prototype||o[r]);a=e.prototype,e.prototype=Object.create(s.pop().prototype);for(r in a)a.hasOwnProperty(r)&&(e.prototype[r]=a[r]);return e},glacier.addTypedProperty=function(e,t,r,i){function typedProperty(t){Object.defineProperty(e,t,{get:function(){return r},set:function(e){"function"!=typeof i||e instanceof i?typeof e!=typeof r?glacier.error.invalidAssignment(t,e,typeof r):e!==r&&(r=e,n&&n(r)):glacier.error.invalidAssignment(t,e,i.name)}})}t=t instanceof Array?t:[t];var a,n;for(a in t)typedProperty(t[a]);return{onChange:function(e){if("function"!=typeof e)throw new glacier.exception.InvalidParameter("callback",e,"function","onChange");n=e}}},glacier.parseOptions=function(e,t,r){function getDefault(e){if(e instanceof Array){if(void 0!==e[0]&&null!==e[0]&&"object"==typeof e[0])return getDefault(e[0])}else if("object"==typeof e)for(a in e)if(e.hasOwnProperty(a)&&-1==s.indexOf(a))return e[a];return null}function getOverride(e,t,i){if(t instanceof Array){var a,o,c,l,h=[];for(a in t)if(null===t[a]){if(h.push("null"),null===e||void 0===e)return e}else if("object"==typeof t[a]){for(c in t[a])if(t[a].hasOwnProperty(c)&&-1==s.indexOf(c)&&(h.push(c),null!==(l=getOverride(t[a]))))return l}else if("string"==typeof t[a]&&(h.push(t[a]),typeof e==t[a]))return e;throw h=h.join(", "),o=h.lastIndexOf(", "),h=o>=0?h.substr(0,o)+" or"+h.substr(o+1):h,new glacier.exception.InvalidOption(i,e,h,r)}if("object"==typeof t)for(n in t)if(t.hasOwnProperty(n)&&-1==s.indexOf(n)){if("function"==typeof t["class"]){if(e instanceof t["class"])return e;throw new glacier.exception.InvalidOption(i,e,n,r)}if(typeof e==n){if(void 0!==t.not&&e===t.not)throw new glacier.exception.InvalidOption(i,e,n+" (except "+t.not+")",r);if(void 0!==t.gt&&e<=t.gt)throw new glacier.exception.InvalidOption(i,e,n+" (greater than "+t.gt+")",r);if(void 0!==t.lt&&e>=t.lt)throw new glacier.exception.InvalidOption(i,e,n+" (less than "+t.gt+")",r);return e}throw new glacier.exception.InvalidOption(i,e,n,r)}return null}var i,a,n,o={},s="gt,lt,class,not".split(",");if(e&&"object"!=typeof e)throw new glacier.exception.InvalidParameter("options",t,"object","parseOptions");if(e||(e={}),"object"!=typeof t)throw new glacier.exception.InvalidParameter("defaults",t,"object","parseOptions");for(i in t)t.hasOwnProperty(i)&&(o[i]=getDefault(t[i]),e.hasOwnProperty(i)&&(o[i]=getOverride(e[i],t[i],i)));return o},glacier.error={invalidAssignment:function(e,t,r,i){console.error("Invalid assignment of "+(i?i+".":"")+e+": "+t+" ("+typeof t+"), expected "+r)}},function(){function generateUID(){var r,i="";for(r=0;32>r;++r)i+=t[Math.floor(Math.random()*t.length)];return-1==e.indexOf(i)?(e.push(i),i):generateUID()}var e=[],t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";glacier.generateUID=generateUID}(),glacier.BufferObject=function BufferObject(e,t,r){if(!(e instanceof glacier.Drawable))throw new glacier.exception.InvalidParameter("drawable",e,"Drawable","(constructor)","BufferObject");if(!(t instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",t,"Context","(constructor)","BufferObject");if(!(r instanceof glacier.Shader))throw new glacier.exception.InvalidParameter("shader",r,"Shader","(constructor)","BufferObject");var i=t.gl,a=[i.POINTS,i.LINE_STRIP,i.LINE_LOOP,i.LINES,i.TRIANGLE_STRIP,i.TRIANGLE_FAN,i.TRIANGLES],n=0,o=0;Object.defineProperties(this,{color:{value:glacier.color.WHITE},buffers:{value:{}},context:{value:t},parent:{value:e},textures:{value:[]},elements:{get:function(){return o},set:function(e){"number"==typeof e&&e>=0?o=Math.round(e):glacier.error.invalidAssignment("elements",e,"positive integer","BufferObject")}},drawMode:{get:function(){return n},set:function(e){if(-1!=a.indexOf(e))n=e;else{a.sort(function(e,t){return e-t});var t=a.join(", "),r=t.lastIndexOf(", ");t=r>=0?t.substr(0,r)+" or"+t.substr(r+1):t,glacier.error.invalidAssignment("drawMode",e,t,"BufferObject")}}},shader:{get:function(){return r},set:function(e){if(e instanceof glacier.Shader)r=e;else if("string"==typeof e){var i=t.shaders.get(e);i instanceof glacier.Shader?r=i:glacier.error.invalidAssignment("shader",e,"valid shader name as string","BufferObject")}else glacier.error.invalidAssignment("shader",r,"Shader","BufferObject")}}})},glacier.BufferObject.MAX_TEXTURE_COUNT=4,glacier.BufferObject.prototype={draw:function(){if(this.context&&this.shader&&this.elements){var e,t,r,i,a=(Float32Array.BYTES_PER_ELEMENT,this.context.gl);for(this.shader.use(),null!==(e=this.shader.attribute("vertex_position"))&&(this.buffers.vertex?(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertex),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,3,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(e)),null!==(e=this.shader.attribute("vertex_normal"))&&(this.buffers.normal?(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.normal),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,3,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(e)),null!==(e=this.shader.attribute("vertex_uv"))&&(this.buffers.texCoord?(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.texCoord),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,2,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(e)),null!==(e=this.shader.attribute("vertex_color"))&&(this.buffers.color?(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.color),a.enableVertexAttribArray(e),a.vertexAttribPointer(e,4,a.FLOAT,!1,0,0)):a.disableVertexAttribArray(e)),(t=this.shader.uniform("color_rgba"))&&a.uniform4fv(t,e&&this.buffers.color?glacier.color.BLACK.array:this.color.array),i=0;i<glacier.BufferObject.MAX_TEXTURE_COUNT;++i)(t=this.shader.uniform("tex_samp_"+i))&&(a.activeTexture(a.TEXTURE0+i),a.bindTexture(a.TEXTURE_2D,this.textures[i]instanceof WebGLTexture?this.textures[i]:null),a.uniform1i(t,i));(t=this.shader.uniform("matrix_mvp"))&&(r=new glacier.Matrix44(this.parent.matrix),this.context.view instanceof glacier.Matrix44&&r.multiply(this.context.view),this.context.projection instanceof glacier.Matrix44&&r.multiply(this.context.projection),a.uniformMatrix4fv(t,!1,r.array)),(t=this.shader.uniform("resolution"))&&a.uniform2f(t,this.context.width,this.context.height),this.buffers.index?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.buffers.index),a.drawElements(this.drawMode,this.elements,a.UNSIGNED_SHORT,0)):this.buffers.vertex&&(a.bindBuffer(a.ARRAY_BUFFER,this.buffers.vertex),a.drawArrays(this.drawMode,0,this.elements)),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindTexture(a.TEXTURE_2D,null)}},init:function(e,t,r,i,a){if(this.context&&this.shader){var n,o=this.context.gl;if(glacier.isArray(e,glacier.Vector3))e.length&&(n=[],e.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.vertex=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(e)throw new glacier.exception.InvalidParameter("vertices",e,"Vector3 array","init","BufferObject");if(glacier.isArray(t,"number"))t.length&&(n=[],t.forEach(function(e){n.push(e)}),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,this.buffers.index=o.createBuffer()),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.STATIC_DRAW));else if(t)throw new glacier.exception.InvalidParameter("indices",t,"number array","init","BufferObject");if(glacier.isArray(r,glacier.Vector3))r.length&&(n=[],r.forEach(function(e){n.push(e.x,e.y,e.z)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.normal=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(r)throw new glacier.exception.InvalidParameter("normals",r,"Vector3 array","init","BufferObject");if(glacier.isArray(i,glacier.Vector2))i.length&&(n=[],i.forEach(function(e){n.push(e.u,e.v)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.texCoord=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(i)throw new glacier.exception.InvalidParameter("texCoords",i,"Vector2 array","init","BufferObject");if(glacier.isArray(a,glacier.Color))a.length&&(n=[],a.forEach(function(e){n.push(e.r/255,e.g/255,e.b/255,e.a)}),o.bindBuffer(o.ARRAY_BUFFER,this.buffers.color=o.createBuffer()),o.bufferData(o.ARRAY_BUFFER,new Float32Array(n),o.STATIC_DRAW));else if(a instanceof glacier.Color)this.color.assign(a);else if(a)throw new glacier.exception.InvalidParameter("colors",a,"Color array","init","BufferObject");return o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),!0}return!1},free:function(){if(this.context){var e;for(e in this.buffers)this.buffers.hasOwnProperty(e)&&(this.context.gl.deleteBuffer(this.buffers[e]),delete this.buffers[e]);for(e=0;e<glacier.BufferObject.MAX_TEXTURE_COUNT;++e)this.freeTexture(e)}},freeTexture:function(e){this.context&&this.textures[e]&&(this.textures[e]instanceof WebGLTexture&&this.context.gl.deleteTexture(this.textures[e]),this.textures[e]=null)}},glacier.Camera=function Camera(e,t,r,i){var a=["fieldOfView","aspectRatio","clipNear","clipFar"];r=r||.1,i=i||100,[e,t,r,i].forEach(function(e,t){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter(a[t],e,"positive number","(constructor)","Camera");Object.defineProperty(this,a[t],{get:function(){return e},set:function(r){"number"==typeof r&&r>0?(e=r,this.projection.assignIdentity(),this.projection.perspective(this.fieldOfView,this.aspectRatio,this.clipNear,this.clipFar)):glacier.error.invalidAssignment(a[t],r,"positive number","Camera")}})},this),glacier.addTypedProperty(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.addTypedProperty(this,"position",new glacier.Vector3(0,1,1),glacier.Vector3),glacier.addTypedProperty(this,"projection",new glacier.Matrix44,glacier.Matrix44),glacier.addTypedProperty(this,"target",new glacier.Vector3(0,0,0),glacier.Vector3),this.update()},glacier.Camera.prototype={follow:function(e,t,r){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("target",e,"Vector3","follow","Camera");if(!(t instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("angle",e,"Vector2","follow","Camera");if("number"!=typeof r||0>=r)throw new glacier.exception.InvalidParameter("distance",r,"positive number","follow","Camera");var i={},a={},n=new glacier.Vector2(glacier.limitAngle(t.x),glacier.limitAngle(t.y));i.hyp=r,i.opp=i.hyp*Math.sin(glacier.degToRad(n.y)),i.adj=i.hyp*Math.cos(glacier.degToRad(n.y)),a.hyp=i.adj,a.opp=a.hyp*Math.sin(glacier.degToRad(n.x)),a.adj=a.hyp*Math.cos(glacier.degToRad(n.x)),this.target.assign(e),this.position.x=e.x-a.opp,this.position.y=e.y+i.opp,this.position.z=e.z-a.adj,this.update()},update:function(){var e,t,r=new glacier.Vector3(0,1,0);(e=new glacier.Vector3(this.position).subtract(this.target)).length&&e.normalize(),(t=r.cross(e)).length&&t.normalize(),(r=e.cross(t)).length&&r.normalize(),this.matrix.assign([t.x,r.x,e.x,0,t.y,r.y,e.y,0,t.z,r.z,e.z,0,0,0,0,1]).translate(-this.position.x,-this.position.y,-this.position.z)}},glacier.Color=function Color(e){var t,r,i,a=255;if(Object.defineProperties(this,{r:{get:function(){return a>>24&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?a=((255&e)<<24)+(16777215&a)>>>0:glacier.error.invalidAssignment("r",e,"number between 0 and 255","Color")}},g:{get:function(){return a>>16&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?a=((255&e)<<16)+(4278255615&a)>>>0:glacier.error.invalidAssignment("g",e,"number between 0 and 255","Color")}},b:{get:function(){return a>>8&255},set:function(e){"number"==typeof e&&e>=0&&255>=e?a=((255&e)<<8)+(4294902015&a)>>>0:glacier.error.invalidAssignment("b",e,"number between 0 and 255","Color")}},a:{get:function(){return(a>>0&255)/255},set:function(e){"number"==typeof e&&e>=0&&1>=e?a=((255*e&255)<<0)+(4294967040&a)>>>0:glacier.error.invalidAssignment("a",e,"number between 0.0 and 1.0","Color")}},rgb:{get:function(){return a>>8&16777215},set:function(e){if("number"==typeof e&&e>=0&&16777215>=e)a=((16777215&e)<<8)+(255&a)>>>0;else if(glacier.isArray(e)){for(t=0,i=[];t<e.length&&("number"==typeof e[t]&&e[t]>=0&&e[t]<=1);++t)i.push(e[t]);3==i.length?this.rgb=(255*i[0]<<16)+(255*i[1]<<8)+255*i[2]>>>0:glacier.error.invalidAssignment("rgb","["+e.join(", ")+"]","array[3] of numbers between 0.0 and 1.0","Color")}else e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,glacier.error.invalidAssignment("rgb",e,"RGB as 24-bits integer or array[3] of numbers between 0.0 and 1.0","Color")}},rgba:{get:function(){return a},set:function(e){if("number"==typeof e&&e>=0&&4294967295>=e)a=(4294967295&e)>>>0;else if(glacier.isArray(e)){for(t=0,i=[];t<e.length&&("number"==typeof e[t]&&e[t]>=0&&e[t]<=1);++t)i.push(e[t]);4==i.length?this.rgba=(255*i[0]<<24)+(255*i[1]<<16)+(255*i[2]<<8)+255*i[3]>>>0:glacier.error.invalidAssignment("rgba","["+e.join(", ")+"]","array[4] of numbers between 0.0 and 1.0","Color")}else e="number"==typeof e?"0x"+e.toString(16).toUpperCase():e,glacier.error.invalidAssignment("rgba",rgb,"RGBA as 32-bits integer or array[4] of numbers between 0.0 and 1.0","Color")}}}),e instanceof glacier.Color)this.rgba=e.rgba;else if(glacier.isArray(e))this.rgba=e;else switch((r=arguments).length){case 1:this.rgb=r[0];break;case 2:this.rgb=r[0],this.a=r[1];break;case 3:case 4:for(t=0,i=[];t<r.length;++t){if("number"!=typeof r[t])throw new glacier.exception.InvalidParameter(r[t],r[t],"number","(constructor)","Color");i.push(r[t]/(3>t?255:1))}for(;i.length<4;)i.push(1);this.rgba=i}},glacier.Color.prototype={get array(){return new Float32Array([this.r/255,this.g/255,this.b/255,this.a])},assign:function(e,t,r,i){if(e instanceof glacier.Color)this.rgba=e.rgba;else{var a=["r","g","b"],n=e;if([n,t,r].forEach(function(e,t){if("number"!=typeof e||0>e||e>255)throw new glacier.exception.InvalidParameter(a[t],e,"number between 0 and 255","assign","Color")}),(i||0===i)&&("number"!=typeof i||0>i||i>1))throw new glacier.exception.InvalidParameter("a",i,"number between 0.0 and 1.0","assign","Color");this.r=n,this.g=t,this.b=r,this.a=i||0===i?i:1}return this},get copy(){return new glacier.Color(this)},invert:function(){return this.rgb=16777215-this.rgb,this},get inverted(){return this.copy.invert()},toHtmlString:function(e){var t=this.copy;return t.a<1&&(e=e instanceof glacier.Color?e:glacier.color.WHITE,t.r=t.r*t.a+(1-t.a)*e.r,t.g=t.g*t.a+(1-t.a)*e.g,t.b=t.b*t.a+(1-t.a)*e.b,t.a=1),"#"+("0"+t.r.toString(16)).slice(-2)+("0"+t.g.toString(16)).slice(-2)+("0"+t.b.toString(16)).slice(-2)},toString:function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(", ")+")"}},glacier.color={get WHITE(){return new glacier.Color(16777215,1)},get SILVER(){return new glacier.Color(12632256,1)},get GRAY(){return new glacier.Color(8421504,1)},get BLACK(){return new glacier.Color(0,1)},get RED(){return new glacier.Color(16711680,1)},get MAROON(){return new glacier.Color(8388608,1)},get YELLOW(){return new glacier.Color(16776960,1)},get OLIVE(){return new glacier.Color(8421376,1)},get LIME(){return new glacier.Color(65280,1)},get GREEN(){return new glacier.Color(32768,1)},get AQUA(){return new glacier.Color(65535,1)},get TEAL(){return new glacier.Color(32896,1)},get BLUE(){return new glacier.Color(255,1)},get NAVY(){return new glacier.Color(128,1)},get FUCHSIA(){return new glacier.Color(16711935,1)},get PURPLE(){return new glacier.Color(8388736,1)}},glacier.Context=function Context(e,t){var r,i,a,n=null,o=null;if(!(e instanceof HTMLCanvasElement)){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("canvas",e,"HTMLCanvasElement or string","(constructor)","Context");if(!((a=document.getElementById(e))instanceof HTMLCanvasElement))throw new glacier.exception.InvalidParameter("canvas",e,"string as HTMLCanvasElement ID","(constructor)","Context");e=a}if(t&&"object"!=typeof t)throw new glacier.exception.InvalidParameter("options",e,"object","(constructor)","Context");if(t||(t={}),["webgl","experimental-webgl"].forEach(function(t){i||(i=e.getContext(t))}),!(window.WebGLRenderingContext&&i instanceof WebGLRenderingContext))throw"WebGL is not supported";Object.defineProperties(this,{background:{get:function(){return r},set:function(e){e instanceof glacier.Color?(r=e,i.clearColor(e.r/255,e.g/255,e.b/255,e.a),i.clear(i.COLOR_BUFFER_BIT)):glacier.error.invalidAssignment("background",e,"Color","Context")}},canvas:{value:e},gl:{value:i},height:{get:function(){return this.canvas.height},set:function(e){"number"==typeof e&&e>0?this.resize(width,e):glacier.error.invalidAssignment("height",e,"positive number","Context")}},projection:{get:function(){return n},set:function(e){e instanceof glacier.Matrix44?n=e:null===e?n=null:glacier.error.invalidAssignment("projection",e,"Matrix44 or null","Context")}},shaders:{value:new glacier.ShaderBank(this)},view:{get:function(){return o},set:function(e){e instanceof glacier.Matrix44?o=e:null===e?o=null:glacier.error.invalidAssignment("view",e,"Matrix44 or null","Context")}},width:{get:function(){return this.canvas.width},set:function(e){"number"==typeof e&&e>0?this.resize(e,height):glacier.error.invalidAssignment("width",e,"positive number","Context")}}}),this.background=glacier.color.BLACK,this.resize(e.offsetWidth,e.offsetHeight),this.shaders.init(),window.addEventListener("resize",function(t){(e.width!=e.offsetWidth||e.height!=e.offsetHeight)&&this.resize(e.offsetWidth,e.offsetHeight)}.bind(this))},glacier.Context.prototype={clear:function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},draw:function(e){e instanceof glacier.Drawable&&e.draw()},init:function(e,t){if(e instanceof glacier.Drawable)return e.init(this,t);throw new glacier.exception.InvalidParameter("drawable",e,"Drawable","init","Context")},resize:function(e,t){if("number"!=typeof e||0>=e)throw new glacier.exception.InvalidParameter("width",e,"positive number","resize","Context");if("number"!=typeof t||0>=t)throw new glacier.exception.InvalidParameter("height",t,"positive number","resize","Context");this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t)},createProgram:function(e,t){if(!(e instanceof WebGLShader))throw new glacier.exception.InvalidParameter("vertShader",e,"WebGLShader","createProgram","Context");if(!(t instanceof WebGLShader))throw new glacier.exception.InvalidParameter("fragShader",t,"WebGLShader","createProgram","Context");var r=this.gl,i=r.createProgram();return r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),r.getProgramParameter(i,r.LINK_STATUS)?i:(console.warn(r.getProgramInfoLog(i)),null)},createShader:function(e,t){var r,i,a=this.gl,n=[a.FRAGMENT_SHADER,a.VERTEX_SHADER];if("string"!=typeof t)throw new glacier.exception.InvalidParameter("source",t,"string","createShader","Context");if(-1==n.indexOf(e))throw r=(n=n.join(", ")).lastIndexOf(", "),n=r>=0?n.substr(0,r)+" or"+n.substr(r+1):n,new glacier.exception.InvalidParameter("type",e,n,"createShader","Context");return i=a.createShader(e),a.shaderSource(i,t),a.compileShader(i),a.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.warn(a.getShaderInfoLog(i)),null)},createTexture:function(e){if(e instanceof Image){var t=this.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),r}throw new glacier.exception.InvalidParameter("image",e,"Image","createTexture","Context")},screenToWorld:function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("x",e,"number","screenToWorld","Context");if("number"!=typeof t)throw new glacier.exception.InvalidParameter("y",t,"number","screenToWorld","Context");var r=new glacier.Vector3(2*(e/this.width)-1,1-2*(t/this.height),0),i=new glacier.Vector4(r);return this.projection instanceof glacier.Matrix44&&i.multiply(this.projection.inverse),this.view instanceof glacier.Matrix44&&i.multiply(this.view.inverse),i.divide(i.w).xyz},worldToScreen:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("point",e,"Vector3","worldToScreen","Context");var t=new glacier.Vector4(e);return this.view instanceof glacier.Matrix44&&t.multiply(this.view),this.projection instanceof glacier.Matrix44&&t.multiply(this.projection),t.w>0?(t.divide(t.w).multiply(.5).add(.5),new glacier.Vector2(Math.round(t.x*this.width),Math.round((1-t.y)*this.height))):null}},glacier.Drawable=function Drawable(){glacier.addTypedProperty(this,"aabb",new glacier.BoundingBox,glacier.BoundingBox),glacier.addTypedProperty(this,"matrix",new glacier.Matrix44,glacier.Matrix44),glacier.addTypedProperty(this,"visible",!0),["x","y","z"].forEach(function(e,t){Object.defineProperty(this,e,{get:function(){return this.matrix.array[12+t]},set:function(r){"number"==typeof r?this.matrix.array[12+t]=r:glacier.error.invalidAssignment(e,r,"number","Drawable")}})},this);var e=glacier.draw.SOLID;Object.defineProperties(this,{buffers:{value:{solid:null,wireframe:null,bounding:null,normals:null}},drawMode:{get:function(){return e},set:function(t){"number"==typeof t&&t>=0?e=t:glacier.error.invalidAssignment("drawMode",t,"number >= 0","Drawable")}}})},glacier.draw={SOLID:1,WIREFRAME:2,BOUNDING:4,NORMALS:8},glacier.Drawable.prototype={free:function(){for(var e in this.buffers)this.buffers.hasOwnProperty(e)&&this.buffers[e]instanceof glacier.BufferObject&&(this.buffers[e].free(),this.buffers[e]=null);this.matrix=new glacier.Matrix44,this.visible=!0},draw:function(){if(this.visible&&this.drawMode){var e,t;for(e in glacier.draw)glacier.draw.hasOwnProperty(e)&&this.drawMode&glacier.draw[e]&&(t=this.buffers[e.toLowerCase()])instanceof glacier.BufferObject&&t.draw()}},init:function(e,t){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","init","Drawable");var r,i,a=e.shaders.get("generic"),n=this.aabb.max,o=this.aabb.min;if(r=[new glacier.Vector3(n.x,n.y,n.z),new glacier.Vector3(o.x,n.y,n.z),new glacier.Vector3(n.x,n.y,o.z),new glacier.Vector3(o.x,n.y,o.z),new glacier.Vector3(n.x,o.y,n.z),new glacier.Vector3(o.x,o.y,n.z),new glacier.Vector3(n.x,o.y,o.z),new glacier.Vector3(o.x,o.y,o.z)],i=[0,1,4,5,7,1,3,2,7,6,4,2,0,3,7,4,0,5,3,6,2,1,5,6],this.buffers.bounding=new glacier.BufferObject(this,e,a),this.buffers.bounding.init(r,i,null,null,glacier.color.RED)&&(this.buffers.bounding.drawMode=e.gl.LINE_LOOP,this.buffers.bounding.elements=24),"object"==typeof t)"string"==typeof t.shader&&(a=e.shaders.get(t.shader));else if(t)throw new glacier.exception.InvalidParameter("options",t,"object","init","Drawable");return(this.buffers.solid=new glacier.BufferObject(this,e,a)).init()?!0:!1}},glacier.Exception=function Exception(e,t){if(this.message=e,"object"==typeof t)for(var r in t)t.hasOwnProperty(r)&&(this[r]=t[r])},glacier.exception={ContextError:function(e,t,r){glacier.Exception.call(this,"Context error",{error:e,method:t,"class":r})},IndexOutOfRange:function(e,t,r,i){glacier.Exception.call(this,"Index out of range",{index:e,range:t,method:r,"class":i})},InvalidAssignment:function(e,t,r,i){glacier.Exception.call(this,"Invalid assigment",{variable:e,value:t,type:typeof t,expected:r,"class":i})},InvalidParameter:function(e,t,r,i,a){glacier.Exception.call(this,"Invalid parameter",{parameter:e,value:t,type:typeof t,expected:r,method:i,"class":a})},InvalidOption:function(e,t,r,i){glacier.Exception.call(this,"Invalid option",{option:e,value:t,type:typeof t,expected:r,"class":i})},MissingParameter:function(e,t,r){glacier.Exception.call(this,"Missing parameter",{parameter:e,method:t,"class":r})},UndefinedElement:function(e,t,r){glacier.Exception.call(this,"Undefined element",{element:e,method:t,"class":r})}},glacier.Scene=function Scene(e,t){var r,i,a,n,o,s={},c=!1,l=this;if("string"==typeof e){if(!((e=document.getElementById(e))instanceof HTMLElement))throw new glacier.exception.UndefinedElement(e,"(constructor)","Scene")}else if(!(e instanceof HTMLElement))throw new glacier.exception.InvalidParameter("container",e,"(constructor)","Scene");e instanceof HTMLCanvasElement?(i=e,e=document.createElement("DIV"),i.parentNode.insertBefore(e,i),e.appendChild(i),(n=i.getAttribute("id"))&&(i.removeAttribute("id"),e.setAttribute("id",n))):(i=document.createElement("CANVAS"),i.style.position="absolute",i.style.height=i.style.width="100%",e.appendChild(i)),a=new glacier.Context(i,s),r=new glacier.Camera(60,a.width/a.height,1,100),Object.defineProperties(l,{camera:{value:r},container:{value:e},context:{value:a},runCallbacks:{value:{}},running:{get:function(){return!!c},set:function(e){"boolean"==typeof e?e!=c&&((c=e)?l.run():l.end()):glacier.error.invalidAssignment("running",e,"boolean","Scene")}}}),window.addEventListener("resize",function(e){l.camera.aspectRatio=a.width/a.height}),function sceneRunner(e){if(l.running){var t,r=(e-o)/1e3||0;l.fps=r?(1/r+l.fps)/2:0,o=e;for(t in l.runCallbacks)l.runCallbacks.hasOwnProperty(t)&&"function"==typeof(t=l.runCallbacks[t])&&t.call(l,r)}requestAnimationFrame(sceneRunner)}()},glacier.Scene.prototype={addRunCallback:function(e){if("function"==typeof e){var t=glacier.generateUID();return this.runCallbacks[t]=e,t}throw new glacier.exception.InvalidParameter("callback",e,"addRunCallback","Scene")},end:function(){this.fps=0,this.running=!1},removeRunCallback:function(e){if("string"==typeof e){if(this.runCallbacks[e])return delete this.runCallbacks[e]}else{if("function"!=typeof e)throw new glacier.exception.InvalidParameter("uidOrCallback",e,"removeRunCallback","Scene");for(var t in this.runCallbacks)if(this.runCallbacks[t]===e)return delete this.runCallbacks[t]}return!1},run:function(){this.running=!0}},glacier.Shader=function Shader(e,t){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","(constructor)","Shader");if(!(t instanceof WebGLProgram))throw new glacier.exception.InvalidParameter("program",t,"WebGLProgram","(constructor)","Shader");Object.defineProperties(this,{attributes:{value:{}},context:{value:e},program:{value:t},uniforms:{value:{}}})},glacier.Shader.prototype={addAttributes:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("attributeArray",e,"string array","addAttributes","Shader");var t;e.forEach(function(e){this.attributes.hasOwnProperty(e)||(t=this.context.gl.getAttribLocation(this.program,e))>=0&&(this.attributes[e]=t)},this)},addUniforms:function(e){if(!glacier.isArray(e,"string"))throw new glacier.exception.InvalidParameter("uniformArray",e,"string array","addUniforms","Shader");var t;e.forEach(function(e){this.uniforms.hasOwnProperty(e)||null!==(t=this.context.gl.getUniformLocation(this.program,e))&&(this.uniforms[e]=t)},this)},attribute:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("attribute",e,"string","attribute","Shader");return"number"==typeof(e=this.attributes[e])&&e>=0?e:null},uniform:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("uniform",e,"string","uniform","Shader");return(e=this.uniforms[e])instanceof WebGLUniformLocation?e:null},use:function(){return this.context&&this.program?(this.context.gl.useProgram(this.program),!0):!1}},glacier.ShaderBank=function ShaderBank(e){if(!(e instanceof glacier.Context))throw new glacier.exception.InvalidParameter("context",e,"Context","(constructor)","ShaderBank");Object.defineProperties(this,{context:{value:e},shaders:{value:{}}})},glacier.ShaderBank.prototype={init:function(){if(this.context instanceof glacier.Context){var e,t,r,i,a,n,o,s,c,l=/attribute\s+(?:(?:high|medium|low)p\s+)?(?:float|(?:(?:vec|mat)[234]))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)\s*;/g,h=/uniform\s+(?:(?:high|medium|low)p\s+)?(?:bool|int|float|(?:(?:vec|bvec|ivec|mat)[234])|(?:sampler(?:Cube|2D)))\s+([a-zA-Z_]+[a-zA-Z0-9_]*)(\[(?:(?:\d+)|(?:[a-zA-Z_]+[a-zA-Z0-9_]*))\])?\s*;/g,u={},f={},g=this.context.gl,y=glacier.shaders;for(e in y.vertex)if(y.vertex[e]instanceof Array){for(i=y.vertex[e].join("\n"),n={attributes:[],uniforms:[]};a=l.exec(i);)n.attributes.push(a[1]);for(;a=h.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(g.VERTEX_SHADER,i))&&(u[e]=n)}for(t in y.fragment)if(y.fragment[t]instanceof Array){for(i=y.fragment[t].join("\n"),n={uniforms:[]};a=h.exec(i);)n.uniforms.push(a[1]);(n.shader=this.context.createShader(g.FRAGMENT_SHADER,i))&&(f[t]=n)}for(r in y.programs)if(y.programs.hasOwnProperty(r)&&(e=u[y.programs[r].vertex],t=f[y.programs[r].fragment],e&&t&&(o=e.shader)&&(s=t.shader)&&(c=this.context.createProgram(o,s)))){var d=new glacier.Shader(this.context,c);d.addAttributes(e.attributes),d.addUniforms(e.uniforms),d.addUniforms(t.uniforms),this.shaders[r]=d}return!0}return!1},get:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("shader",e,"string","shader","ShaderBank");return(e=this.shaders[e])instanceof glacier.Shader?e:null}},glacier.Texture=function Texture(e){var t=null;if(Object.defineProperties(this,{onFreeCallbacks:{value:[]},onLoadCallbacks:{value:[]},image:{get:function(){return t},set:function(e){if(e instanceof Image){var r=this;r.image=null,(t=e).onload=function(){return t.width&&t.height?void r.onLoadCallbacks.forEach(function(e){"function"==typeof e&&e(t)}):void(t=null)}}else null===e?(t&&this.onFreeCallbacks.forEach(function(e){"function"==typeof e&&e()}),t=null):glacier.error.invalidAssignment("image",e,"Image or null","Texture")}}}),"string"==typeof e)this.load(e);else if(e)throw new glacier.exception.InvalidParameter("source",e,"Image","(constructor)","Texture")},glacier.Texture.prototype={free:function(){this.image=null},load:function(e){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("source",e,"string","load","Texture");this.image=new Image,this.image.src=e},onFree:function(e){"function"==typeof e&&this.onFreeCallbacks.push(e)},onLoad:function(e){"function"==typeof e&&this.onLoadCallbacks.push(e)},get height(){return this.image?this.image.height:0},get width(){return this.image?this.image.width:0}},glacier.TypedArray=function TypedArray(e,t){if("string"!=typeof e)throw new glacier.exception.InvalidParameter("type",e,"string","(constructor)","TypedArray");if(t&&"function"!=typeof t)throw new glacier.exception.InvalidParameter("ctor",t,"function","(constructor)","TypedArray");Object.defineProperty(this,"type",{value:{name:e,ctor:t}})},glacier.extend(glacier.TypedArray,Array,{push:function(e){var t,r=arguments;for(t=0;t<r.length;++t){if(!(this.type.ctor&&r[t]instanceof this.type.ctor||typeof r[t]==this.type.name))throw new glacier.exception.InvalidParameter("item",r[t],this.type.name,"push","TypedArray");Array.prototype.push.call(this,r[t])}return this.length},splice:function(e,t,r){var i,a=arguments;for(i=2;i<a.length;++i)if(!(this.type.ctor&&a[i]instanceof this.type.ctor)||typeof a[i]!=this.type.name)throw new glacier.exception.InvalidParameter("item",a[i],this.type.name,"splice","TypedArray");

return Array.prototype.splice.apply(this,a)},unshift:function(e){var t,r=arguments;for(t=0;t<r.length;++t){if(!(this.type.ctor&&r[t]instanceof this.type.ctor||typeof r[t]==this.type.name))throw new glacier.exception.InvalidParameter("item",r[t],this.type.name,"unshift","TypedArray");Array.prototype.unshift.call(this,r[t])}return this.length}}),function(){var e={Feature:function(e,t,r){this.id=void 0!==r?r:null,this.geometry=e||null,this.properties="object"==typeof t?t:{}},FeatureCollection:function(e){this.features=e instanceof Array?e:[]},GeometryCollection:function(e){this.geometries=e instanceof Array?e:[]},LineString:function(e){this.points=e instanceof Array?e:[]},MultiLineString:function(e){this.lineStrings=e instanceof Array?e:[]},MultiPoint:function(e){this.points=e instanceof Array?e:[]},MultiPolygon:function(e){this.polygons=e instanceof Array?e:[]},Point:function(e,t,r){this.lat="number"==typeof e?e:0,this.lng="number"==typeof t?t:0,this.alt="number"==typeof r?r:void 0},Polygon:function(e){this.rings=e instanceof Array?e:[]},parse:function(t){var r;if("string"==typeof t)try{r=JSON.parse(string)}catch(i){return null}else{if("object"!=typeof t)return null;r=t}return e.parseObject(r)},parseGeometry:function(t){if("object"==typeof t){var r="Point,MultiPoint,LineString,MultiLineString,Polygon,MultiPolygon,GeometryCollection".split(",");if(-1!=r.indexOf(t.type))return e.parseObject(t)}return null},parseLineString:function(t){if(t instanceof Array&&t.length>=2){var r,i=[];for(r in t)(r=e.parsePoint(t[r]))&&i.push(r);if(i.length==t.length)return new e.LineString(i)}return null},parseMultiLineString:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseLineString(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiLineString(i)}return null},parseMultiPoint:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parsePoint(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiPoint(i)}return null},parseMultiPolygon:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parsePolygon(t[r]))&&i.push(r);if(i.length==t.length)return new e.MultiPolygon(i)}return null},parseObject:function(t){if("object"==typeof t){var r;switch(t.type){case"Point":if(r=e.parsePoint(t.coordinates))return r;break;case"MultiPoint":if(r=e.parseMultiPoint(t.coordinates))return r;break;case"LineString":if(r=e.parseLineString(t.coordinates))return r;break;case"MultiLineString":if(r=e.parseMultiLineString(t.coordinates))return r;break;case"Polygon":if(r=e.parsePolygon(t.coordinates))return r;break;case"MultiPolygon":if(r=e.parseMultiPolygon(t.coordinates))return r;break;case"GeometryCollection":if(r=e.parseGeometryCollection(t.geometries))return r;break;case"Feature":if(r=e.parseFeature(t))return r;break;case"FeatureCollection":if(r=e.parseFeatureCollection(t.features))return r}}return null},parsePoint:function(t){if(t instanceof Array){var r={lng:"number"==typeof t[0]?t[0]:void 0,lat:"number"==typeof t[1]?t[1]:void 0,alt:"number"==typeof t[2]?t[2]:void 0};if(void 0!==r.lat&&void 0!==r.lng)return new e.Point(r.lat,r.lng,r.alt)}return null},parsePolygon:function(t){if(t instanceof Array){var r,i,a=[];for(r in t)(r=e.parseLineString(t[r]))&&(i=r.length)>=4&&r[0].compare(r[i-1])&&a.push(r);if(a.length==t.length)return new e.Polygon(a)}return null},parseGeometryCollection:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseGeometry(t[r]))&&i.push(r);if(i.length==t.length)return new e.GeometryCollection(i)}return null},parseFeature:function(t){if("object"==typeof t&&"Feature"==t.type){var r,i,a=t.id;return null===t.geometry||(r=e.parseGeometry(t.geometry))?null!==(i=t.properties)&&"object"!=typeof i?null:new e.Feature(r,i,a):null}return null},parseFeatureCollection:function(t){if(t instanceof Array){var r,i=[];for(r in t)(r=e.parseFeature(t[r]))&&i.push(r);if(i.length==t.length)return new e.FeatureCollection(i)}return null},validObject:function(t){return t instanceof e.Feature||t instanceof e.FeatureCollection||t instanceof e.GeometryCollection||t instanceof e.LineString||t instanceof e.MultiLineString||t instanceof e.MultiPoint||t instanceof e.MultiPolygon||t instanceof e.Polygon}};e.Point.prototype={compare:function(t,r){return t instanceof e.Point&&Math.abs(this.lat-t.lat)<=(r||0)&&Math.abs(this.lng-t.lng)<=(r||0)&&Math.abs(this.alt-t.alt)<=(r||0)}},glacier.geoJSON=e}(),glacier.EPSILON=1e-4,glacier.compare=function(e,t,r){var i,a=glacier.isArray(e),n=glacier.isArray(t);if("number"!=typeof r&&(r=glacier.EPSILON),!a||!n){if(a||n){var o=a?e:t,s=a?t:e;for(i=0;i<o.length;++i)if("number"==typeof o[i]&&"number"==typeof s){if(Math.abs(o[i]-s)>=r)return!1}else if(o[i]!==s)return!1;return!0}return"number"==typeof e&&"number"==typeof t?Math.abs(e-t)<r:e===t}if(e.length==t.length){for(i=0;i<e.length;++i)if("number"==typeof e[i]&&"number"==typeof t[i]){if(Math.abs(e[i]-t[i])>=r)return!1}else if(e!==t)return!1;return!0}return!1},glacier.degToRad=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("degrees",e,"number","degToRad");return e*Math.PI/180},glacier.radToDeg=function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","radToDeg");return 180*e/Math.PI},glacier.limitAngle=function(e,t,r){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("angle",e,"number","limitAngle");if("number"!=typeof(t=void 0===t?360:t))throw new glacier.exception.InvalidParameter("max",t,"number","limitAngle");if("number"!=typeof(r=void 0===r?0:r))throw new glacier.exception.InvalidParameter("min",r,"number","limitAngle");for(r>t&&(t=r+(r=t,0));e>t;)e=r+(e-t);for(;r>e;)e=t+(e-r);return e},glacier.clamp=function(e,t,r){var i=["value","min","max"];return[e,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","clamp")}),t>r&&(r=t+(t=r,0)),Math.max(t,Math.min(r,e))},glacier.shaders={vertex:{generic:["attribute highp vec3 vertex_position;","attribute mediump vec3 vertex_normal;","attribute lowp vec4 vertex_color;","attribute highp vec2 vertex_uv;","uniform highp mat4 matrix_mvp;","uniform lowp vec4 color_rgba;","varying highp vec4 vertex_pos;","varying mediump vec3 mvp_normal;","varying lowp vec4 frag_color;","varying highp vec2 tex_coords;","void main()","{","gl_PointSize = 2.0;","gl_Position = vertex_pos = matrix_mvp * vec4(vertex_position, 1.0);","mvp_normal = normalize(matrix_mvp * vec4(vertex_normal, 1.0)).xyz;","frag_color = vertex_color + color_rgba;","tex_coords = vertex_uv;","}"]},fragment:{generic:["varying lowp vec4 frag_color;","void main()","{","gl_FragColor = frag_color;","}"],globe:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","uniform sampler2D tex_samp_2;","varying highp vec2 tex_coords;","varying lowp vec4 frag_color;","varying mediump vec3 mvp_normal;","void main()","{","vec3 lightPos = normalize(vec3(-28.0, 2.0, 12.0));","vec3 normal = normalize(texture2D(tex_samp_2, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(mvp_normal, lightPos), 0.0);","vec3 dayColor = texture2D(tex_samp_0, tex_coords).rgb * diffuse;","vec3 nightColor = texture2D(tex_samp_1, tex_coords).rgb * (1.0 - diffuse);","vec3 normalColor = dayColor * max(dot(normal, lightPos), 0.3);","dayColor = ((1.0 - nightColor) * dayColor) + normalColor;","gl_FragColor = vec4(dayColor + ((1.0 - dayColor) * nightColor * 0.5), 1.0);","}"],normalMapped:["precision highp float;","uniform sampler2D tex_samp_0;","uniform sampler2D tex_samp_1;","varying highp vec2 tex_coords;","varying lowp vec4 frag_color;","void main()","{","vec3 lightPos = normalize(vec3(1.0, 1.0, 1.0));","vec4 fragColor = vec4(1.0, 1.0, 1.0, 1.0);","vec3 normal = normalize(texture2D(tex_samp_1, tex_coords).rgb * 2.0 - 1.0);","float diffuse = max(dot(normal, lightPos), 0.0);","gl_FragColor = vec4(diffuse * texture2D(tex_samp_0, tex_coords).rgb, 1.0);","}"],textured:["precision highp float;","uniform sampler2D tex_samp_0;","varying highp vec2 tex_coords;","varying lowp vec4 frag_color;","void main()","{","gl_FragColor = texture2D(tex_samp_0, tex_coords);","}"]},programs:{generic:{vertex:"generic",fragment:"generic"},globe:{vertex:"generic",fragment:"globe"},normalMapped:{vertex:"generic",fragment:"normalMapped"},textured:{vertex:"generic",fragment:"textured"}}},glacier.Mesh=function Mesh(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},indices:{value:new glacier.TypedArray("number")},normals:{value:new glacier.TypedArray("Vector3",glacier.Vector3)},texCoords:{value:new glacier.TypedArray("Vector2",glacier.Vector2)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}}),[0,1,2,3].forEach(function(e){var t=new glacier.Texture,r="texture"+e;Object.defineProperty(this,r,{get:function(){return t},set:function(e){"string"==typeof e?t.load(e):null===e?t.free():glacier.error.invalidAssignment(r,e,"string or null","Mesh")}})},this)},glacier.extend(glacier.Mesh,glacier.Drawable,{free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.indices.length=0,this.normals.length=0,this.texCoords.length=0,this.vertices.length=0},init:function(e,t){var r=this;return r.aabb.reset(),r.vertices.forEach(function(e){r.aabb.min.minimize(e),r.aabb.max.maximize(e)}),glacier.Drawable.prototype.init.call(this,e,t)&&r.buffers.solid.init(r.vertices,r.indices,r.normals,r.texCoords,r.colors)?(r.buffers.solid.elements=r.indices.length?r.indices.length:r.vertices.length/3,r.buffers.solid.drawMode=e.gl.TRIANGLES,[0,1,2,3].forEach(function(t){r["texture"+t].onLoad(function(i){r.buffers.solid.textures[t]=e.createTexture(i)}),r["texture"+t].onFree(function(){r.buffers.solid.freeTexture(t)})}),!0):(r.buffers.solid=null,!1)}}),glacier.PointCollection=function PointCollection(){glacier.Drawable.call(this),Object.defineProperties(this,{colors:{value:new glacier.TypedArray("Color",glacier.Color)},vertices:{value:new glacier.TypedArray("Vector3",glacier.Vector3)}})},glacier.extend(glacier.PointCollection,glacier.Drawable,{addPoint:function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","addPoint","PointCollection");if(t&&!(t instanceof glacier.Color))throw new glacier.exception.InvalidParameter("color",t,"Color","addPoint","PointCollection");this.colors.push(t||glacier.color.WHITE),this.vertices.push(e)},free:function(){glacier.Drawable.prototype.free.call(this),this.colors.length=0,this.vertices.length=0},init:function(e,t){var r=this;return r.aabb.reset(),r.vertices.forEach(function(e){r.aabb.min.minimize(e),r.aabb.max.maximize(e)}),glacier.Drawable.prototype.init.call(this,e,t)&&r.buffers.solid.init(r.vertices,null,null,null,r.colors)?(r.buffers.solid.elements=r.vertices.length,r.buffers.solid.drawMode=e.gl.POINTS,!0):(r.buffers.solid=null,!1)}}),glacier.BoundingBox=function BoundingBox(e,t){glacier.addTypedProperty(this,"min",new glacier.Vector3(Number.MAX_VALUE),glacier.Vector3),glacier.addTypedProperty(this,"max",new glacier.Vector3(-Number.MAX_VALUE),glacier.Vector3),void 0!==e&&null!==e&&this.assign(e,t)},glacier.BoundingBox.prototype={add:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","add","BoundingBox");return this.min.add(e),this.max.add(e),this},assign:function(e,t){if(e instanceof glacier.BoundingBox)return this.assign(e.min,e.max);var r=["min","max"],i=e;return[i,t].forEach(function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter(r[t],e,"Vector3","assign","BoundingBox")}),this.min.assign(i),this.max.assign(t),this},get copy(){return new glacier.BoundingBox(this)},get matrix(){var e=new glacier.Vector3(this.max).subtract(this.min).divide(2),t=new glacier.Matrix44;return t.translate(this.min.copy.add(e)).scale(e)},reset:function(){this.min.assign(Number.MAX_VALUE),this.max.assign(-Number.MAX_VALUE)},subtract:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","subtract","BoundingBox");return this.min.subtract(e),this.max.subtract(e),this},toString:function(){return"BoundingBox("+this.min.toString()+", "+this.max.toString()+")"},update:function(e,t,r){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("min",e,"Vector3","update","BoundingBox");if(!(t instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("max",t,"Vector3","update","BoundingBox");r instanceof glacier.Matrix44||(r=new glacier.Matrix44),this.reset(),[[t.x,t.y,t.z],[e.x,t.y,t.z],[t.x,t.y,e.z],[e.x,t.y,e.z],[t.x,e.y,t.z],[e.x,e.y,t.z],[t.x,e.y,e.z],[e.x,e.y,e.z]].forEach(function(e){var t=new glacier.Vector3(e[0],e[1],e[2]).multiply(r);this.min.minimize(t),this.max.maximize(t)},this)}},glacier.Matrix33=function Matrix33(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,1,0,0,0,1])}),void 0!==e&&null!==e&&this.assign(e)},glacier.Matrix33.prototype={assign:function(e){var t,r,i;if(e instanceof glacier.Matrix33)for(i in e.array)this.array[i]=e.array[i];else if(e instanceof glacier.Matrix44)for(r=0;3>r;++r)for(t=0;3>t;++t)this.array[3*r+t]=e.array[4*r+t];else if(glacier.isArray(e)&&9==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33, Matrix44 or array[9]","assign","Matrix33");for(i in this.array)this.array[i]=e}return this},assignIdentity:function(){for(var e=0;9>e;++e)this.array[e]=e%4?0:1},get copy(){return new glacier.Matrix33(this)},get determinant(){return this.array[0]*(this.array[4]*this.array[8]-this.array[5]*this.array[7])-this.array[1]*(this.array[3]*this.array[8]-this.array[5]*this.array[6])+this.array[2]*(this.array[3]*this.array[7]-this.array[4]*this.array[6])},element:function(e,t){if("number"==typeof t&&"number"==typeof e){if(t>=0&&3>=t&&e>=0&&3>=e)return this.array[3*e+t]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(t||0),"0-9","element","Matrix33")},get inverse(){var e=this.copy;return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=new Float32Array([this.array[4]*this.array[8]-this.array[5]*this.array[7],this.array[2]*this.array[7]-this.array[1]*this.array[8],this.array[1]*this.array[5]-this.array[2]*this.array[4],this.array[5]*this.array[6]-this.array[3]*this.array[8],this.array[0]*this.array[8]-this.array[2]*this.array[6],this.array[2]*this.array[3]-this.array[0]*this.array[5],this.array[3]*this.array[7]-this.array[4]*this.array[6],this.array[1]*this.array[6]-this.array[0]*this.array[7],this.array[0]*this.array[4]-this.array[1]*this.array[3]]),t=this.array[0]*e[0]+this.array[1]*e[3]+this.array[2]*e[6];if(glacier.compare(t,0))return!1;t=1/t;for(var r=0;r<e.length;++r)this.array[r]=e[r]*t;return!0},multiply:function(e){var t,r,i,a;if(e instanceof glacier.Matrix33)for(a=new Float32Array(this.array),t=0;3>t;++t)for(r=0;3>r;++r)this.array[3*t+r]=a[3*t+0]*e.array[0+r]+a[3*t+1]*e.array[3+r]+a[3*t+2]*e.array[6+r];else if(e instanceof glacier.Matrix44)this.multiply(new glacier.Matrix33(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33 or Matrix44","multiply","Matrix33");for(i in this.array)this.array[i]*=e}return this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+"], ["+this.array[3].toPrecision(5)+", "+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+"], ["+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+", "+this.array[8].toPrecision(5)+"]]"},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[3],this.array[3]=e,e=this.array[2],this.array[2]=this.array[6],this.array[6]=e,e=this.array[5],this.array[5]=this.array[7],this.array[7]=e,this},get transposed(){return this.copy.transpose()}},glacier.Matrix44=function Matrix44(e){Object.defineProperty(this,"array",{value:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}),void 0!==e&&null!==e&&this.assign(e)},glacier.Matrix44.prototype={assign:function(e){var t,r,i;if(e instanceof glacier.Matrix33){for(r=0;3>r;++r)for(t=0;3>t;++t)this.array[4*r+t]=e.array[3*r+t];this.array[3]=this.array[7]=this.array[11]=0,this.array[12]=this.array[13]=this.array[14]=0,this.array[16]=1}else if(e instanceof glacier.Matrix44)for(i in e.array)this.array[i]=e.array[i];else if(glacier.isArray(e)&&16==e.length)for(i=0;i<e.length;++i)this.array[i]=e[i];else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33, Matrix44 or array[16]","assign","Matrix44");for(i in this.array)this.array[i]=e}return this},assignIdentity:function(){for(var e=0;16>e;++e)this.array[e]=e%5?0:1},get copy(){return new glacier.Matrix44(this)},get determinant(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],t=this.array[0]*this.array[6]-this.array[2]*this.array[4],r=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],l=this.array[9]*this.array[14]-this.array[10]*this.array[13],h=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14];return e*u-t*h+r*l+i*c-a*s+n*o},element:function(e,t){if("number"==typeof t&&"number"==typeof e){if(t>=0&&4>=t&&e>=0&&4>=e)return this.array[4*e+t]}else if("number"==typeof e)return this.array[e];throw new glacier.exception.IndexOutOfRange(e+(t||0),"0-16","element","Matrix44")},frustum:function(e,t,r,i,a,n){var o,s,c,l="left,right,bottom,top,near,far".split(",");return[e,t,r,i,a,n].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(l[t],e,"number","frustum","Matrix44")}),0>=a||0>=n||(o=t-e)<=0||(s=i-r)<=0||(c=n-a)<=0?!1:(this.assign(new glacier.Matrix44([2*a/o,0,0,0,0,2*a/s,0,0,(t+e)/o,(i+r)/s,-(a+n)/c,-1,0,0,-2*a*n/c,0]).multiply(this)),!0)},get inverse(){var e=this.copy;return e.invert()?e:void console.warn("Inverse matrix does not exist: "+e.toString())},invert:function(){var e=this.array[0]*this.array[5]-this.array[1]*this.array[4],t=this.array[0]*this.array[6]-this.array[2]*this.array[4],r=this.array[0]*this.array[7]-this.array[3]*this.array[4],i=this.array[1]*this.array[6]-this.array[2]*this.array[5],a=this.array[1]*this.array[7]-this.array[3]*this.array[5],n=this.array[2]*this.array[7]-this.array[3]*this.array[6],o=this.array[8]*this.array[13]-this.array[9]*this.array[12],s=this.array[8]*this.array[14]-this.array[10]*this.array[12],c=this.array[8]*this.array[15]-this.array[11]*this.array[12],l=this.array[9]*this.array[14]-this.array[10]*this.array[13],h=this.array[9]*this.array[15]-this.array[11]*this.array[13],u=this.array[10]*this.array[15]-this.array[11]*this.array[14],f=e*u-t*h+r*l+i*c-a*s+n*o;if(glacier.compare(f,0))return!1;var g=new Float32Array([this.array[5]*u-this.array[6]*h+this.array[7]*l,-this.array[1]*u+this.array[2]*h-this.array[3]*l,this.array[13]*n-this.array[14]*a+this.array[15]*i,-this.array[9]*n+this.array[10]*a-this.array[11]*i,-this.array[4]*u+this.array[6]*c-this.array[7]*s,this.array[0]*u-this.array[2]*c+this.array[3]*s,-this.array[12]*n+this.array[14]*r-this.array[15]*t,this.array[8]*n-this.array[10]*r+this.array[11]*t,this.array[4]*h-this.array[5]*c+this.array[7]*o,-this.array[0]*h+this.array[1]*c-this.array[3]*o,this.array[12]*a-this.array[13]*r+this.array[15]*e,-this.array[8]*a+this.array[9]*r-this.array[11]*e,-this.array[4]*l+this.array[5]*s-this.array[6]*o,this.array[0]*l-this.array[1]*s+this.array[2]*o,-this.array[12]*i+this.array[13]*t-this.array[14]*e,this.array[8]*i-this.array[9]*t+this.array[10]*e]);f=1/f;for(var y=0;y<g.length;++y)this.array[y]=g[y]*f;return!0},multiply:function(e){var t,r,i,a;if(e instanceof glacier.Matrix44)for(a=new Float32Array(this.array),t=0;4>t;++t)for(r=0;4>r;++r)this.array[4*t+r]=a[4*t+0]*e.array[0+r]+a[4*t+1]*e.array[4+r]+a[4*t+2]*e.array[8+r]+a[4*t+3]*e.array[12+r];else if(e instanceof glacier.Matrix33)this.multiply(new glacier.Matrix44(e));else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number, Matrix33 or Matrix44","multiply","Matrix44");for(i in this.array)this.array[i]*=e}return this},ortho:function(e,t,r,i,a,n){var o="left,right,bottom,top,near,far".split(",");return[e,t,r,i,a,n].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[t],e,"number","ortho","Matrix44")}),(dX=t-e)&&(dY=i-r)&&(dZ=n-a)?(this.assign(new glacier.Matrix44([2/dX,0,0,0,0,2/dY,0,0,0,0,-2/dZ,0,-(t+e)/dX,-(i+r)/dY,-(a+n)/dZ,1]).multiply(this)),!0):!1},perspective:function(e,t,r,i){var a,n,o="verticalViewAngle,aspectRatio,near,far".split(","),s=new glacier.Matrix44;return[e,t,r,i].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(o[t],e,"number","perspective","Matrix44")}),0>=r||0>=i?!1:(a=Math.tan(e/360*Math.PI)*r,n=a*t,s.frustum(-n,n,-a,a,r,i)?(this.assign(s.multiply(this)),!0):!1)},rotate:function(e,t,r,i){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotate","Matrix44");if(t instanceof glacier.Vector3)return this.rotate(e,t.x,t.y,t.z);var a,n,o,s,c=["x","y","z"],l=t;return[l,r,i].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(c[t],e,"number","rotate","Matrix44")}),s=1-(a=Math.cos(e)),n=Math.sin(e),isNaN(o=Math.sqrt(l*l+r*r+i*i))||(l/=o,r/=o,i/=o,this.assign(new glacier.Matrix44([s*l*l+a,s*l*r-i*n,s*l*i+r*n,0,s*r*l+i*n,s*r*r+a,s*r*i-l*n,0,s*i*l-r*n,s*i*r+l*n,s*i*i+a,0,0,0,0,1]).multiply(this))),this},scale:function(e,t,r){if(e instanceof glacier.Vector3)return this.scale(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","scale","Matrix44")}),this.array[0]*=a,this.array[4]*=t,this.array[8]*=r,this.array[1]*=a,this.array[5]*=t,this.array[9]*=r,this.array[2]*=a,this.array[6]*=t,this.array[10]*=r,this.array[3]*=a,this.array[7]*=t,this.array[11]*=r,this},toString:function(){return"[["+this.array[0].toPrecision(5)+", "+this.array[1].toPrecision(5)+", "+this.array[2].toPrecision(5)+", "+this.array[3].toPrecision(5)+"], ["+this.array[4].toPrecision(5)+", "+this.array[5].toPrecision(5)+", "+this.array[6].toPrecision(5)+", "+this.array[7].toPrecision(5)+"], ["+this.array[8].toPrecision(5)+", "+this.array[9].toPrecision(5)+", "+this.array[10].toPrecision(5)+", "+this.array[11].toPrecision(5)+"], ["+this.array[12].toPrecision(5)+", "+this.array[13].toPrecision(5)+", "+this.array[14].toPrecision(5)+", "+this.array[15].toPrecision(5)+"]]"},translate:function(e,t,r){if(e instanceof glacier.Vector3)return this.translate(e.x,e.y,e.z);var i=["x","y","z"],a=e;return[a,t,r].forEach(function(e,t){if("number"!=typeof e)throw new glacier.exception.InvalidParameter(i[t],e,"number","translate","Matrix44")}),this.array[12]+=this.array[0]*a+this.array[4]*t+this.array[8]*r,this.array[13]+=this.array[1]*a+this.array[5]*t+this.array[9]*r,this.array[14]+=this.array[2]*a+this.array[6]*t+this.array[10]*r,this.array[15]+=this.array[3]*a+this.array[7]*t+this.array[11]*r,this},get translation(){return new glacier.Vector3(this.array[12],this.array[13],this.array[14])},transpose:function(){var e;return e=this.array[1],this.array[1]=this.array[4],this.array[4]=e,e=this.array[2],this.array[2]=this.array[8],this.array[8]=e,e=this.array[3],this.array[3]=this.array[12],this.array[12]=e,e=this.array[6],this.array[6]=this.array[9],this.array[9]=e,e=this.array[7],this.array[7]=this.array[13],this.array[13]=e,e=this.array[11],this.array[11]=this.array[14],this.array[14]=e,this},get transposed(){return this.copy.transpose()}},function(){function Cell(e,t,r){for(var i=r.root||r;i&&i.parent;)i=i.parent;Object.defineProperties(this,{children:{value:[]},max:{value:t},min:{value:e},parent:{value:r},points:{value:[]},root:{value:i}})}function Octree(e,t,r){if(!(e instanceof glacier.Vector3)||e.length==1/0)throw new glacier.exception.InvalidParameter("min",e,"finite Vector3","(constructor)","Octree");if(!(t instanceof glacier.Vector3)||t.length==1/0)throw new glacier.exception.InvalidParameter("max",t,"finite Vector3","(constructor)","Octree");r="number"==typeof r?Math.ceil(Math.abs(r)):256,e.length>t.length&&e.swap(t),Object.defineProperties(this,{cellCapacity:{get:function(){return r},set:function(e){if("number"==typeof e&&e>0){r=Math.ceil(e);var t=this.points;this.clear(),t.forEach(function(e){root.add(e)})}}},root:{value:new Cell(e,t,this)}})}Cell.prototype={add:function(e){if(e instanceof glacier.Vector3&&this.contains(e)){if(!this.children.length){if(this.points.length<this.root.cellCapacity)return this.points.push(e),!0;if(!this.split())return!1}for(var t in this.children)if((t=this.children[t]).contains(e))return t.add(e)}return!1},clear:function(){this.children.length=this.points.length=0},contains:function(e){return e instanceof glacier.Vector3?e.x>=this.min.x&&e.y>=this.min.y&&e.z>=this.min.z&&e.x<=this.max.x&&e.y<=this.max.y&&e.z<=this.max.z:!1},get level(){for(var e=0,t=this.parent;t&&(t=t.parent);)e++;return e},remove:function(e){if(e instanceof glacier.Vector3&&this.contains(e)){var t;for(t in this.points)if(this.points[t]===e)return this.points.splice(t,1),!0;for(t in this.children)if(this.children[t].remove(e))return!0}return!1},split:function(){if(!this.children.length){var e=this.min,t=this.max,r=t.copy.subtract(e);return this.children.push(new Cell(new glacier.Vector3(e.x,e.y,e.z),new glacier.Vector3(r.x,r.y,r.z),this),new Cell(new glacier.Vector3(r.x,e.y,e.z),new glacier.Vector3(t.x,r.y,r.z),this),new Cell(new glacier.Vector3(e.x,e.y,r.z),new glacier.Vector3(r.x,r.y,t.z),this),new Cell(new glacier.Vector3(r.x,e.y,r.z),new glacier.Vector3(t.x,r.y,t.z),this),new Cell(new glacier.Vector3(e.x,r.y,e.z),new glacier.Vector3(r.x,t.y,r.z),this),new Cell(new glacier.Vector3(r.x,r.y,e.z),new glacier.Vector3(t.x,t.y,r.z),this),new Cell(new glacier.Vector3(e.x,r.y,r.z),new glacier.Vector3(r.x,t.y,t.z),this),new Cell(new glacier.Vector3(r.x,r.y,r.z),new glacier.Vector3(t.x,t.y,t.z),this)),!0}return!1}},Octree.prototype={add:function(e){return this.root.add(e)},clear:function(){this.root.clear()},contains:function(e){return this.root.contains(e)},get max(){return this.root.max},get min(){return this.root.min},get points(){function childPoints(e){var t=[];return e.points.forEach(function(e){t.push(e)}),e.children.forEach(function(e){childPoints(e).forEach(function(e){t.push(e)})}),t}return childPoints(this.root)},rayPoint:function(e,t){if(e instanceof glacier.Ray){t=Math.abs("number"==typeof t?t:1/0);var r,i=function(r){var a,n,o,s,c,l=r.max.copy.subtract(r.min);if(e.boxIntersection(r.min,r.max)&&e.distance(l)<=t){for(n in r.points)(a=e.distance(n=r.points[n]))<=t&&(!o||o>a)&&(s=n,o=a);r.children.forEach(function(e){(c=i(e))&&c.dist<o&&(o=c.dist,s=c.point)})}return s?{point:s,dist:o}:null};return(r=i(this.root))?r.point:null}throw new glacier.exception.InvalidParameter("ray",e,"Ray","rayPoints","Octree")},remove:function(e){return this.root.remove(e)}},glacier.Octree=Octree}(),glacier.Ray=function Ray(e,t){glacier.addTypedProperty(this,["a","origin"],new glacier.Vector3(0),glacier.Vector3),glacier.addTypedProperty(this,["b","direction"],new glacier.Vector3(0),glacier.Vector3),this.assign(e,t)},glacier.Ray.prototype={get array(){return new Float32Array([this.a.x,this.a.y,this.a.z,this.b.x,this.b.y,this.b.z])},assign:function(e,t){if(e instanceof glacier.Ray)return this.assign(e.a,e.b);var r=["origin","direction"];return[e,t].forEach(function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter(r[t],e,"Vector3","assign","Ray")}),this.a=e.copy,this.b=t.copy,this},boxIntersection:function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.excepetion.InvalidParameter("min",e,"Vector3","boxIntersection","Ray");if(!(t instanceof glacier.Vector3))throw new glacier.excepetion.InvalidParameter("max",t,"Vector3","boxIntersection","Ray");var r=new glacier.Vector3(1).divide(this.b),i=(e.x-this.a.x)*r.x,a=(t.x-this.a.x)*r.x,n=(e.y-this.a.y)*r.y,o=(t.y-this.a.y)*r.y,s=(e.z-this.a.z)*r.z,c=(t.z-this.a.z)*r.z,l=Math.max(Math.min(i,a),Math.min(n,o),Math.min(s,c)),h=Math.min(Math.max(i,a),Math.max(n,o),Math.max(s,c));return 0>h||l>h?null:this.b.copy.multiply(l).add(this.a)},deviation:function(e){if(e instanceof glacier.Ray)return this.b.dot(e.b);throw new glacier.exception.InvalidParameter("ray",e,"Ray","deviation","Ray")},distance:function(e){if(e instanceof glacier.Vector3)return this.b.copy.subtract(this.a).cross(this.a.copy.subtract(e)).length/this.b.copy.subtract(this.a).length;throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","distance","Ray")},intersects:function(e){return e instanceof glacier.Sphere?this.sphereIntersection(e.matrix.translation,e.radius):e instanceof glacier.BoundingBox?this.boxIntersection(e.min,e.max):(console.warn("Ray.intersects currently only supports sphere intersections"),null)},sphereIntersection:function(e,t){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("center",e,"Vector3","sphereIntersection","Ray");if("number"!=typeof t)throw new glacier.exception.InvalidParameter("radius",t,"number","sphereIntersection","Ray");var r,i=this.a,a=this.b.copy.subtract(i),n=a.dot(a),o=2*a.x*(i.x-e.x)+2*a.y*(i.y-e.y)+2*a.z*(i.z-e.z),s=e.dot(e)+i.dot(i)-2*e.dot(i)-t*t,c=o*o-4*n*s;return 0>c?null:(r=(-o-Math.sqrt(o*o-4*n*s))/(2*n),new glacier.Vector3(i.x+r*a.x,i.y+r*a.y,i.z+r*a.z))},toString:function(){return"Ray("+this.a.toString()+" + "+this.b.normalized.toString()+")"}},glacier.Vector2=function Vector2(e,t){glacier.addTypedProperty(this,["x","u","lng"],0),glacier.addTypedProperty(this,["y","v","lat"],0),void 0!==e&&null!==e&&this.assign(e,t)},glacier.Vector2.prototype={add:function(e){if(e instanceof glacier.Vector2)this.x+=e.x,this.y+=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","add","Vector2");this.x+=e,this.y+=e}return this},get array(){return new Float32Array([this.x,this.y])},assign:function(e,t){if(e instanceof glacier.Vector2)return this.assign(e.x,e.y);if("number"==typeof e&&void 0===t)return this.assign(e,e);var r=["x","y"],i=e;return[i,t].forEach(function(e,t){if(isNaN(e))throw new glacier.exception.InvalidParameter(r[t],e,"number","assign","Vector2")}),this.x=i,this.y=t,this},compare:function(e,t){if(e instanceof glacier.Vector2)return glacier.compare(this.x,e.x,t)&&glacier.compare(this.y,e.y,t);throw new glacier.exception.InvalidParameter("vec2",e,"Vector2","compare","Vector2")},get copy(){return new glacier.Vector2(this)},distance:function(e){if(e instanceof glacier.Vector2){var t=this.x-e.x,r=this.y-e.y;return Math.sqrt(t*t+r*r)}throw new glacier.exception.InvalidParameter("vec2",e,"Vector2","distance","Vector2")},divide:function(e){if(e instanceof glacier.Vector2)this.x/=e.x,this.y/=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","divide","Vector2");this.x/=e,this.y/=e}return this},dot:function(e){if(e instanceof glacier.Vector2)return this.x*e.x+this.y*e.y;throw new glacier.exception.InvalidParameter("vec2",e,"Vector2","dot","Vector2")},get length(){return Math.sqrt(this.x*this.x+this.y*this.y)},maximize:function(e){if(!(e instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("max",e,"Vector2","minimize","Vector2");return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},minimize:function(e){if(!(e instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("min",e,"Vector2","minimize","Vector2");

return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},multiply:function(e){if(e instanceof glacier.Vector2)this.x*=e.x,this.y*=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","multiply","Vector2");this.x*=e,this.y*=e}return this},normalize:function(){var e=1/this.length;return this.x*=e,this.y*=e,this},get normalized(){return this.copy.normalize()},rotate:function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotate","Vector2");var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.y*r,a=this.x*r+this.y*t;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector2)this.x-=e.x,this.y-=e.y;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector2","subtract","Vector2");this.x-=e,this.y-=e}return this},swap:function(e){if(!(e instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("vec2",e,"Vector2","swap","Vector2");this.x=e.x+(e.x=this.x,0),this.y=e.y+(e.y=this.y,0)},toString:function(){return"("+this.x+", "+this.y+")"}},glacier.Vector3=function Vector3(e,t,r){glacier.addTypedProperty(this,"x",0),glacier.addTypedProperty(this,"y",0),glacier.addTypedProperty(this,"z",0),this.assign(e,t,r)},glacier.Vector3.prototype={add:function(e){if(e instanceof glacier.Vector3)this.x+=e.x,this.y+=e.y,this.z+=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector3","add","Vector3");this.x+=e,this.y+=e,this.z+=e}return this},angle:function(e){if(e instanceof glacier.Vector3){var t=Math.acos(this.dot(e)/(this.length*e.length));return isNaN(t)?0:t}throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","angle","Vector3")},get array(){return new Float32Array([this.x,this.y,this.z])},assign:function(e,t,r){if(null!==e&&void 0!==e)if(e instanceof glacier.Vector3)this.assign(e.x,e.y,e.z);else if(e instanceof glacier.Vector2)this.assign(e.x,e.y,"number"==typeof t?t:0);else if("number"==typeof e&&void 0===t)this.assign(e,e,e,e);else{var i=["x","y","z"];[e,t,r].forEach(function(e,t){if(isNaN(e))throw new glacier.exception.InvalidParameter(i[t],e,"number","assign","Vector3")}),this.x=e,this.y=t,this.z=r}return this},compare:function(e,t){if(e instanceof glacier.Vector3)return glacier.compare(this.x,e.x,t)&&glacier.compare(this.y,e.y,t)&&glacier.compare(this.z,e.z,t);throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","compare","Vector3")},get copy(){return new glacier.Vector3(this)},cross:function(e){if(e instanceof glacier.Vector3)return new glacier.Vector3(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x);throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","cross","Vector3")},distance:function(e){if(e instanceof glacier.Vector3){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+r*r+i*i)}throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","distance","Vector3")},divide:function(e){if(e instanceof glacier.Vector3)this.x/=e.x,this.y/=e.y,this.z/=e.z;else if("number"==typeof e)this.x/=e,this.y/=e,this.z/=e;else if(e instanceof glacier.Matrix33)this.assign(this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2),this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2),this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2));else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector3, Matrix33 or Matrix44","divide","Vector3");this.assign(this.x/e.element(0,0)+this.y/e.element(0,1)+this.z/e.element(0,2)+e.element(0,3),this.x/e.element(1,0)+this.y/e.element(1,1)+this.z/e.element(1,2)+e.element(1,3),this.x/e.element(2,0)+this.y/e.element(2,1)+this.z/e.element(2,2)+e.element(2,3))}return this},dot:function(e){if(e instanceof glacier.Vector3)return this.x*e.x+this.y*e.y+this.z*e.z;throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","dot","Vector3")},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},maximize:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("max",e,"Vector3","minimize","Vector3");return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},minimize:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("min",e,"Vector3","minimize","Vector3");return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},multiply:function(e){if(e instanceof glacier.Vector3)this.x*=e.x,this.y*=e.y,this.z*=e.z;else if("number"==typeof e)this.x*=e,this.y*=e,this.z*=e;else if(e instanceof glacier.Matrix33)this.assign(this.x*e.array[0]+this.y*e.array[3]+this.z*e.array[6],this.x*e.array[1]+this.y*e.array[4]+this.z*e.array[7],this.x*e.array[2]+this.y*e.array[5]+this.z*e.array[9]);else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector3, Matrix33 or Matrix44","multiply","Vector3");this.assign(this.x*e.array[0]+this.y*e.array[4]+this.z*e.array[8]+e.array[12],this.x*e.array[1]+this.y*e.array[5]+this.z*e.array[9]+e.array[13],this.x*e.array[2]+this.y*e.array[6]+this.z*e.array[10]+e.array[14])}return this},normalize:function(){var e=1/this.length;return this.x*=e,this.y*=e,this.z*=e,this},get normalized(){return this.copy.normalize()},rotateX:function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotateX","Vector3");var t=Math.cos(e),r=Math.sin(e),i=this.y*t-this.z*r,a=this.y*r+this.z*t;return this.y=i,this.z=a,this},rotateY:function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotateY","Vector3");var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.z*r,a=this.x*r+this.z*t;return this.x=i,this.z=a,this},rotateZ:function(e){if("number"!=typeof e)throw new glacier.exception.InvalidParameter("radians",e,"number","rotateZ","Vector3");var t=Math.cos(e),r=Math.sin(e),i=this.x*t-this.y*r,a=this.x*r+this.y*t;return this.x=i,this.y=a,this},subtract:function(e){if(e instanceof glacier.Vector3)this.x-=e.x,this.y-=e.y,this.z-=e.z;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector3","subtract","Vector3");this.x-=e,this.y-=e,this.z-=e}return this},swap:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("vec3",e,"Vector3","swap","Vector3");this.x=e.x+(e.x=this.x,0),this.y=e.y+(e.y=this.y,0),this.z=e.z+(e.z=this.z,0)},toString:function(){return"("+this.x+", "+this.y+", "+this.z+")"},get xy(){return new glacier.Vector2(this.x,this.y)},get xz(){return new glacier.Vector2(this.x,this.z)},get yz(){return new glacier.Vector2(this.y,this.z)}},glacier.Vector4=function Vector4(e,t,r,i){glacier.addTypedProperty(this,"x",0),glacier.addTypedProperty(this,"y",0),glacier.addTypedProperty(this,"z",0),glacier.addTypedProperty(this,"w",0),this.assign(e,t,r,i)},glacier.Vector4.prototype={add:function(e){if(e instanceof glacier.Vector4)this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector4","add","Vector4");this.x+=e,this.y+=e,this.z+=e,this.w+=e}return this},get array(){return new Float32Array([this.x,this.y,this.z,this.w])},assign:function(e,t,r,i){if(null!==e&&void 0!==e)if(e instanceof glacier.Vector4)this.assign(e.x,e.y,e.z,e.w);else if(e instanceof glacier.Vector3)this.assign(e.x,e.y,e.z,"number"==typeof t?t:1);else if(e instanceof glacier.Vector2)this.assign(e.x,e.y,"number"==typeof t?t:0,"number"==typeof r?r:1);else if("number"==typeof e&&void 0===t)this.assign(e,e,e,e);else{var a=["x","y","z","w"];[e,t,r,i].forEach(function(e,t){if(isNaN(e))throw new glacier.exception.InvalidParameter(a[t],e,"number","assign","Vector4")}),this.x=e,this.y=t,this.z=r,this.w=i}return this},compare:function(e,t){if(e instanceof glacier.Vector4)return glacier.compare(this.x,e.x,t)&&glacier.compare(this.y,e.y,t)&&glacier.compare(this.z,e.z,t)&&glacier.compare(this.w,e.w,t);throw new glacier.exception.InvalidParameter("vec4",e,"Vector4","compare","Vector4")},get copy(){return new glacier.Vector4(this)},divide:function(e){if(e instanceof glacier.Vector4)this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w;else if("number"==typeof e)this.x/=e,this.y/=e,this.z/=e,this.w/=e;else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector4 or Matrix44","divide","Vector4");this.assign(this.x/e.array[0]+this.y/e.array[4]+this.z/e.array[8]+this.w/e.array[12],this.x/e.array[1]+this.y/e.array[5]+this.z/e.array[9]+this.w/e.array[13],this.x/e.array[2]+this.y/e.array[6]+this.z/e.array[10]+this.w/e.array[14],this.x/e.array[3]+this.y/e.array[7]+this.z/e.array[11]+this.w/e.array[15])}return this},dot:function(e){if(e instanceof glacier.Vector4)return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w;throw new glacier.exception.InvalidParameter("vec4",e,"Vector4","dot","Vector4")},get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},maximize:function(e){if(!(e instanceof glacier.Vector4))throw new glacier.exception.InvalidParameter("max",e,"Vector4","minimize","Vector4");return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},minimize:function(e){if(!(e instanceof glacier.Vector4))throw new glacier.exception.InvalidParameter("min",e,"Vector4","minimize","Vector4");return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},multiply:function(e){if(e instanceof glacier.Vector4)this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w;else if("number"==typeof e)this.x*=e,this.y*=e,this.z*=e,this.w*=e;else{if(!(e instanceof glacier.Matrix44))throw new glacier.exception.InvalidParameter("value",e,"number, Vector4 or Matrix44","multiply","Vector4");this.assign(this.x*e.array[0]+this.y*e.array[4]+this.z*e.array[8]+this.w*e.array[12],this.x*e.array[1]+this.y*e.array[5]+this.z*e.array[9]+this.w*e.array[13],this.x*e.array[2]+this.y*e.array[6]+this.z*e.array[10]+this.w*e.array[14],this.x*e.array[3]+this.y*e.array[7]+this.z*e.array[11]+this.w*e.array[15])}return this},normalize:function(){var e=1/this.length;return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},get normalized(){return this.copy.normalize()},subtract:function(e){if(e instanceof glacier.Vector4)this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w;else{if("number"!=typeof e)throw new glacier.exception.InvalidParameter("value",e,"number or Vector4","subtract","Vector4");this.x-=e,this.y-=e,this.z-=e,this.w-=e}return this},swap:function(e){if(!(e instanceof glacier.Vector4))throw new glacier.exception.InvalidParameter("vec4",e,"Vector4","swap","Vector4");this.x=e.x+(e.x=this.x,0),this.y=e.y+(e.y=this.y,0),this.z=e.z+(e.z=this.z,0),this.w=e.w+(e.w=this.w,0)},toString:function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},get xy(){return new glacier.Vector2(this.x,this.y)},get xyz(){return new glacier.Vector3(this.x,this.y,this.z)},get xyw(){return new glacier.Vector3(this.x,this.y,this.w)},get xz(){return new glacier.Vector2(this.x,this.z)},get xzw(){return new glacier.Vector3(this.x,this.z,this.w)},get xw(){return new glacier.Vector2(this.x,this.w)},get yz(){return new glacier.Vector2(this.y,this.z)},get yzw(){return new glacier.Vector3(this.y,this.z,this.w)},get yw(){return new glacier.Vector2(this.y,this.w)},get zw(){return new glacier.Vector2(this.z,this.w)}},glacier.GlobeScene=function GlobeScene(e,t){glacier.Scene.call(this,e,t),t=glacier.parseOptions(t,{background:{Color:glacier.color.BLACK,"class":glacier.Color},latitudes:{number:45,gt:2},longitudes:{number:90,gt:2},radius:{number:1,gt:0},color:{Color:glacier.color.BLUE,"class":glacier.Color},rotationSpeed:{number:0},obliquity:{number:0},texture:[null,"string"],nightTexture:[null,"string"],normalMap:[null,"string"],mouseControl:{"boolean":!0}},"GlobeScene");var r=0;Object.defineProperties(this,{base:{get:function(){return this.layers[0]}},data:{value:{}},layers:{value:new glacier.TypedArray("Sphere",glacier.Sphere)},obliquity:{get:function(){return t.obliquity},set:function(e){"number"==typeof e&&(t.obliquity=e)}},rotation:{get:function(){return r},set:function(e){"number"==typeof e&&(r=e)}}}),this.layers.push(new glacier.Sphere(t.latitudes,t.longitudes,t.radius)),this.base.texture0=t.texture,this.base.texture1=t.nightTexture,this.base.texture2=t.normalMap,this.base.init(this.context,{shader:"globe"}),this.camera.clipNear=.01,this.camera.clipFar=100,this.camera.angle=new glacier.Vector2(90,0),this.camera.zoom=2,this.camera.follow(this.camera.target,this.camera.angle,this.camera.zoom),this.context.view=this.camera.matrix,this.context.projection=this.camera.projection,t.mouseControl&&this.bindMouse(),this.context.background=t.background,this.addRunCallback(function(){function drawData(e){e instanceof glacier.Drawable?(e.matrix.assign(this.base.matrix),e.draw()):"object"==typeof e&&e.drawables instanceof Array&&e.drawables.forEach(function(e){drawData.call(this,e)},this)}var e,t=this.context.gl;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CW),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.context.clear(),this.base.matrix.assignIdentity(),this.base.draw();for(e in this.data)drawData.call(this,this.data[e])})},glacier.extend(glacier.GlobeScene,glacier.Scene,{addData:function(e,t,r){function addDrawables(e,r){r instanceof glacier.geoJSON.Feature?addDrawables(e,r.geometry):r instanceof glacier.geoJSON.FeatureCollection?r.features.forEach(function(t){addDrawables(e,t)}):r instanceof glacier.geoJSON.MultiPoint?r.points.forEach(function(t){addDrawables(e,t)}):r instanceof glacier.geoJSON.Point&&(o.hasOwnProperty("points")||(o.points=e.push(new glacier.PointCollection)-1),e[o.points].addPoint(n.latLngToPoint(new glacier.Vector2(r.lng,r.lat),r.alt),t instanceof glacier.Color?t:glacier.color.WHITE))}var i,a,n=this,o={};if("string"==typeof e)glacier.load(e,function(e){n.addData(JSON.parse(e),t,r)});else{if("object"!=typeof e)throw new glacier.exception.InvalidParameter("geoJson",e,"geoJSON object or URL as string","addData","GlobeScene");(data=glacier.geoJSON.parse(e))&&(i=n.data[a=glacier.generateUID()]={geoJSON:data,drawables:[],hide:function(){this.drawables.forEach(function(e){e instanceof glacier.Drawable&&(e.visible=!1)})},show:function(){this.drawables.forEach(function(e){e instanceof glacier.Drawable&&(e.visible=!0)})}},addDrawables(i.drawables,data),i.drawables.forEach(function(e){e instanceof glacier.Drawable&&e.init(n.context)}),"function"==typeof r&&r(a,i))}},bindMouse:function(e){function easeIn(e,t,r,i){return(r-t)*Math.pow(2,10*(e/i-1))+t}function easeOut(e,t,r,i){return(r-t)*(-Math.pow(2,-10*e/i)+1)+t}var t,r,i,a=this;a.unbindMouse(),e=glacier.parseOptions(e,{zoomMin:{number:1.01,gt:0},zoomMax:{number:10,gt:0},zoomSteps:{number:30,gt:0}}),a.camera.zoom=e.zoomMax,a.mouseHandler={target:new glacier.Vector3(0,0,0),angleVelocity:null,zoomStep:e.zoomSteps,callbacks:{mousedown:function(e){0===e.button&&(a.mouseHandler.clickLatLng=a.screenToLatLng(e.clientX,e.clientY),a.mouseHandler.angleVelocity=null)},mouseup:function(e){0===e.button&&(a.mouseHandler.clickLatLng=null,a.mouseHandler.deltaLatLng&&(a.mouseHandler.angleVelocity={initial:a.mouseHandler.deltaLatLng.copy,current:new glacier.Vector2(0,0),dtime:0}))},mousemove:function(e){(i=a.screenToLatLng(e.clientX,e.clientY))?(a.context.canvas.style.cursor="move",a.mouseHandler.clickLatLng&&(a.mouseHandler.deltaLatLng=i.subtract(a.mouseHandler.clickLatLng),a.camera.angle.subtract(a.mouseHandler.deltaLatLng),t())):(a.context.canvas.style.cursor="default",a.mouseHandler.deltaLatLng=null)},touchend:function(e){a.mouseHandler.clickLatLng=null,a.mouseHandler.deltaLatLng&&(a.mouseHandler.angleVelocity={initial:a.mouseHandler.deltaLatLng.copy,current:new glacier.Vector2(0,0),dtime:0}),e.preventDefault()},touchmove:function(e){if(1==e.touches.length){{e.touches[0]}(i=a.screenToLatLng(e.clientX,e.clientY))?a.mouseHandler.clickLatLng&&(a.mouseHandler.deltaLatLng=i.subtract(a.mouseHandler.clickLatLng),a.camera.angle.subtract(a.mouseHandler.deltaLatLng),t()):a.mouseHandler.deltaLatLng=null}e.preventDefault()},touchstart:function(e){if(1==e.touches.length){{e.touches[0]}a.mouseHandler.clickLatLng=a.screenToLatLng(e.clientX,e.clientY),a.mouseHandler.angleVelocity=null}e.preventDefault()},wheel:function(r){r.deltaY&&(a.mouseHandler.zoomStep=glacier.clamp(a.mouseHandler.zoomStep+(r.deltaY>0?1:-1),-e.zoomSteps,e.zoomSteps),a.camera.zoom=easeIn(a.mouseHandler.zoomStep,e.zoomMin,e.zoomMax,e.zoomSteps),t())}},camEaseCallback:function(e){if(a.mouseHandler.angleVelocity){var r=a.mouseHandler.angleVelocity,i=r.initial.length;r.current.x=easeOut(r.dtime+=e,r.initial.x,0,i),r.current.y=easeOut(r.dtime+=e,r.initial.y,0,i),a.camera.angle.subtract(r.current),t(),glacier.compare(r.current.length,0)&&(a.mouseHandler.angleVelocity=null)}}},(t=function(){a.camera.angle.x=glacier.limitAngle(a.camera.angle.x,-180,180),a.camera.angle.y=glacier.clamp(a.camera.angle.y,-89.99,89.99),a.camera.follow(a.mouseHandler.target,a.camera.angle,a.camera.zoom)}).call();for(r in a.mouseHandler.callbacks)a.mouseHandler.callbacks.hasOwnProperty(r)&&"function"==typeof a.mouseHandler.callbacks[r]&&a.context.canvas.addEventListener(r,a.mouseHandler.callbacks[r]);a.addRunCallback(a.mouseHandler.camEaseCallback)},focus:function(e,t){function easeInOut(e,t,r,i){var a=((e/=i/2)<1?Math.pow(2,10*--e):-Math.pow(2,-10*--e)+2)||0;return new glacier.Vector2(r.x/2*a+t.x,r.y/2*a+t.y)}if(!(e instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("latLng",e,"Vector2","focus","GlobeScene");var r,i,a=this,n=0,o=a.camera.angle.copy,s=e.copy;s.lng+=90,a.mouseHandler&&(a.camera.angle.assign(s),a.mouseHandler.target.assign(a.camera.target)),i=o.distance(s),s.subtract(o),(r=function(){a.camera.follow(a.camera.target,a.camera.angle.assign(easeInOut(n,o,s,i)),a.camera.zoom),++n<i?requestAnimationFrame(r):"function"==typeof t&&t(e)}).call()},latLngToPoint:function(e,t){if(!(e instanceof glacier.Vector2))throw new glacier.exception.InvalidParameter("latLng",e,"Vector2","latLngToPoint","GlobeScene");if(void 0!==t&&"number"!=typeof t)throw new glacier.exception.InvalidParameter("alt",t,"number","latLngToPoint","GlobeScene");var r=glacier.degToRad(e.lat),i=glacier.degToRad(e.lng);return t=1+(t||0)*(1/6378137),new glacier.Vector3(t*this.base.radius*-Math.cos(r)*Math.cos(i),t*this.base.radius*Math.sin(r),t*this.base.radius*Math.cos(r)*Math.sin(i))},latLngToScreen:function(e,t){return this.context.worldToScreen(this.latLngToPoint(e,t).multiply(this.base.matrix))},pointToLatLng:function(e){if(!(e instanceof glacier.Vector3))throw new glacier.exception.InvalidParameter("point",e,"Vector3","worldToLatLng","GlobeScene");return new glacier.Vector2((270+glacier.radToDeg(Math.atan2(e.x,e.z)))%360-180,90-glacier.radToDeg(Math.acos(e.y/this.base.radius)))},rayCast:function(e,t){if(e instanceof glacier.Vector2)return this.rayCast(e.x,e.y);var r=["x","y"];[e,t].forEach(function(e,t){if(isNaN(e))throw new glacier.exception.InvalidParameter(r[t],e,"number","rayCast","GlobeScene")});var i,a,n=new glacier.Vector3(2*(e/this.context.width)-1,1-2*(t/this.context.height),1);return i=this.camera.position.copy,a=new glacier.Vector4(n).multiply(this.camera.projection.inverse).multiply(this.camera.matrix.inverse),new glacier.Ray(i,a.divide(a.w).xyz)},screenToLatLng:function(e,t){var r,i=this.rayCast(e,t);return(r=i.intersects(this.base))?(r.multiply(this.base.matrix.inverse),this.pointToLatLng(r)):null},unbindMouse:function(){var e,t=this;if(t.mouseHandler){for(e in t.mouseHandler.callbacks)t.mouseHandler.callbacks.hasOwnProperty(e)&&"function"==typeof t.mouseHandler.callbacks[e]&&(t.context.canvas.removeEventListener(e,t.mouseHandler.callbacks[e]),t.mouseHandler.callbacks[e]=null);t.removeRunCallback(t.mouseHandler.camEaseCallback)}t.mouseHandler=null,t.context.canvas.style.cursor="default"}}),glacier.Sphere=function Sphere(e,t,r){glacier.Mesh.call(this),r="number"==typeof r&&r>=0?r:0,Object.defineProperty(this,"radius",{get:function(){return r},set:function(e){"number"==typeof e&&e>=0?(e>0?this.vertices.forEach(function(t){t=t/r*e}):this.indices.length&&this.free(),r=e):glacier.error.invalidAssignment("radius",e,"positive number","Sphere")}}),e&&t&&this.generate(e,t,r||1)},glacier.extend(glacier.Sphere,glacier.Mesh,{free:function(){glacier.Mesh.prototype.free.call(this),this.radius=0},generate:function(e,t,r){if("number"!=typeof e||3>e)throw new glacier.exception.InvalidParameter("latitudes",e,"number (>= 3)","generate","Sphere");if(e=Math.round(Math.abs(e)),"number"!=typeof t||3>t)throw new glacier.exception.InvalidParameter("longitudes",t,"number (>= 3)","generate","Sphere");if(t=Math.round(Math.abs(t)),void 0===r)r=1;else if("number"!=typeof r||0>=r)throw new glacier.exception.InvalidParameter("radius",r,"number (> 0.0)","generate","Sphere");this.free(),this.radius=r;var i,a,n,o,s,c,l,h,u,f,g,y,d;for(i=0;e>=i;++i)for(n=i*Math.PI/e,o=Math.sin(n),s=Math.cos(n),a=0;t>=a;++a)c=2*a*Math.PI/t,l=Math.sin(c),h=Math.cos(c),u=h*o,f=s,g=l*o,y=1-a/t,d=i/e,this.vertices.push(new glacier.Vector3(r*u,r*f,r*g)),this.normals.push(new glacier.Vector3(u,f,g)),this.texCoords.push(new glacier.Vector2(y,d));for(i=0;e>i;++i)for(a=0;t>a;++a)u=i*(t+1)+a,f=u+t+1,this.indices.push(u,f,u+1),this.indices.push(f,f+1,u+1);return!0}});